# 🐛 둥지마켓 주요활동지역 업데이트 팝업 중복 오류 수정

## 📅 작성일: 2025년 8월

---

## 🔴 문제 상황

### 현상
1. 회원가입 후 주요활동지역이 저장되지 않은 회원이 "공구등록하기" 클릭
2. 주요활동지역 업데이트 팝업 표시
3. 수정 버튼 → 지역 입력 → 저장 버튼 클릭으로 완료
4. 다시 "공구등록하기" 클릭
5. **❌ 또다시 주요활동지역 업데이트 팝업이 표시됨** (오류)

### 문제점
- 주요활동지역 저장 후에도 즉시 반영되지 않음
- 사용자가 같은 작업을 반복해야 하는 불편함
- 공구 등록 프로세스 진행 방해

---

## 🔍 예상 원인 분석

### 1. 캐시/상태 업데이트 문제
```javascript
// 문제 있는 코드 예상
function saveLocation(location) {
  // DB에는 저장하지만
  api.updateLocation(location);
  
  // 로컬 상태나 세션은 업데이트 안함
  // userState.location은 여전히 null
}
```

### 2. 비동기 처리 문제
```javascript
// 문제 있는 코드
async function handleLocationSave(location) {
  await api.updateLocation(location); // DB 저장
  closePopup(); // 팝업 닫기
  // 상태 업데이트 전에 팝업을 닫아버림
}
```

### 3. 페이지 새로고침 없이 상태 확인
```javascript
// 공구등록 클릭 시
function checkLocationBeforeRegister() {
  // 페이지 로드 시점의 오래된 데이터 확인
  if (!initialUserData.location) {
    showLocationPopup(); // 계속 팝업 표시
  }
}
```

---

## ✅ 수정 방안

### 1. 주요활동지역 저장 로직 개선
```javascript
// 수정된 코드
async function saveLocation(location) {
  try {
    // 1. DB 저장
    const response = await api.updateLocation(location);
    
    // 2. 성공 시 로컬 상태 즉시 업데이트
    if (response.success) {
      // 세션 스토리지 업데이트
      sessionStorage.setItem('userLocation', location);
      
      // 전역 상태 업데이트
      userState.location = location;
      window.userLocation = location;
      
      // Vue/React 상태 업데이트
      this.$store.commit('updateUserLocation', location);
      // 또는
      setUserLocation(location);
    }
    
    return response.success;
  } catch (error) {
    console.error('Location update failed:', error);
    return false;
  }
}
```

### 2. 팝업 닫기 후 상태 확인
```javascript
// 주요활동지역 팝업 컴포넌트
async function handleSaveAndClose() {
  const location = getSelectedLocation();
  
  // 저장 처리
  const saved = await saveLocation(location);
  
  if (saved) {
    // 팝업 닫기
    closeLocationPopup();
    
    // 공구등록 가능 상태로 변경
    enableGroupBuyRegistration();
    
    // 자동으로 공구등록 페이지로 이동 (선택사항)
    if (this.redirectAfterSave) {
      this.$router.push('/group-buy/register');
    }
  } else {
    alert('저장에 실패했습니다. 다시 시도해주세요.');
  }
}
```

### 3. 공구등록 진입 시 실시간 체크
```javascript
// 공구등록하기 버튼 클릭 이벤트
async function handleGroupBuyRegisterClick() {
  // 캐시된 데이터가 아닌 최신 상태 확인
  const hasLocation = await checkCurrentUserLocation();
  
  if (!hasLocation) {
    // 팝업 표시하고 저장 후 자동 진입 설정
    showLocationPopup({
      redirectAfterSave: true,
      message: '공구 등록을 위해 주요활동지역을 설정해주세요.'
    });
  } else {
    // 바로 공구등록 페이지로 이동
    navigateToGroupBuyRegister();
  }
}

// 최신 상태 확인 함수
async function checkCurrentUserLocation() {
  // 1. 먼저 로컬 상태 확인
  if (userState.location || sessionStorage.getItem('userLocation')) {
    return true;
  }
  
  // 2. 필요시 서버에서 최신 정보 조회
  const userData = await api.getCurrentUser();
  return userData.location !== null;
}
```

### 4. 상태 동기화 보장
```javascript
// 전역 상태 관리 (Vuex/Redux)
const userModule = {
  state: {
    location: null,
  },
  
  mutations: {
    SET_USER_LOCATION(state, location) {
      state.location = location;
      // 동시에 세션 스토리지도 업데이트
      sessionStorage.setItem('userLocation', location);
    }
  },
  
  actions: {
    async updateLocation({ commit }, location) {
      const response = await api.updateLocation(location);
      if (response.success) {
        commit('SET_USER_LOCATION', location);
        return true;
      }
      return false;
    }
  }
};
```

---

## 🛠️ 구현 체크리스트

### Backend
- [ ] 주요활동지역 업데이트 API 응답에 성공 여부 명확히 포함
- [ ] 업데이트 후 최신 사용자 정보 반환
- [ ] 트랜잭션 처리로 데이터 일관성 보장

### Frontend
- [ ] 저장 성공 시 로컬 상태 즉시 업데이트
- [ ] 세션/로컬 스토리지 동기화
- [ ] 전역 상태 관리 시스템 업데이트
- [ ] 공구등록 클릭 시 실시간 상태 확인
- [ ] 팝업 닫은 후 자동 페이지 이동 옵션

### 추가 개선사항
- [ ] 로딩 인디케이터 추가
- [ ] 저장 실패 시 재시도 로직
- [ ] 네트워크 오류 처리

---

## 🧪 테스트 시나리오

### 시나리오 1: 정상 플로우
1. 주요활동지역 없는 신규 회원으로 로그인
2. 공구등록하기 클릭
3. 팝업에서 지역 선택 후 저장
4. 다시 공구등록하기 클릭
5. ✅ 팝업 없이 바로 공구등록 페이지 진입

### 시나리오 2: 저장 실패 처리
1. 네트워크 차단 상태에서 지역 저장 시도
2. 에러 메시지 표시 확인
3. 네트워크 복구 후 재시도
4. 정상 저장 및 진입 확인

### 시나리오 3: 새로고침 테스트
1. 주요활동지역 저장 직후 페이지 새로고침
2. 공구등록하기 클릭
3. 팝업 없이 진입되는지 확인

---

## 📝 예상 코드 수정 위치

```
/src/components/
  ├── LocationUpdatePopup.vue (또는 .jsx)
  ├── GroupBuyRegisterButton.vue
  └── UserProfile.vue

/src/store/
  ├── modules/user.js
  └── index.js

/src/api/
  └── user.js

/src/utils/
  └── storage.js
```

---

## ⚡ 빠른 임시 해결방안

즉시 수정이 어려운 경우:

```javascript
// 임시 해결책 - 팝업 저장 후 페이지 새로고침
async function handleLocationSave() {
  const saved = await saveLocation(location);
  if (saved) {
    // 강제 새로고침으로 상태 동기화
    window.location.reload();
  }
}
```

⚠️ 단, 이 방법은 UX가 좋지 않으므로 근본적인 수정 권장

---

*수정 요청자: [담당자명]*
*검토자: [개발팀]*