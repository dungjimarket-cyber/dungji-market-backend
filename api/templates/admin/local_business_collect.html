{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}ì§€ì—­ ì—…ì²´ ì •ë³´ ìˆ˜ì§‘{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">í™ˆ</a>
    &rsaquo; <a href="{% url 'admin:api_localbusiness_changelist' %}">ì§€ì—­ ì—…ì²´</a>
    &rsaquo; ë°ì´í„° ìˆ˜ì§‘
</div>
{% endblock %}

{% block content %}
<div style="max-width: 800px; margin: 20px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
    <h1 style="margin-bottom: 20px;">ğŸ—ºï¸ ì§€ì—­ ì—…ì²´ ì •ë³´ ìˆ˜ì§‘</h1>

    <div style="background: #fff3cd; border: 1px solid #ffc107; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
        <strong>âš ï¸ ì£¼ì˜ì‚¬í•­</strong>
        <ul style="margin: 10px 0 0 20px;">
            <li>Google Places APIë¥¼ ì‚¬ìš©í•˜ì—¬ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•©ë‹ˆë‹¤.</li>
            <li>API í˜¸ì¶œë§ˆë‹¤ ë¹„ìš©ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
            <li>ì´ë¯¸ ìˆ˜ì§‘ëœ ì—…ì²´ëŠ” ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.</li>
            <li>í•œ ì§€ì—­ë‹¹ ì•½ 1-2ì´ˆ ì†Œìš”ë©ë‹ˆë‹¤.</li>
        </ul>
    </div>

    <form method="post" style="margin-top: 20px;">
        {% csrf_token %}

        <div style="margin-bottom: 20px;">
            <label for="region" style="display: block; margin-bottom: 5px; font-weight: bold;">ì§€ì—­ ì„ íƒ (ì„ íƒì‚¬í•­)</label>
            <select name="region" id="region" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="">-- ì „ì²´ ì§€ì—­ (ì„œìš¸ 5êµ¬ + ìˆ˜ë„ê¶Œ 5ì‹œ) --</option>
                {% for region in regions %}
                <option value="{{ region.name }}">{{ region.name }}</option>
                {% endfor %}
            </select>
            <p style="color: #666; font-size: 12px; margin-top: 5px;">
                ë¹„ì–´ìˆìœ¼ë©´ ì„œìš¸ 5ê°œêµ¬ + ìˆ˜ë„ê¶Œ 5ê°œì‹œ ì „ì²´ ìˆ˜ì§‘
            </p>
        </div>

        <div style="margin-bottom: 20px;">
            <label for="category" style="display: block; margin-bottom: 5px; font-weight: bold;">ì—…ì¢… ì„ íƒ (ì„ íƒì‚¬í•­)</label>
            <select name="category" id="category" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="">-- ì „ì²´ ì—…ì¢… (7ê°œ) --</option>
                {% for cat in categories %}
                <option value="{{ cat.name }}">{{ cat.icon }} {{ cat.name }}</option>
                {% endfor %}
            </select>
            <p style="color: #666; font-size: 12px; margin-top: 5px;">
                ë¹„ì–´ìˆìœ¼ë©´ ì„¸ë¬´ì‚¬, ë³€í˜¸ì‚¬, ë²•ë¬´ì‚¬, ê³µì¸ì¤‘ê°œì‚¬, ì¸í…Œë¦¬ì–´, íœ´ëŒ€í°, ì •ë¹„ì†Œ ì „ì²´ ìˆ˜ì§‘
            </p>
        </div>

        <div style="margin-bottom: 20px;">
            <label for="limit" style="display: block; margin-bottom: 5px; font-weight: bold;">ì§€ì—­ë‹¹ ìµœëŒ€ ì—…ì²´ ìˆ˜</label>
            <input type="number" name="limit" id="limit" value="5" min="1" max="20"
                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            <p style="color: #666; font-size: 12px; margin-top: 5px;">
                ê° ì§€ì—­+ì—…ì¢… ì¡°í•©ë‹¹ ìˆ˜ì§‘í•  ìµœëŒ€ ì—…ì²´ ìˆ˜ (ê¸°ë³¸: 5ê°œ, ìµœëŒ€: 20ê°œ)
            </p>
        </div>

        <div style="background: #e7f3ff; border: 1px solid #2196F3; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
            <strong>ğŸ“Š ì˜ˆìƒ ìˆ˜ì§‘ëŸ‰</strong>
            <ul style="margin: 10px 0 0 20px;">
                <li><strong>1ê°œ ì§€ì—­ + ì „ì²´ ì—…ì¢…:</strong> ì•½ 35ê°œ ì—…ì²´ (7ê°œ ì—…ì¢… Ã— 5ê°œ)</li>
                <li><strong>ì „ì²´ ì§€ì—­ + 1ê°œ ì—…ì¢…:</strong> ì•½ 50ê°œ ì—…ì²´ (10ê°œ ì§€ì—­ Ã— 5ê°œ)</li>
                <li><strong>ì „ì²´ ì§€ì—­ + ì „ì²´ ì—…ì¢…:</strong> ì•½ 350ê°œ ì—…ì²´ (10ê°œ ì§€ì—­ Ã— 7ê°œ ì—…ì¢… Ã— 5ê°œ)</li>
            </ul>
        </div>

        <div style="display: flex; gap: 10px;">
            <button type="submit" id="collectBtn"
                    style="flex: 1; padding: 12px 24px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: bold;">
                ğŸš€ ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘
            </button>
            <a href="{% url 'admin:api_localbusiness_changelist' %}"
               style="flex: 1; padding: 12px 24px; background: #ddd; color: #333; text-align: center; text-decoration: none; border-radius: 4px; font-size: 16px;">
                ì·¨ì†Œ
            </a>
        </div>
    </form>

    <!-- ì§„í–‰ ìƒí™© í‘œì‹œ ì˜ì—­ -->
    <div id="progressContainer" style="display: none; margin-top: 30px; padding: 20px; background: #f5f5f5; border-radius: 8px;">
        <h3 style="margin-bottom: 15px;">ğŸ“Š ìˆ˜ì§‘ ì§„í–‰ ìƒí™©</h3>

        <div style="background: white; padding: 15px; border-radius: 4px; margin-bottom: 15px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span><strong>ì§„í–‰ë¥ :</strong></span>
                <span id="progressPercent">0%</span>
            </div>
            <div style="width: 100%; height: 30px; background: #e0e0e0; border-radius: 15px; overflow: hidden;">
                <div id="progressBar" style="height: 100%; width: 0%; background: linear-gradient(90deg, #4CAF50, #8BC34A); transition: width 0.3s;"></div>
            </div>
        </div>

        <div style="background: white; padding: 15px; border-radius: 4px; margin-bottom: 15px;">
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center;">
                <div>
                    <div style="font-size: 24px; font-weight: bold; color: #2196F3;" id="totalCount">0</div>
                    <div style="color: #666; font-size: 12px;">ì´ ì˜ˆìƒ</div>
                </div>
                <div>
                    <div style="font-size: 24px; font-weight: bold; color: #4CAF50;" id="successCount">0</div>
                    <div style="color: #666; font-size: 12px;">ì„±ê³µ</div>
                </div>
                <div>
                    <div style="font-size: 24px; font-weight: bold; color: #f44336;" id="failCount">0</div>
                    <div style="color: #666; font-size: 12px;">ì‹¤íŒ¨</div>
                </div>
            </div>
        </div>

        <div style="background: white; padding: 15px; border-radius: 4px; max-height: 300px; overflow-y: auto;">
            <h4 style="margin-bottom: 10px;">ì‹¤ì‹œê°„ ë¡œê·¸</h4>
            <div id="logContainer" style="font-family: monospace; font-size: 12px; line-height: 1.6;">
                <div style="color: #2196F3;">ğŸ”„ ìˆ˜ì§‘ ì‹œì‘ ì¤€ë¹„ ì¤‘...</div>
            </div>
        </div>

        <div id="completeSection" style="display: none; margin-top: 15px; padding: 15px; background: #4CAF50; color: white; border-radius: 4px; text-align: center;">
            <strong>âœ… ìˆ˜ì§‘ ì™„ë£Œ!</strong>
            <div style="margin-top: 10px;">
                <a href="{% url 'admin:api_localbusiness_changelist' %}"
                   style="color: white; text-decoration: underline;">
                    ìˆ˜ì§‘ëœ ì—…ì²´ ëª©ë¡ ë³´ê¸° â†’
                </a>
            </div>
        </div>
    </div>

    <script>
    document.querySelector('form').addEventListener('submit', function(e) {
        e.preventDefault();

        const form = e.target;
        const formData = new FormData(form);
        const progressContainer = document.getElementById('progressContainer');
        const logContainer = document.getElementById('logContainer');
        const collectBtn = document.getElementById('collectBtn');

        // UI ì´ˆê¸°í™”
        progressContainer.style.display = 'block';
        collectBtn.disabled = true;
        collectBtn.style.background = '#999';
        collectBtn.textContent = 'â³ ìˆ˜ì§‘ ì¤‘...';
        logContainer.innerHTML = '<div style="color: #2196F3;">ğŸ”„ ìˆ˜ì§‘ ì‹œì‘...</div>';

        // AJAX ìš”ì²­
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'started') {
                // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì‹œì‘
                pollProgress(data.task_id);
            } else if (data.logs) {
                // ë™ê¸° ì‹¤í–‰ ê²°ê³¼
                displayLogs(data.logs);
                showComplete(data);
            }
        })
        .catch(error => {
            logContainer.innerHTML += '<div style="color: #f44336;">âŒ ì˜¤ë¥˜ ë°œìƒ: ' + error + '</div>';
            collectBtn.disabled = false;
            collectBtn.style.background = '#2196F3';
            collectBtn.textContent = 'ğŸš€ ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘';
        });
    });

    function displayLogs(logs) {
        const logContainer = document.getElementById('logContainer');
        logContainer.innerHTML = '';

        logs.forEach(log => {
            const color = log.includes('âœ…') ? '#4CAF50' :
                         log.includes('âŒ') ? '#f44336' :
                         log.includes('ğŸ“') ? '#2196F3' : '#666';
            logContainer.innerHTML += `<div style="color: ${color};">${log}</div>`;
        });

        logContainer.scrollTop = logContainer.scrollHeight;
    }

    function showComplete(data) {
        document.getElementById('progressBar').style.width = '100%';
        document.getElementById('progressPercent').textContent = '100%';
        document.getElementById('successCount').textContent = data.success || 0;
        document.getElementById('failCount').textContent = data.fail || 0;
        document.getElementById('totalCount').textContent = data.total || 0;
        document.getElementById('completeSection').style.display = 'block';

        const collectBtn = document.getElementById('collectBtn');
        collectBtn.disabled = false;
        collectBtn.style.background = '#2196F3';
        collectBtn.textContent = 'ğŸš€ ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘';
    }
    </script>

    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd;">
        <h3 style="margin-bottom: 10px;">ğŸ’¡ ì‚¬ìš© íŒ</h3>
        <ul style="margin-left: 20px; color: #666;">
            <li><strong>ì²˜ìŒ ì‚¬ìš©:</strong> "ê°•ë‚¨êµ¬" 1ê°œ ì§€ì—­ë§Œ ì„ íƒí•´ì„œ í…ŒìŠ¤íŠ¸í•´ë³´ì„¸ìš”</li>
            <li><strong>ë¹ ë¥¸ ìˆ˜ì§‘:</strong> íŠ¹ì • ì§€ì—­ + íŠ¹ì • ì—…ì¢…ì„ ì„ íƒí•˜ë©´ ë¹ ë¦…ë‹ˆë‹¤</li>
            <li><strong>ì „ì²´ ìˆ˜ì§‘:</strong> ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦½ë‹ˆë‹¤ (ì•½ 5-10ë¶„)</li>
            <li><strong>ì—…ë°ì´íŠ¸:</strong> ê°™ì€ ì„¤ì •ìœ¼ë¡œ ë‹¤ì‹œ ì‹¤í–‰í•˜ë©´ ê¸°ì¡´ ë°ì´í„°ê°€ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤</li>
        </ul>
    </div>
</div>
{% endblock %}
