{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}ì§€ì—­ ì—…ì²´ ì •ë³´ ìˆ˜ì§‘ (Google API){% endblock %}

{% block extrahead %}
<!-- Google Maps API ë¶ˆí•„ìš” - Fetch APIë¡œ ì§ì ‘ í˜¸ì¶œ -->
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">í™ˆ</a>
    &rsaquo; <a href="{% url 'admin:api_localbusiness_changelist' %}">ì§€ì—­ ì—…ì²´</a>
    &rsaquo; ë°ì´í„° ìˆ˜ì§‘ (Google API)
</div>
{% endblock %}

{% block content %}
<div style="max-width: 800px; margin: 20px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
    <h1 style="margin-bottom: 20px;">ğŸ—ºï¸ ì§€ì—­ ì—…ì²´ ì •ë³´ ìˆ˜ì§‘ (Google Places API)</h1>

    <div style="background: #e7f3ff; border: 1px solid #2196F3; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
        <strong>â„¹ï¸ ì•ˆë‚´</strong>
        <ul style="margin: 10px 0 0 20px;">
            <li>ë¸Œë¼ìš°ì €ì—ì„œ ì§ì ‘ Google Places APIë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤</li>
            <li>í”„ë¡ íŠ¸ì—”ë“œ í™˜ê²½ë³€ìˆ˜ì— ì„¤ì •ëœ API í‚¤ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤</li>
            <li>ë­í‚¹ í˜ì´ì§€ì™€ ë™ì¼í•œ ë°©ì‹ì…ë‹ˆë‹¤</li>
        </ul>
    </div>

    <form id="collectForm" style="margin-top: 20px;">
        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 10px; font-weight: bold;">ì§€ì—­ ì„ íƒ (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥)</label>

            <!-- ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤ -->
            <div style="margin-bottom: 15px; padding: 10px; background: #e3f2fd; border-radius: 4px;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="selectAllRegions" style="margin-right: 8px; width: 16px; height: 16px; cursor: pointer;">
                    <span style="font-weight: bold;">ğŸ™ï¸ ìˆ˜ë„ê¶Œ ì „ì²´ ì„ íƒ (ì„œìš¸ + ê²½ê¸°)</span>
                </label>
            </div>

            <!-- ì‹œ/ë„ë³„ ê·¸ë£¹ -->
            <div style="border: 1px solid #ddd; border-radius: 4px; padding: 15px; max-height: 300px; overflow-y: auto;">
                <!-- ì„œìš¸ -->
                <div style="margin-bottom: 20px;">
                    <label style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer; font-weight: bold; color: #1976d2;">
                        <input type="checkbox" class="province-select" data-province="ì„œìš¸" style="margin-right: 8px; width: 16px; height: 16px; cursor: pointer;">
                        <span>ì„œìš¸ ì „ì²´</span>
                    </label>
                    <div style="margin-left: 24px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" name="regions" value="ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬" class="region-checkbox seoul" style="margin-right: 6px; cursor: pointer;">
                            <span style="font-size: 14px;">ê°•ë‚¨êµ¬</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" name="regions" value="ì„œìš¸íŠ¹ë³„ì‹œ ì„œì´ˆêµ¬" class="region-checkbox seoul" style="margin-right: 6px; cursor: pointer;">
                            <span style="font-size: 14px;">ì„œì´ˆêµ¬</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" name="regions" value="ì„œìš¸íŠ¹ë³„ì‹œ ì†¡íŒŒêµ¬" class="region-checkbox seoul" style="margin-right: 6px; cursor: pointer;">
                            <span style="font-size: 14px;">ì†¡íŒŒêµ¬</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" name="regions" value="ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë™êµ¬" class="region-checkbox seoul" style="margin-right: 6px; cursor: pointer;">
                            <span style="font-size: 14px;">ê°•ë™êµ¬</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" name="regions" value="ì„œìš¸íŠ¹ë³„ì‹œ ë§ˆí¬êµ¬" class="region-checkbox seoul" style="margin-right: 6px; cursor: pointer;">
                            <span style="font-size: 14px;">ë§ˆí¬êµ¬</span>
                        </label>
                    </div>
                </div>

                <!-- ê²½ê¸° -->
                <div>
                    <label style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer; font-weight: bold; color: #1976d2;">
                        <input type="checkbox" class="province-select" data-province="ê²½ê¸°" style="margin-right: 8px; width: 16px; height: 16px; cursor: pointer;">
                        <span>ê²½ê¸° ì „ì²´</span>
                    </label>
                    <div style="margin-left: 24px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" name="regions" value="ê²½ê¸°ë„ ì„±ë‚¨ì‹œ" class="region-checkbox ê²½ê¸°" style="margin-right: 6px; cursor: pointer;">
                            <span style="font-size: 14px;">ì„±ë‚¨ì‹œ</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" name="regions" value="ê²½ê¸°ë„ ìˆ˜ì›ì‹œ" class="region-checkbox ê²½ê¸°" style="margin-right: 6px; cursor: pointer;">
                            <span style="font-size: 14px;">ìˆ˜ì›ì‹œ</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" name="regions" value="ê²½ê¸°ë„ ê³ ì–‘ì‹œ" class="region-checkbox ê²½ê¸°" style="margin-right: 6px; cursor: pointer;">
                            <span style="font-size: 14px;">ê³ ì–‘ì‹œ</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" name="regions" value="ê²½ê¸°ë„ ìš©ì¸ì‹œ" class="region-checkbox ê²½ê¸°" style="margin-right: 6px; cursor: pointer;">
                            <span style="font-size: 14px;">ìš©ì¸ì‹œ</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" name="regions" value="ê²½ê¸°ë„ í™”ì„±ì‹œ" class="region-checkbox ê²½ê¸°" style="margin-right: 6px; cursor: pointer;">
                            <span style="font-size: 14px;">í™”ì„±ì‹œ</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <div style="margin-bottom: 20px;">
            <label for="category" style="display: block; margin-bottom: 5px; font-weight: bold;">ì—…ì¢… ì„ íƒ</label>
            <select name="category" id="category" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" required>
                <option value="">-- ì—…ì¢… ì„ íƒ --</option>
                <option value="ALL" data-name-en="ALL" style="font-weight: bold; background: #e3f2fd;">ğŸ“‹ ì „ì²´ ì—…ì¢… ({{ categories|length }}ê°œ)</option>
                {% for cat in categories %}
                <option value="{{ cat.id }}" data-name-en="{{ cat.name_en }}">{{ cat.icon }} {{ cat.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div style="margin-bottom: 20px;">
            <label for="limit" style="display: block; margin-bottom: 5px; font-weight: bold;">ìˆ˜ì§‘ ê°œìˆ˜</label>
            <input type="number" name="limit" id="limit" value="5" min="1" max="20"
                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        </div>

        <button type="submit" id="collectBtn"
                style="width: 100%; padding: 12px 24px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: bold;">
            ğŸš€ ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘
        </button>
    </form>

    <div id="progressContainer" style="display: none; margin-top: 30px; padding: 20px; background: #f5f5f5; border-radius: 8px;">
        <h3 style="margin-bottom: 15px;">ğŸ“Š ìˆ˜ì§‘ ì§„í–‰ ìƒí™©</h3>

        <div style="background: white; padding: 15px; border-radius: 4px; margin-bottom: 15px;">
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center;">
                <div>
                    <div style="font-size: 24px; font-weight: bold; color: #4CAF50;" id="successCount">0</div>
                    <div style="color: #666; font-size: 12px;">ì„±ê³µ</div>
                </div>
                <div>
                    <div style="font-size: 24px; font-weight: bold; color: #f44336;" id="failCount">0</div>
                    <div style="color: #666; font-size: 12px;">ì‹¤íŒ¨</div>
                </div>
                <div>
                    <div style="font-size: 24px; font-weight: bold; color: #2196F3;" id="totalCount">0</div>
                    <div style="color: #666; font-size: 12px;">ì´</div>
                </div>
            </div>
        </div>

        <div style="background: white; padding: 15px; border-radius: 4px; max-height: 300px; overflow-y: auto;">
            <h4 style="margin-bottom: 10px;">ì‹¤ì‹œê°„ ë¡œê·¸</h4>
            <div id="logContainer" style="font-family: monospace; font-size: 12px; line-height: 1.6;"></div>
        </div>
    </div>
</div>

<script>
const REGION_COORDINATES = {
    'ê°•ë‚¨êµ¬': {latitude: 37.5172, longitude: 127.0473},
    'ì„œì´ˆêµ¬': {latitude: 37.4837, longitude: 127.0324},
    'ì†¡íŒŒêµ¬': {latitude: 37.5145, longitude: 127.1059},
    'ê°•ë™êµ¬': {latitude: 37.5301, longitude: 127.1238},
    'ë§ˆí¬êµ¬': {latitude: 37.5663, longitude: 126.9019},
    'ì„±ë‚¨ì‹œ': {latitude: 37.4201, longitude: 127.1262},
    'ìˆ˜ì›ì‹œ': {latitude: 37.2636, longitude: 127.0286},
    'ê³ ì–‘ì‹œ': {latitude: 37.6584, longitude: 126.8320},
    'ìš©ì¸ì‹œ': {latitude: 37.2410, longitude: 127.1776},
    'í™”ì„±ì‹œ': {latitude: 37.1990, longitude: 126.8312}
};

// ì „ì²´ ì§€ì—­ ëª©ë¡
const ALL_REGIONS = [
    'ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬', 'ì„œìš¸íŠ¹ë³„ì‹œ ì„œì´ˆêµ¬', 'ì„œìš¸íŠ¹ë³„ì‹œ ì†¡íŒŒêµ¬',
    'ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë™êµ¬', 'ì„œìš¸íŠ¹ë³„ì‹œ ë§ˆí¬êµ¬',
    'ê²½ê¸°ë„ ì„±ë‚¨ì‹œ', 'ê²½ê¸°ë„ ìˆ˜ì›ì‹œ', 'ê²½ê¸°ë„ ê³ ì–‘ì‹œ',
    'ê²½ê¸°ë„ ìš©ì¸ì‹œ', 'ê²½ê¸°ë„ í™”ì„±ì‹œ'
];

// ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸ ì²˜ë¦¬
document.getElementById('selectAllRegions').addEventListener('change', function(e) {
    const checkboxes = document.querySelectorAll('.region-checkbox');
    checkboxes.forEach(cb => cb.checked = e.target.checked);
});

// ì‹œ/ë„ ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤
document.querySelectorAll('.province-select').forEach(provinceCheckbox => {
    provinceCheckbox.addEventListener('change', function(e) {
        const province = e.target.dataset.province;
        const checkboxes = document.querySelectorAll(`.region-checkbox.${province}`);
        checkboxes.forEach(cb => cb.checked = e.target.checked);
    });
});

document.getElementById('collectForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    // ì„ íƒëœ ì§€ì—­ ìˆ˜ì§‘
    const selectedRegions = Array.from(document.querySelectorAll('input[name="regions"]:checked'))
        .map(cb => cb.value);

    if (selectedRegions.length === 0) {
        alert('ìµœì†Œ 1ê°œ ì´ìƒì˜ ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }

    const categorySelect = document.getElementById('category');
    const categoryId = categorySelect.value;
    const categoryNameEn = categorySelect.options[categorySelect.selectedIndex].dataset.nameEn;
    const limit = parseInt(document.getElementById('limit').value);

    document.getElementById('progressContainer').style.display = 'block';
    document.getElementById('collectBtn').disabled = true;
    document.getElementById('collectBtn').textContent = 'â³ ìˆ˜ì§‘ ì¤‘...';

    // ì„ íƒëœ ì§€ì—­ ì‚¬ìš©
    const regions = selectedRegions;

    // ì¹´í…Œê³ ë¦¬ ëª©ë¡ ê²°ì •
    const categories = categoryId === 'ALL'
        ? Array.from(document.querySelectorAll('#category option[data-name-en]'))
            .filter(opt => opt.value !== 'ALL')
            .map(opt => ({id: opt.value, nameEn: opt.dataset.nameEn}))
        : [{id: categoryId, nameEn: categoryNameEn}];

    addLog(`ğŸ“ ì§€ì—­: ${regions.length}ê³³, ì—…ì¢…: ${categories.length}ê°œ, ì§€ì—­ë‹¹ ${limit}ê°œì”© ìˆ˜ì§‘`);

    try {
        for (const targetRegion of regions) {
            for (const cat of categories) {
                const regionShort = targetRegion.split(' ').pop();
                const coordinates = REGION_COORDINATES[regionShort];

                addLog(`ğŸ” ${targetRegion} - ${cat.nameEn} ê²€ìƒ‰ ì¤‘...`);

                // Google Places API í˜¸ì¶œ
                const places = await fetchGooglePlaces(regionShort, cat.nameEn, coordinates, limit);

                addLog(`âœ… ${places.length}ê°œ ì—…ì²´ ë°œê²¬ (í•„í„°ë§ í›„)`);

                if (places.length === 0) {
                    addLog(`âš ï¸ ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ`, 'error');
                    continue;
                }

                // ê¸°ì¡´ ì—…ì²´ì˜ ìš”ì•½ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (30ì¼ ìºì‹± í™•ì¸ìš©)
                const placeIds = places.map(p => p.place_id);
                const existingBusinesses = await fetch('/api/local-businesses/?' + new URLSearchParams({
                    google_place_id__in: placeIds.join(',')
                })).then(r => r.json()).catch(() => ({results: []}));

                const existingSummaryMap = {};
                if (existingBusinesses.results) {
                    existingBusinesses.results.forEach(b => {
                        existingSummaryMap[b.google_place_id] = b.editorial_summary;
                    });
                }

                // AI ìš”ì•½ ìƒì„± (ë°°ì¹˜ ì²˜ë¦¬, ê¸°ì¡´ ìš”ì•½ ì¬ì‚¬ìš©)
                addLog(`ğŸ¤– AI ìš”ì•½ í™•ì¸/ìƒì„± ì‹œì‘... (${places.length}ê°œ ì—…ì²´)`);
                const BATCH_SIZE = 5; // 5ê°œì”© ë³‘ë ¬ ì²˜ë¦¬ (OpenAI Rate Limit ì¶©ë¶„)

                for (let i = 0; i < places.length; i += BATCH_SIZE) {
                    const batch = places.slice(i, i + BATCH_SIZE);

                    addLog(`â³ ë°°ì¹˜ ${Math.floor(i/BATCH_SIZE) + 1} ì²˜ë¦¬ ì¤‘... (${batch.length}ê°œ)`);

                    await Promise.all(
                        batch.map(async (place) => {
                            const existingSummary = existingSummaryMap[place.place_id];
                            const aiSummary = await generateAISummary(place, existingSummary);
                            if (aiSummary) {
                                place.editorial_summary = aiSummary;
                            }
                        })
                    );
                }

                // ë°±ì—”ë“œë¡œ ì €ì¥ - í•„í„°ë§ í›„ ìˆœìœ„ë¥¼ ë‹¤ì‹œ ë§¤ê¹€
                const businesses = places.map((place, index) => ({
                    google_place_id: place.place_id,
                    category_id: parseInt(cat.id),
                    region_name: targetRegion,
                    name: place.name,
                    address: place.formatted_address || place.vicinity,
                    phone_number: place.formatted_phone_number,
                    latitude: place.geometry.location.lat(),
                    longitude: place.geometry.location.lng(),
                    rating: place.rating,
                    review_count: place.user_ratings_total || 0,
                    google_maps_url: `https://www.google.com/maps/place/?q=place_id:${place.place_id}`,
                    photo_url: place.photos && place.photos[0] ? place.photos[0].getUrl({maxWidth: 400}) : null,
                    website_url: place.website,
                    opening_hours: place.opening_hours,
                    editorial_summary: place.editorial_summary, // AI ìƒì„± ë˜ëŠ” Google ìš”ì•½ ë˜ëŠ” ê¸°ì¡´ ìš”ì•½ ì¬ì‚¬ìš©
                    business_status: place.business_status,
                    last_review_time: place.last_review_time,
                    popularity_score: calculatePopularityScore(place.rating || 0, place.user_ratings_total || 0),
                    rank_in_region: index + 1  // í•„í„°ë§ í›„ì˜ ìˆœìœ„
                }));

                addLog('ğŸ’¾ ë°±ì—”ë“œì— ì €ì¥ ì¤‘...');

                const response = await fetch('/api/local-businesses/bulk_create/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({businesses})
                });

                const result = await response.json();

                document.getElementById('successCount').textContent =
                    parseInt(document.getElementById('successCount').textContent || 0) + result.created + result.updated;
                document.getElementById('failCount').textContent =
                    parseInt(document.getElementById('failCount').textContent || 0) + result.errors.length;
                document.getElementById('totalCount').textContent =
                    parseInt(document.getElementById('totalCount').textContent || 0) + result.total;

                addLog(`âœ… ì €ì¥ ì™„ë£Œ! ìƒì„±: ${result.created}ê°œ, ì—…ë°ì´íŠ¸: ${result.updated}ê°œ, ìŠ¤í‚µ: ${result.skipped}ê°œ`);

                if (result.errors.length > 0) {
                    result.errors.forEach(err => addLog(`âŒ ${err}`, 'error'));
                }

                // API ê³¼ë¶€í•˜ ë°©ì§€: 0.5ì´ˆ ëŒ€ê¸°
                await new Promise(resolve => setTimeout(resolve, 500));
            }
        }

        addLog(`ğŸ‰ ì „ì²´ ìˆ˜ì§‘ ì™„ë£Œ!`)

    } catch (error) {
        addLog(`âŒ ì˜¤ë¥˜: ${error.message}`, 'error');
    } finally {
        document.getElementById('collectBtn').disabled = false;
        document.getElementById('collectBtn').textContent = 'ğŸš€ ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘';
    }
});

async function fetchGooglePlaces(city, category, coordinates, maxResults) {
    const apiKey = '{{ google_api_key|escapejs }}';

    // API í‚¤ ë””ë²„ê¹…
    console.log('API Key exists:', !!apiKey);
    console.log('API Key length:', apiKey.length);
    console.log('API Key prefix:', apiKey.substring(0, 20));

    if (!apiKey || apiKey === '') {
        throw new Error('API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
    }

    const apiUrl = 'https://places.googleapis.com/v1/places:searchText';

    const requestBody = {
        textQuery: `${city} ${category}`,
        languageCode: 'ko',
        locationBias: {
            circle: {
                center: {
                    latitude: coordinates.latitude,
                    longitude: coordinates.longitude
                },
                radius: 5000.0
            }
        },
        minRating: 4.0,
        maxResultCount: maxResults
    };

    const headers = {
        'Content-Type': 'application/json',
        'X-Goog-Api-Key': apiKey,
        'X-Goog-FieldMask': 'places.id,places.displayName,places.formattedAddress,places.rating,places.userRatingCount,places.location,places.internationalPhoneNumber,places.photos,places.websiteUri,places.regularOpeningHours,places.editorialSummary,places.businessStatus,places.reviews'
    };

    const response = await fetch(apiUrl, {
        method: 'POST',
        headers: headers,
        body: JSON.stringify(requestBody)
    });

    if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`Google API ì˜¤ë¥˜: ${response.status} - ${errorText}`);
    }

    const data = await response.json();

    if (!data.places || data.places.length === 0) {
        return [];
    }

    // í•„í„°ë§: íì—… ì—…ì²´ ë° 2ë…„ ì´ìƒ ë¦¬ë·° ì—†ëŠ” ì—…ì²´ ì œì™¸
    const TWO_YEARS_MS = 2 * 365 * 24 * 60 * 60 * 1000;
    const filteredPlaces = data.places.filter(place => {
        // íì—…í•œ ê³³ ì œì™¸
        if (place.businessStatus === 'CLOSED_PERMANENTLY') {
            addLog(`âš ï¸ ${place.displayName.text}: íì—… (ì œì™¸)`, 'error');
            return false;
        }

        // ë¦¬ë·°ê°€ ìˆê³ , ìµœì‹  ë¦¬ë·°ê°€ 2ë…„ ì´ìƒ ì§€ë‚¬ìœ¼ë©´ ì œì™¸
        if (place.reviews && place.reviews.length > 0) {
            const latestReview = place.reviews[0];
            const reviewDate = new Date(latestReview.publishTime);
            const daysSinceReview = (Date.now() - reviewDate) / (1000 * 60 * 60 * 24);

            if (daysSinceReview > 730) {
                addLog(`âš ï¸ ${place.displayName.text}: ìµœê·¼ ë¦¬ë·° ${Math.floor(daysSinceReview)}ì¼ ì „ (ì œì™¸)`, 'error');
                return false;
            }
        }

        return true;
    });

    // í”„ë¡ íŠ¸ì—”ë“œ ë­í‚¹ í˜•ì‹ìœ¼ë¡œ ë³€í™˜ (ë¦¬ë·° ë°ì´í„° í¬í•¨)
    return filteredPlaces.map(place => ({
        place_id: place.id,
        name: place.displayName.text,
        formatted_address: place.formattedAddress,
        vicinity: place.formattedAddress,
        formatted_phone_number: place.internationalPhoneNumber,
        rating: place.rating,
        user_ratings_total: place.userRatingCount,
        geometry: {
            location: {
                lat: () => place.location.latitude,
                lng: () => place.location.longitude
            }
        },
        photos: place.photos ? place.photos.map(photo => ({
            getUrl: (opts) => `https://places.googleapis.com/v1/${photo.name}/media?maxWidthPx=${opts.maxWidth}&key=${apiKey}`
        })) : null,
        website: place.websiteUri,
        opening_hours: place.regularOpeningHours?.weekdayDescriptions,
        editorial_summary: place.editorialSummary?.text,
        business_status: place.businessStatus || 'OPERATIONAL',
        last_review_time: place.reviews && place.reviews.length > 0 ? place.reviews[0].publishTime : null,
        reviews: place.reviews // ë¦¬ë·° ë°ì´í„° ì¶”ê°€ (AI ìš”ì•½ìš©)
    }));
}

function calculatePopularityScore(rating, reviewCount) {
    const C = 10;
    const m = 4.0;
    const adjustedRating = (C * m + reviewCount * rating) / (C + reviewCount);
    return adjustedRating * Math.log10(reviewCount + 1);
}

async function generateAISummary(place, existingSummary = null) {
    // Google ìš”ì•½ì´ ì´ë¯¸ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©
    if (place.editorial_summary) {
        addLog(`ğŸ’¡ ${place.name}: Google ìš”ì•½ ì‚¬ìš©`, 'info');
        return place.editorial_summary;
    }

    // ê¸°ì¡´ AI ìš”ì•½ì´ ìˆìœ¼ë©´ ì¬ì‚¬ìš© (30ì¼ ìºì‹±)
    if (existingSummary) {
        addLog(`â™»ï¸ ${place.name}: ê¸°ì¡´ AI ìš”ì•½ ì¬ì‚¬ìš© (í† í° ì ˆì•½)`, 'info');
        return existingSummary;
    }

    // ë¦¬ë·°ê°€ ì—†ìœ¼ë©´ null ë°˜í™˜
    if (!place.reviews || place.reviews.length === 0) {
        addLog(`âš ï¸ ${place.name}: ë¦¬ë·° ì—†ìŒ, ìš”ì•½ ìƒì„± ë¶ˆê°€`, 'error');
        return null;
    }

    try {
        addLog(`ğŸ¤– ${place.name}: AI ìš”ì•½ ìƒì„± ì¤‘...`, 'info');

        // ë¦¬ë·° ë°ì´í„° í¬ë§·íŒ…
        const reviewsData = place.reviews.map(review => ({
            text: review.text?.text || '',
            rating: review.rating || 0
        }));

        // Django ë°±ì—”ë“œ API í˜¸ì¶œ
        const response = await fetch('/api/local-businesses/generate_summary/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                business_name: place.name,
                reviews: reviewsData
            })
        });

        if (response.ok) {
            const data = await response.json();
            if (data.success && data.summary) {
                addLog(`âœ… ${place.name}: AI ìš”ì•½ ìƒì„± ì™„ë£Œ`, 'success');
                return data.summary;
            } else {
                addLog(`âš ï¸ ${place.name}: ${data.error || 'AI ìš”ì•½ ìƒì„± ì‹¤íŒ¨'}`, 'error');
                return null;
            }
        } else {
            const errorData = await response.json().catch(() => ({}));
            addLog(`âš ï¸ ${place.name}: API ì˜¤ë¥˜ (${response.status}) - ${errorData.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`, 'error');
            return null;
        }

    } catch (error) {
        console.error('AI ìš”ì•½ ìƒì„± ì˜¤ë¥˜:', error);
        addLog(`âŒ ${place.name}: ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ - ${error.message}`, 'error');
        return null;
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function addLog(message, type = 'info') {
    const logContainer = document.getElementById('logContainer');
    const color = type === 'error' ? '#f44336' : type === 'success' ? '#4CAF50' : '#666';
    logContainer.innerHTML += `<div style="color: ${color};">${message}</div>`;
    logContainer.scrollTop = logContainer.scrollHeight;
}
</script>
{% endblock %}
