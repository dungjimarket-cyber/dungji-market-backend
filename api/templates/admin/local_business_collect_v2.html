{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}ì§€ì—­ ì—…ì²´ ì •ë³´ ìˆ˜ì§‘ (Google API){% endblock %}

{% block extrahead %}
<!-- Google Maps API ë¶ˆí•„ìš” - Fetch APIë¡œ ì§ì ‘ í˜¸ì¶œ -->
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">í™ˆ</a>
    &rsaquo; <a href="{% url 'admin:api_localbusiness_changelist' %}">ì§€ì—­ ì—…ì²´</a>
    &rsaquo; ë°ì´í„° ìˆ˜ì§‘ (Google API)
</div>
{% endblock %}

{% block content %}
<div style="max-width: 800px; margin: 20px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
    <h1 style="margin-bottom: 20px;">ğŸ—ºï¸ ì§€ì—­ ì—…ì²´ ì •ë³´ ìˆ˜ì§‘ (Google Places API)</h1>

    <div style="background: #e7f3ff; border: 1px solid #2196F3; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
        <strong>â„¹ï¸ ì•ˆë‚´</strong>
        <ul style="margin: 10px 0 0 20px;">
            <li>ë¸Œë¼ìš°ì €ì—ì„œ ì§ì ‘ Google Places APIë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤</li>
            <li>í”„ë¡ íŠ¸ì—”ë“œ í™˜ê²½ë³€ìˆ˜ì— ì„¤ì •ëœ API í‚¤ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤</li>
            <li>ë­í‚¹ í˜ì´ì§€ì™€ ë™ì¼í•œ ë°©ì‹ì…ë‹ˆë‹¤</li>
        </ul>
    </div>

    <form id="collectForm" style="margin-top: 20px;">
        <div style="margin-bottom: 20px;">
            <label for="region" style="display: block; margin-bottom: 5px; font-weight: bold;">ì§€ì—­ ì„ íƒ</label>
            <select name="region" id="region" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" required>
                <option value="">-- ì§€ì—­ ì„ íƒ --</option>
                <option value="ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬">ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬</option>
                <option value="ì„œìš¸íŠ¹ë³„ì‹œ ì„œì´ˆêµ¬">ì„œìš¸íŠ¹ë³„ì‹œ ì„œì´ˆêµ¬</option>
                <option value="ì„œìš¸íŠ¹ë³„ì‹œ ì†¡íŒŒêµ¬">ì„œìš¸íŠ¹ë³„ì‹œ ì†¡íŒŒêµ¬</option>
                <option value="ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë™êµ¬">ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë™êµ¬</option>
                <option value="ì„œìš¸íŠ¹ë³„ì‹œ ë§ˆí¬êµ¬">ì„œìš¸íŠ¹ë³„ì‹œ ë§ˆí¬êµ¬</option>
                <option value="ê²½ê¸°ë„ ì„±ë‚¨ì‹œ">ê²½ê¸°ë„ ì„±ë‚¨ì‹œ</option>
                <option value="ê²½ê¸°ë„ ìˆ˜ì›ì‹œ">ê²½ê¸°ë„ ìˆ˜ì›ì‹œ</option>
                <option value="ê²½ê¸°ë„ ê³ ì–‘ì‹œ">ê²½ê¸°ë„ ê³ ì–‘ì‹œ</option>
                <option value="ê²½ê¸°ë„ ìš©ì¸ì‹œ">ê²½ê¸°ë„ ìš©ì¸ì‹œ</option>
                <option value="ê²½ê¸°ë„ í™”ì„±ì‹œ">ê²½ê¸°ë„ í™”ì„±ì‹œ</option>
            </select>
        </div>

        <div style="margin-bottom: 20px;">
            <label for="category" style="display: block; margin-bottom: 5px; font-weight: bold;">ì—…ì¢… ì„ íƒ</label>
            <select name="category" id="category" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" required>
                <option value="">-- ì—…ì¢… ì„ íƒ --</option>
                {% for cat in categories %}
                <option value="{{ cat.id }}" data-name-en="{{ cat.name_en }}">{{ cat.icon }} {{ cat.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div style="margin-bottom: 20px;">
            <label for="limit" style="display: block; margin-bottom: 5px; font-weight: bold;">ìˆ˜ì§‘ ê°œìˆ˜</label>
            <input type="number" name="limit" id="limit" value="5" min="1" max="20"
                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        </div>

        <button type="submit" id="collectBtn"
                style="width: 100%; padding: 12px 24px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: bold;">
            ğŸš€ ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘
        </button>
    </form>

    <div id="progressContainer" style="display: none; margin-top: 30px; padding: 20px; background: #f5f5f5; border-radius: 8px;">
        <h3 style="margin-bottom: 15px;">ğŸ“Š ìˆ˜ì§‘ ì§„í–‰ ìƒí™©</h3>

        <div style="background: white; padding: 15px; border-radius: 4px; margin-bottom: 15px;">
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center;">
                <div>
                    <div style="font-size: 24px; font-weight: bold; color: #4CAF50;" id="successCount">0</div>
                    <div style="color: #666; font-size: 12px;">ì„±ê³µ</div>
                </div>
                <div>
                    <div style="font-size: 24px; font-weight: bold; color: #f44336;" id="failCount">0</div>
                    <div style="color: #666; font-size: 12px;">ì‹¤íŒ¨</div>
                </div>
                <div>
                    <div style="font-size: 24px; font-weight: bold; color: #2196F3;" id="totalCount">0</div>
                    <div style="color: #666; font-size: 12px;">ì´</div>
                </div>
            </div>
        </div>

        <div style="background: white; padding: 15px; border-radius: 4px; max-height: 300px; overflow-y: auto;">
            <h4 style="margin-bottom: 10px;">ì‹¤ì‹œê°„ ë¡œê·¸</h4>
            <div id="logContainer" style="font-family: monospace; font-size: 12px; line-height: 1.6;"></div>
        </div>
    </div>
</div>

<script>
const REGION_COORDINATES = {
    'ê°•ë‚¨êµ¬': {latitude: 37.5172, longitude: 127.0473},
    'ì„œì´ˆêµ¬': {latitude: 37.4837, longitude: 127.0324},
    'ì†¡íŒŒêµ¬': {latitude: 37.5145, longitude: 127.1059},
    'ê°•ë™êµ¬': {latitude: 37.5301, longitude: 127.1238},
    'ë§ˆí¬êµ¬': {latitude: 37.5663, longitude: 126.9019},
    'ì„±ë‚¨ì‹œ': {latitude: 37.4201, longitude: 127.1262},
    'ìˆ˜ì›ì‹œ': {latitude: 37.2636, longitude: 127.0286},
    'ê³ ì–‘ì‹œ': {latitude: 37.6584, longitude: 126.8320},
    'ìš©ì¸ì‹œ': {latitude: 37.2410, longitude: 127.1776},
    'í™”ì„±ì‹œ': {latitude: 37.1990, longitude: 126.8312}
};

document.getElementById('collectForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const region = document.getElementById('region').value;
    const categorySelect = document.getElementById('category');
    const categoryId = categorySelect.value;
    const categoryNameEn = categorySelect.options[categorySelect.selectedIndex].dataset.nameEn;
    const limit = parseInt(document.getElementById('limit').value);

    const regionShort = region.split(' ').pop();
    const coordinates = REGION_COORDINATES[regionShort];

    document.getElementById('progressContainer').style.display = 'block';
    document.getElementById('collectBtn').disabled = true;
    document.getElementById('collectBtn').textContent = 'â³ ìˆ˜ì§‘ ì¤‘...';

    addLog('ğŸ” Google Places API í˜¸ì¶œ ì¤‘...');

    try {
        // Google Places API í˜¸ì¶œ
        const places = await fetchGooglePlaces(regionShort, categoryNameEn, coordinates, limit);

        addLog(`âœ… ${places.length}ê°œ ì—…ì²´ ë°œê²¬`);

        // ë°±ì—”ë“œë¡œ ì €ì¥
        const businesses = places.map((place, index) => ({
            google_place_id: place.place_id,
            category_id: parseInt(categoryId),
            region_name: region,
            name: place.name,
            address: place.formatted_address || place.vicinity,
            phone_number: place.formatted_phone_number,
            latitude: place.geometry.location.lat(),
            longitude: place.geometry.location.lng(),
            rating: place.rating,
            review_count: place.user_ratings_total || 0,
            google_maps_url: `https://www.google.com/maps/place/?q=place_id:${place.place_id}`,
            photo_url: place.photos && place.photos[0] ? place.photos[0].getUrl({maxWidth: 400}) : null,
            popularity_score: calculatePopularityScore(place.rating || 0, place.user_ratings_total || 0),
            rank_in_region: index + 1,
            is_new: (place.user_ratings_total || 0) < 10
        }));

        addLog('ğŸ’¾ ë°±ì—”ë“œì— ì €ì¥ ì¤‘...');

        const response = await fetch('/api/local-businesses/bulk_create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({businesses})
        });

        const result = await response.json();

        document.getElementById('successCount').textContent = result.created + result.updated;
        document.getElementById('failCount').textContent = result.errors.length;
        document.getElementById('totalCount').textContent = result.total;

        addLog(`âœ… ì™„ë£Œ! ìƒì„±: ${result.created}ê°œ, ì—…ë°ì´íŠ¸: ${result.updated}ê°œ`);

        if (result.errors.length > 0) {
            result.errors.forEach(err => addLog(`âŒ ${err}`, 'error'));
        }

    } catch (error) {
        addLog(`âŒ ì˜¤ë¥˜: ${error.message}`, 'error');
    } finally {
        document.getElementById('collectBtn').disabled = false;
        document.getElementById('collectBtn').textContent = 'ğŸš€ ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘';
    }
});

async function fetchGooglePlaces(city, category, coordinates, maxResults) {
    const apiKey = '{{ google_api_key }}';
    const apiUrl = 'https://places.googleapis.com/v1/places:searchText';

    const requestBody = {
        textQuery: `${city} ${category}`,
        languageCode: 'ko',
        locationBias: {
            circle: {
                center: {
                    latitude: coordinates.latitude,
                    longitude: coordinates.longitude
                },
                radius: 5000.0
            }
        },
        minRating: 4.0,
        maxResultCount: maxResults
    };

    const headers = {
        'Content-Type': 'application/json',
        'X-Goog-Api-Key': apiKey,
        'X-Goog-FieldMask': 'places.id,places.displayName,places.formattedAddress,places.rating,places.userRatingCount,places.location,places.internationalPhoneNumber,places.photos'
    };

    const response = await fetch(apiUrl, {
        method: 'POST',
        headers: headers,
        body: JSON.stringify(requestBody)
    });

    if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`Google API ì˜¤ë¥˜: ${response.status} - ${errorText}`);
    }

    const data = await response.json();

    if (!data.places || data.places.length === 0) {
        return [];
    }

    // í”„ë¡ íŠ¸ì—”ë“œ ë­í‚¹ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
    return data.places.map(place => ({
        place_id: place.id,
        name: place.displayName.text,
        formatted_address: place.formattedAddress,
        vicinity: place.formattedAddress,
        formatted_phone_number: place.internationalPhoneNumber,
        rating: place.rating,
        user_ratings_total: place.userRatingCount,
        geometry: {
            location: {
                lat: () => place.location.latitude,
                lng: () => place.location.longitude
            }
        },
        photos: place.photos ? place.photos.map(photo => ({
            getUrl: (opts) => `https://places.googleapis.com/v1/${photo.name}/media?maxWidthPx=${opts.maxWidth}&key=${apiKey}`
        })) : null
    }));
}

function calculatePopularityScore(rating, reviewCount) {
    const C = 10;
    const m = 4.0;
    const adjustedRating = (C * m + reviewCount * rating) / (C + reviewCount);
    return adjustedRating * Math.log10(reviewCount + 1);
}

function addLog(message, type = 'info') {
    const logContainer = document.getElementById('logContainer');
    const color = type === 'error' ? '#f44336' : type === 'success' ? '#4CAF50' : '#666';
    logContainer.innerHTML += `<div style="color: ${color};">${message}</div>`;
    logContainer.scrollTop = logContainer.scrollHeight;
}
</script>
{% endblock %}
