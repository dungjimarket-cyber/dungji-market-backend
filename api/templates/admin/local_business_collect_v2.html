{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}ì§€ì—­ ì—…ì²´ ì •ë³´ ìˆ˜ì§‘ (Google API){% endblock %}

{% block extrahead %}
<!-- Google Maps API ë¶ˆí•„ìš” - Fetch APIë¡œ ì§ì ‘ í˜¸ì¶œ -->
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">í™ˆ</a>
    &rsaquo; <a href="{% url 'admin:api_localbusiness_changelist' %}">ì§€ì—­ ì—…ì²´</a>
    &rsaquo; ë°ì´í„° ìˆ˜ì§‘ (Google API)
</div>
{% endblock %}

{% block content %}
<div style="max-width: 800px; margin: 20px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
    <h1 style="margin-bottom: 20px;">ğŸ—ºï¸ ì§€ì—­ ì—…ì²´ ì •ë³´ ìˆ˜ì§‘ (Google Places API)</h1>

    <div style="background: #e7f3ff; border: 1px solid #2196F3; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
        <strong>â„¹ï¸ ì•ˆë‚´</strong>
        <ul style="margin: 10px 0 0 20px;">
            <li>ë¸Œë¼ìš°ì €ì—ì„œ ì§ì ‘ Google Places APIë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤</li>
            <li>í”„ë¡ íŠ¸ì—”ë“œ í™˜ê²½ë³€ìˆ˜ì— ì„¤ì •ëœ API í‚¤ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤</li>
            <li>ë­í‚¹ í˜ì´ì§€ì™€ ë™ì¼í•œ ë°©ì‹ì…ë‹ˆë‹¤</li>
        </ul>
    </div>

    <form id="collectForm" style="margin-top: 20px;">
        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 10px; font-weight: bold;">ì§€ì—­ ì„ íƒ (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥)</label>

            <div style="border: 1px solid #ddd; border-radius: 4px; padding: 15px; max-height: 400px; overflow-y: auto;">
                {% for group in region_groups %}
                <div style="margin-bottom: 15px;" data-group-index="{{ forloop.counter0 }}">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding-bottom: 5px; border-bottom: 1px solid #e0e0e0;">
                        <span style="font-weight: bold; color: #2196F3;">{{ group.name }}</span>
                        <button type="button" class="group-select-btn" data-group="{{ forloop.counter0 }}"
                                style="padding: 4px 10px; background: #4CAF50; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">
                            ê·¸ë£¹ ì „ì²´ ì„ íƒ
                        </button>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                        {% for region in group.regions %}
                        <label style="display: flex; align-items: center; cursor: pointer; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px; background: #fafafa; transition: background 0.2s;">
                            <input type="checkbox" name="regions" value="{{ region }}" class="region-checkbox group-{{ forloop.parentloop.counter0 }}" style="margin-right: 8px; width: 16px; height: 16px; cursor: pointer;">
                            <span style="font-size: 13px;">{{ region }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
            <div style="margin-top: 10px; text-align: right;">
                <button type="button" id="selectAllBtn" style="padding: 6px 12px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; margin-right: 5px;">ì „ì²´ ì„ íƒ</button>
                <button type="button" id="deselectAllBtn" style="padding: 6px 12px; background: #9E9E9E; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">ì „ì²´ í•´ì œ</button>
            </div>
        </div>

        <div style="margin-bottom: 20px;">
            <label for="category" style="display: block; margin-bottom: 5px; font-weight: bold;">ì—…ì¢… ì„ íƒ</label>
            <select name="category" id="category" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" required>
                <option value="">-- ì—…ì¢… ì„ íƒ --</option>
                <option value="ALL" data-name-ko="ALL" data-place-type="ALL" style="font-weight: bold; background: #e3f2fd;">ğŸ“‹ ì „ì²´ ì—…ì¢… ({{ categories|length }}ê°œ)</option>
                {% for cat in categories %}
                <option value="{{ cat.id }}" data-name-ko="{{ cat.name }}" data-place-type="{{ cat.google_place_type }}">{{ cat.icon }} {{ cat.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div style="margin-bottom: 20px;">
            <label for="limit" style="display: block; margin-bottom: 5px; font-weight: bold;">ìˆ˜ì§‘ ê°œìˆ˜</label>
            <input type="number" name="limit" id="limit" value="5" min="1" max="20"
                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        </div>

        <button type="submit" id="collectBtn"
                style="width: 100%; padding: 12px 24px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: bold;">
            ğŸš€ ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘
        </button>
        <button type="button" id="stopBtn"
                style="display: none; width: 100%; padding: 12px 24px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: bold; margin-top: 10px;">
            â¹ï¸ ìˆ˜ì§‘ ì¤‘ë‹¨
        </button>
    </form>

    <div id="progressContainer" style="display: none; margin-top: 30px; padding: 20px; background: #f5f5f5; border-radius: 8px;">
        <h3 style="margin-bottom: 15px;">ğŸ“Š ìˆ˜ì§‘ ì§„í–‰ ìƒí™©</h3>

        <div style="background: white; padding: 15px; border-radius: 4px; margin-bottom: 15px;">
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center;">
                <div>
                    <div style="font-size: 24px; font-weight: bold; color: #4CAF50;" id="successCount">0</div>
                    <div style="color: #666; font-size: 12px;">ì„±ê³µ</div>
                </div>
                <div>
                    <div style="font-size: 24px; font-weight: bold; color: #f44336;" id="failCount">0</div>
                    <div style="color: #666; font-size: 12px;">ì‹¤íŒ¨</div>
                </div>
                <div>
                    <div style="font-size: 24px; font-weight: bold; color: #2196F3;" id="totalCount">0</div>
                    <div style="color: #666; font-size: 12px;">ì´</div>
                </div>
            </div>
        </div>

        <div style="background: white; padding: 15px; border-radius: 4px; max-height: 300px; overflow-y: auto;">
            <h4 style="margin-bottom: 10px;">ì‹¤ì‹œê°„ ë¡œê·¸</h4>
            <div id="logContainer" style="font-family: monospace; font-size: 12px; line-height: 1.6;"></div>
        </div>
    </div>
</div>

<script>
// ì§€ì—­ë³„ ì¢Œí‘œ
const REGION_COORDINATES = {
    // ì„œìš¸íŠ¹ë³„ì‹œ 25ê°œ êµ¬
    'ê°•ë‚¨êµ¬': {latitude: 37.5172, longitude: 127.0473},
    'ê°•ë™êµ¬': {latitude: 37.5301, longitude: 127.1238},
    'ê°•ë¶êµ¬': {latitude: 37.6398, longitude: 127.0256},
    'ê°•ì„œêµ¬': {latitude: 37.5509, longitude: 126.8495},
    'ê´€ì•…êµ¬': {latitude: 37.4784, longitude: 126.9516},
    'ê´‘ì§„êµ¬': {latitude: 37.5384, longitude: 127.0822},
    'êµ¬ë¡œêµ¬': {latitude: 37.4954, longitude: 126.8874},
    'ê¸ˆì²œêµ¬': {latitude: 37.4519, longitude: 126.9020},
    'ë…¸ì›êµ¬': {latitude: 37.6542, longitude: 127.0568},
    'ë„ë´‰êµ¬': {latitude: 37.6688, longitude: 127.0471},
    'ë™ëŒ€ë¬¸êµ¬': {latitude: 37.5744, longitude: 127.0399},
    'ë™ì‘êµ¬': {latitude: 37.5124, longitude: 126.9393},
    'ë§ˆí¬êµ¬': {latitude: 37.5663, longitude: 126.9019},
    'ì„œëŒ€ë¬¸êµ¬': {latitude: 37.5791, longitude: 126.9368},
    'ì„œì´ˆêµ¬': {latitude: 37.4837, longitude: 127.0324},
    'ì„±ë™êµ¬': {latitude: 37.5634, longitude: 127.0369},
    'ì„±ë¶êµ¬': {latitude: 37.5894, longitude: 127.0167},
    'ì†¡íŒŒêµ¬': {latitude: 37.5145, longitude: 127.1059},
    'ì–‘ì²œêµ¬': {latitude: 37.5170, longitude: 126.8664},
    'ì˜ë“±í¬êµ¬': {latitude: 37.5264, longitude: 126.8963},
    'ìš©ì‚°êµ¬': {latitude: 37.5326, longitude: 126.9900},
    'ì€í‰êµ¬': {latitude: 37.6027, longitude: 126.9291},
    'ì¢…ë¡œêµ¬': {latitude: 37.5735, longitude: 126.9791},
    'ì¤‘êµ¬': {latitude: 37.5641, longitude: 126.9979},
    'ì¤‘ë‘êµ¬': {latitude: 37.6063, longitude: 127.0929},

    // ê²½ê¸°ë„ ì£¼ìš” ì‹œ
    'ì„±ë‚¨ì‹œ': {latitude: 37.4201, longitude: 127.1262},
    'ìˆ˜ì›ì‹œ': {latitude: 37.2636, longitude: 127.0286},
    'ê³ ì–‘ì‹œ': {latitude: 37.6584, longitude: 126.8320},
    'ìš©ì¸ì‹œ': {latitude: 37.2410, longitude: 127.1776},
    'ë¶€ì²œì‹œ': {latitude: 37.5034, longitude: 126.7660},
    'ì•ˆì‚°ì‹œ': {latitude: 37.3219, longitude: 126.8309},
    'ì•ˆì–‘ì‹œ': {latitude: 37.3943, longitude: 126.9568},
    'ë‚¨ì–‘ì£¼ì‹œ': {latitude: 37.6360, longitude: 127.2166},
    'í™”ì„±ì‹œ': {latitude: 37.1990, longitude: 126.8312},
    'í‰íƒì‹œ': {latitude: 36.9922, longitude: 127.1129},
    'ì˜ì •ë¶€ì‹œ': {latitude: 37.7382, longitude: 127.0338},
    'ì‹œí¥ì‹œ': {latitude: 37.3800, longitude: 126.8028},
    'íŒŒì£¼ì‹œ': {latitude: 37.7608, longitude: 126.7800},
    'ê¹€í¬ì‹œ': {latitude: 37.6152, longitude: 126.7159},
    'ê´‘ëª…ì‹œ': {latitude: 37.4786, longitude: 126.8644},
    'ê´‘ì£¼ì‹œ': {latitude: 37.4295, longitude: 127.2551},
    'êµ°í¬ì‹œ': {latitude: 37.3617, longitude: 126.9352},
    'í•˜ë‚¨ì‹œ': {latitude: 37.5400, longitude: 127.2015},
    'ì˜¤ì‚°ì‹œ': {latitude: 37.1498, longitude: 127.0773},
    'ì–‘ì£¼ì‹œ': {latitude: 37.7853, longitude: 127.0458},
    'ì´ì²œì‹œ': {latitude: 37.2720, longitude: 127.4351},
    'êµ¬ë¦¬ì‹œ': {latitude: 37.5943, longitude: 127.1296},
    'ì•ˆì„±ì‹œ': {latitude: 37.0079, longitude: 127.2797},
    'í¬ì²œì‹œ': {latitude: 37.8950, longitude: 127.2004},
    'ì˜ì™•ì‹œ': {latitude: 37.3449, longitude: 126.9684},
    'ì—¬ì£¼ì‹œ': {latitude: 37.2984, longitude: 127.6377},
    'ë™ë‘ì²œì‹œ': {latitude: 37.9034, longitude: 127.0606},
    'ê³¼ì²œì‹œ': {latitude: 37.4292, longitude: 126.9879},
    'ê°€í‰êµ°': {latitude: 37.8314, longitude: 127.5095},
    'ì—°ì²œêµ°': {latitude: 38.0969, longitude: 127.0753},

    // ì¶©ì²­ë¶ë„
    'ì²­ì£¼ì‹œ': {latitude: 36.6424, longitude: 127.4890},
    'ì¶©ì£¼ì‹œ': {latitude: 36.9910, longitude: 127.9260},
    'ì œì²œì‹œ': {latitude: 37.1326, longitude: 128.1911},
    'ìŒì„±êµ°': {latitude: 36.9402, longitude: 127.6923},
    'ì§„ì²œêµ°': {latitude: 36.8554, longitude: 127.4360},
    'ê´´ì‚°êµ°': {latitude: 36.8156, longitude: 127.7870},
    'ì¦í‰êµ°': {latitude: 36.7848, longitude: 127.5821},
    'ë‹¨ì–‘êµ°': {latitude: 36.9845, longitude: 128.3657},
    'ë³´ì€êµ°': {latitude: 36.4895, longitude: 127.7296},
    'ì˜¥ì²œêµ°': {latitude: 36.3014, longitude: 127.5718},
    'ì˜ë™êµ°': {latitude: 36.1751, longitude: 127.7834},

    // ì¶©ì²­ë‚¨ë„
    'ì²œì•ˆì‹œ': {latitude: 36.8151, longitude: 127.1139},
    'ì•„ì‚°ì‹œ': {latitude: 36.7898, longitude: 127.0020},
    'ì„œì‚°ì‹œ': {latitude: 36.7847, longitude: 126.4503},
    'ë…¼ì‚°ì‹œ': {latitude: 36.1871, longitude: 127.0989},
    'ê³„ë£¡ì‹œ': {latitude: 36.2743, longitude: 127.2488},
    'ë‹¹ì§„ì‹œ': {latitude: 36.8930, longitude: 126.6470},
    'ê³µì£¼ì‹œ': {latitude: 36.4465, longitude: 127.1189},
    'ë³´ë ¹ì‹œ': {latitude: 36.3334, longitude: 126.6128},
    'ê¸ˆì‚°êµ°': {latitude: 36.1088, longitude: 127.4882},
    'ë¶€ì—¬êµ°': {latitude: 36.2756, longitude: 126.9099},
    'ì„œì²œêµ°': {latitude: 36.0803, longitude: 126.6919},
    'ì²­ì–‘êµ°': {latitude: 36.4592, longitude: 126.8024},
    'í™ì„±êµ°': {latitude: 36.6012, longitude: 126.6650},
    'ì˜ˆì‚°êµ°': {latitude: 36.6816, longitude: 126.8469},
    'íƒœì•ˆêµ°': {latitude: 36.7456, longitude: 126.2981},

    // ì „ë¼ë¶ë„
    'ì „ì£¼ì‹œ': {latitude: 35.8242, longitude: 127.1480},
    'êµ°ì‚°ì‹œ': {latitude: 35.9676, longitude: 126.7366},
    'ìµì‚°ì‹œ': {latitude: 35.9483, longitude: 126.9575},
    'ì •ìì‹œ': {latitude: 35.5697, longitude: 126.8560},
    'ë‚¨ì›ì‹œ': {latitude: 35.4164, longitude: 127.3903},
    'ê¹€ì œì‹œ': {latitude: 35.8031, longitude: 126.8809},
    'ì™„ì£¼êµ°': {latitude: 35.9050, longitude: 127.1644},
    'ì§„ì•ˆêµ°': {latitude: 35.7918, longitude: 127.4247},
    'ë¬´ì£¼êµ°': {latitude: 36.0072, longitude: 127.6608},
    'ì¥ìˆ˜êµ°': {latitude: 35.6478, longitude: 127.5215},
    'ì„ì‹¤êµ°': {latitude: 35.6176, longitude: 127.2899},
    'ìˆœì°½êµ°': {latitude: 35.3742, longitude: 127.1377},
    'ê³ ì°½êµ°': {latitude: 35.4354, longitude: 126.7020},
    'ë¶€ì•ˆêµ°': {latitude: 35.7319, longitude: 126.7333},

    // ì „ë¼ë‚¨ë„
    'ëª©í¬ì‹œ': {latitude: 34.8118, longitude: 126.3922},
    'ì—¬ìˆ˜ì‹œ': {latitude: 34.7604, longitude: 127.6622},
    'ìˆœì²œì‹œ': {latitude: 34.9506, longitude: 127.4872},
    'ë‚˜ì£¼ì‹œ': {latitude: 35.0160, longitude: 126.7107},
    'ê´‘ì–‘ì‹œ': {latitude: 34.9406, longitude: 127.6956},
    'ë‹´ì–‘êµ°': {latitude: 35.3208, longitude: 126.9882},
    'ê³¡ì„±êµ°': {latitude: 35.2818, longitude: 127.2925},
    'êµ¬ë¡€êµ°': {latitude: 35.2023, longitude: 127.4632},
    'ê³ í¥êµ°': {latitude: 34.6113, longitude: 127.2754},
    'ë³´ì„±êµ°': {latitude: 34.7713, longitude: 127.0800},
    'í™”ìˆœêµ°': {latitude: 35.0641, longitude: 126.9866},
    'ì¥í¥êµ°': {latitude: 34.6815, longitude: 126.9068},
    'ê°•ì§„êµ°': {latitude: 34.6420, longitude: 126.7672},
    'í•´ë‚¨êµ°': {latitude: 34.5733, longitude: 126.5989},
    'ì˜ì•”êµ°': {latitude: 34.8003, longitude: 126.6967},
    'ë¬´ì•ˆêµ°': {latitude: 34.9904, longitude: 126.4819},
    'í•¨í‰êµ°': {latitude: 35.0664, longitude: 126.5166},
    'ì˜ê´‘êµ°': {latitude: 35.2772, longitude: 126.5119},
    'ì¥ì„±êµ°': {latitude: 35.3018, longitude: 126.7844},
    'ì™„ë„êµ°': {latitude: 34.3114, longitude: 126.7551},
    'ì§„ë„êµ°': {latitude: 34.4868, longitude: 126.2633},
    'ì‹ ì•ˆêµ°': {latitude: 34.8267, longitude: 126.1080},

    // ê²½ìƒë¶ë„
    'í¬í•­ì‹œ': {latitude: 36.0190, longitude: 129.3435},
    'ê²½ì£¼ì‹œ': {latitude: 35.8562, longitude: 129.2247},
    'ê¹€ì²œì‹œ': {latitude: 36.1400, longitude: 128.1139},
    'ì•ˆë™ì‹œ': {latitude: 36.5684, longitude: 128.7294},
    'êµ¬ë¯¸ì‹œ': {latitude: 36.1195, longitude: 128.3445},
    'ì˜ì£¼ì‹œ': {latitude: 36.8056, longitude: 128.6239},
    'ì˜ì²œì‹œ': {latitude: 35.9733, longitude: 128.9386},
    'ìƒì£¼ì‹œ': {latitude: 36.4109, longitude: 128.1590},
    'ë¬¸ê²½ì‹œ': {latitude: 36.5865, longitude: 128.1867},
    'ê²½ì‚°ì‹œ': {latitude: 35.8250, longitude: 128.7414},
    'êµ°ìœ„êµ°': {latitude: 36.2424, longitude: 128.5726},
    'ì˜ì„±êµ°': {latitude: 36.3526, longitude: 128.6973},
    'ì²­ì†¡êµ°': {latitude: 36.4363, longitude: 129.0571},
    'ì˜ì–‘êµ°': {latitude: 36.6666, longitude: 129.1124},
    'ì˜ë•êµ°': {latitude: 36.4151, longitude: 129.3657},
    'ì²­ë„êµ°': {latitude: 35.6476, longitude: 128.7363},
    'ê³ ë ¹êµ°': {latitude: 35.7273, longitude: 128.2629},
    'ì„±ì£¼êµ°': {latitude: 35.9196, longitude: 128.2826},
    'ì¹ ê³¡êµ°': {latitude: 35.9954, longitude: 128.4018},
    'ì˜ˆì²œêµ°': {latitude: 36.6566, longitude: 128.4525},
    'ë´‰í™”êµ°': {latitude: 36.8930, longitude: 128.7323},
    'ìš¸ì§„êµ°': {latitude: 36.9930, longitude: 129.4006},
    'ìš¸ë¦‰êµ°': {latitude: 37.4845, longitude: 130.9058},

    // ê²½ìƒë‚¨ë„
    'ì°½ì›ì‹œ': {latitude: 35.2281, longitude: 128.6811},
    'ì§„ì£¼ì‹œ': {latitude: 35.1800, longitude: 128.1076},
    'í†µì˜ì‹œ': {latitude: 34.8544, longitude: 128.4332},
    'ì‚¬ì²œì‹œ': {latitude: 35.0036, longitude: 128.0642},
    'ê¹€í•´ì‹œ': {latitude: 35.2285, longitude: 128.8894},
    'ë°€ì–‘ì‹œ': {latitude: 35.5038, longitude: 128.7465},
    'ê±°ì œì‹œ': {latitude: 34.8806, longitude: 128.6214},
    'ì–‘ì‚°ì‹œ': {latitude: 35.3350, longitude: 129.0374},
    'ì˜ë ¹êµ°': {latitude: 35.3222, longitude: 128.2617},
    'í•¨ì•ˆêµ°': {latitude: 35.2723, longitude: 128.4064},
    'ì°½ë…•êµ°': {latitude: 35.5445, longitude: 128.4923},
    'ê³ ì„±êµ°': {latitude: 34.9732, longitude: 128.3226},
    'ë‚¨í•´êµ°': {latitude: 34.8376, longitude: 127.8924},
    'í•˜ë™êµ°': {latitude: 35.0673, longitude: 127.7513},
    'ì‚°ì²­êµ°': {latitude: 35.4152, longitude: 127.8734},
    'í•¨ì–‘êµ°': {latitude: 35.5204, longitude: 127.7252},
    'ê±°ì°½êµ°': {latitude: 35.6869, longitude: 127.9095},
    'í•©ì²œêµ°': {latitude: 35.5664, longitude: 128.1656},

    // ì œì£¼íŠ¹ë³„ìì¹˜ë„
    'ì œì£¼ì‹œ': {latitude: 33.4996, longitude: 126.5312},
    'ì„œê·€í¬ì‹œ': {latitude: 33.2541, longitude: 126.5601}
};

// ì‹œ/ë„ë³„ í•˜ë¶€ ì§€ì—­ ë§¤í•‘ (ì„¸ë¶„í™”)
const PROVINCE_TO_REGIONS = {
    'ì„œìš¸ ê°•ë‚¨/ì„œì´ˆ': [
        'ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬', 'ì„œìš¸íŠ¹ë³„ì‹œ ì„œì´ˆêµ¬', 'ì„œìš¸íŠ¹ë³„ì‹œ ì†¡íŒŒêµ¬', 'ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë™êµ¬'
    ],
    'ì„œìš¸ ê°•ì„œ/ì–‘ì²œ': [
        'ì„œìš¸íŠ¹ë³„ì‹œ ê°•ì„œêµ¬', 'ì„œìš¸íŠ¹ë³„ì‹œ ì–‘ì²œêµ¬', 'ì„œìš¸íŠ¹ë³„ì‹œ êµ¬ë¡œêµ¬', 'ì„œìš¸íŠ¹ë³„ì‹œ ê¸ˆì²œêµ¬', 'ì„œìš¸íŠ¹ë³„ì‹œ ì˜ë“±í¬êµ¬'
    ],
    'ì„œìš¸ ê°•ë¶/ë…¸ì›': [
        'ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë¶êµ¬', 'ì„œìš¸íŠ¹ë³„ì‹œ ë…¸ì›êµ¬', 'ì„œìš¸íŠ¹ë³„ì‹œ ë„ë´‰êµ¬', 'ì„œìš¸íŠ¹ë³„ì‹œ ì„±ë¶êµ¬', 'ì„œìš¸íŠ¹ë³„ì‹œ ì¤‘ë‘êµ¬'
    ],
    'ì„œìš¸ ë™ë¶€': [
        'ì„œìš¸íŠ¹ë³„ì‹œ ê´‘ì§„êµ¬', 'ì„œìš¸íŠ¹ë³„ì‹œ ë™ëŒ€ë¬¸êµ¬', 'ì„œìš¸íŠ¹ë³„ì‹œ ì„±ë™êµ¬'
    ],
    'ì„œìš¸ ì¤‘ë¶€/ì„œë¶€': [
        'ì„œìš¸íŠ¹ë³„ì‹œ ì¢…ë¡œêµ¬', 'ì„œìš¸íŠ¹ë³„ì‹œ ì¤‘êµ¬', 'ì„œìš¸íŠ¹ë³„ì‹œ ìš©ì‚°êµ¬', 'ì„œìš¸íŠ¹ë³„ì‹œ ë§ˆí¬êµ¬',
        'ì„œìš¸íŠ¹ë³„ì‹œ ì„œëŒ€ë¬¸êµ¬', 'ì„œìš¸íŠ¹ë³„ì‹œ ì€í‰êµ¬'
    ],
    'ì„œìš¸ ê´€ì•…/ë™ì‘': [
        'ì„œìš¸íŠ¹ë³„ì‹œ ê´€ì•…êµ¬', 'ì„œìš¸íŠ¹ë³„ì‹œ ë™ì‘êµ¬'
    ],
    'ê²½ê¸° ë¶ë¶€': [
        'ê²½ê¸°ë„ ì˜ì •ë¶€ì‹œ', 'ê²½ê¸°ë„ ì–‘ì£¼ì‹œ', 'ê²½ê¸°ë„ ë™ë‘ì²œì‹œ', 'ê²½ê¸°ë„ í¬ì²œì‹œ', 'ê²½ê¸°ë„ íŒŒì£¼ì‹œ',
        'ê²½ê¸°ë„ ê³ ì–‘ì‹œ', 'ê²½ê¸°ë„ ê¹€í¬ì‹œ', 'ê²½ê¸°ë„ ë‚¨ì–‘ì£¼ì‹œ', 'ê²½ê¸°ë„ êµ¬ë¦¬ì‹œ', 'ê²½ê¸°ë„ ê°€í‰êµ°', 'ê²½ê¸°ë„ ì—°ì²œêµ°'
    ],
    'ê²½ê¸° ë‚¨ë¶€': [
        'ê²½ê¸°ë„ ìˆ˜ì›ì‹œ', 'ê²½ê¸°ë„ ì„±ë‚¨ì‹œ', 'ê²½ê¸°ë„ ìš©ì¸ì‹œ', 'ê²½ê¸°ë„ ì•ˆì–‘ì‹œ', 'ê²½ê¸°ë„ ë¶€ì²œì‹œ',
        'ê²½ê¸°ë„ ê´‘ëª…ì‹œ', 'ê²½ê¸°ë„ ê³¼ì²œì‹œ', 'ê²½ê¸°ë„ ì˜ì™•ì‹œ', 'ê²½ê¸°ë„ êµ°í¬ì‹œ', 'ê²½ê¸°ë„ ì•ˆì‚°ì‹œ',
        'ê²½ê¸°ë„ ì‹œí¥ì‹œ', 'ê²½ê¸°ë„ ê´‘ì£¼ì‹œ', 'ê²½ê¸°ë„ í•˜ë‚¨ì‹œ', 'ê²½ê¸°ë„ ì´ì²œì‹œ', 'ê²½ê¸°ë„ ì—¬ì£¼ì‹œ',
        'ê²½ê¸°ë„ í™”ì„±ì‹œ', 'ê²½ê¸°ë„ í‰íƒì‹œ', 'ê²½ê¸°ë„ ì•ˆì„±ì‹œ', 'ê²½ê¸°ë„ ì˜¤ì‚°ì‹œ'
    ],
    'ì¶©ì²­ë¶ë„': [
        'ì¶©ì²­ë¶ë„ ì²­ì£¼ì‹œ', 'ì¶©ì²­ë¶ë„ ì¶©ì£¼ì‹œ', 'ì¶©ì²­ë¶ë„ ì œì²œì‹œ', 'ì¶©ì²­ë¶ë„ ìŒì„±êµ°',
        'ì¶©ì²­ë¶ë„ ì§„ì²œêµ°', 'ì¶©ì²­ë¶ë„ ê´´ì‚°êµ°', 'ì¶©ì²­ë¶ë„ ì¦í‰êµ°', 'ì¶©ì²­ë¶ë„ ë‹¨ì–‘êµ°',
        'ì¶©ì²­ë¶ë„ ë³´ì€êµ°', 'ì¶©ì²­ë¶ë„ ì˜¥ì²œêµ°', 'ì¶©ì²­ë¶ë„ ì˜ë™êµ°'
    ],
    'ì¶©ì²­ë‚¨ë„': [
        'ì¶©ì²­ë‚¨ë„ ì²œì•ˆì‹œ', 'ì¶©ì²­ë‚¨ë„ ì•„ì‚°ì‹œ', 'ì¶©ì²­ë‚¨ë„ ì„œì‚°ì‹œ', 'ì¶©ì²­ë‚¨ë„ ë…¼ì‚°ì‹œ',
        'ì¶©ì²­ë‚¨ë„ ê³„ë£¡ì‹œ', 'ì¶©ì²­ë‚¨ë„ ë‹¹ì§„ì‹œ', 'ì¶©ì²­ë‚¨ë„ ê³µì£¼ì‹œ', 'ì¶©ì²­ë‚¨ë„ ë³´ë ¹ì‹œ',
        'ì¶©ì²­ë‚¨ë„ ê¸ˆì‚°êµ°', 'ì¶©ì²­ë‚¨ë„ ë¶€ì—¬êµ°', 'ì¶©ì²­ë‚¨ë„ ì„œì²œêµ°', 'ì¶©ì²­ë‚¨ë„ ì²­ì–‘êµ°',
        'ì¶©ì²­ë‚¨ë„ í™ì„±êµ°', 'ì¶©ì²­ë‚¨ë„ ì˜ˆì‚°êµ°', 'ì¶©ì²­ë‚¨ë„ íƒœì•ˆêµ°'
    ],
    'ì „ë¼ë¶ë„': [
        'ì „ë¼ë¶ë„ ì „ì£¼ì‹œ', 'ì „ë¼ë¶ë„ êµ°ì‚°ì‹œ', 'ì „ë¼ë¶ë„ ìµì‚°ì‹œ', 'ì „ë¼ë¶ë„ ì •ìì‹œ',
        'ì „ë¼ë¶ë„ ë‚¨ì›ì‹œ', 'ì „ë¼ë¶ë„ ê¹€ì œì‹œ', 'ì „ë¼ë¶ë„ ì™„ì£¼êµ°', 'ì „ë¼ë¶ë„ ì§„ì•ˆêµ°',
        'ì „ë¼ë¶ë„ ë¬´ì£¼êµ°', 'ì „ë¼ë¶ë„ ì¥ìˆ˜êµ°', 'ì „ë¼ë¶ë„ ì„ì‹¤êµ°', 'ì „ë¼ë¶ë„ ìˆœì°½êµ°',
        'ì „ë¼ë¶ë„ ê³ ì°½êµ°', 'ì „ë¼ë¶ë„ ë¶€ì•ˆêµ°'
    ],
    'ì „ë¼ë‚¨ë„': [
        'ì „ë¼ë‚¨ë„ ëª©í¬ì‹œ', 'ì „ë¼ë‚¨ë„ ì—¬ìˆ˜ì‹œ', 'ì „ë¼ë‚¨ë„ ìˆœì²œì‹œ', 'ì „ë¼ë‚¨ë„ ë‚˜ì£¼ì‹œ',
        'ì „ë¼ë‚¨ë„ ê´‘ì–‘ì‹œ', 'ì „ë¼ë‚¨ë„ ë‹´ì–‘êµ°', 'ì „ë¼ë‚¨ë„ ê³¡ì„±êµ°', 'ì „ë¼ë‚¨ë„ êµ¬ë¡€êµ°',
        'ì „ë¼ë‚¨ë„ ê³ í¥êµ°', 'ì „ë¼ë‚¨ë„ ë³´ì„±êµ°', 'ì „ë¼ë‚¨ë„ í™”ìˆœêµ°', 'ì „ë¼ë‚¨ë„ ì¥í¥êµ°',
        'ì „ë¼ë‚¨ë„ ê°•ì§„êµ°', 'ì „ë¼ë‚¨ë„ í•´ë‚¨êµ°', 'ì „ë¼ë‚¨ë„ ì˜ì•”êµ°', 'ì „ë¼ë‚¨ë„ ë¬´ì•ˆêµ°',
        'ì „ë¼ë‚¨ë„ í•¨í‰êµ°', 'ì „ë¼ë‚¨ë„ ì˜ê´‘êµ°', 'ì „ë¼ë‚¨ë„ ì¥ì„±êµ°', 'ì „ë¼ë‚¨ë„ ì™„ë„êµ°',
        'ì „ë¼ë‚¨ë„ ì§„ë„êµ°', 'ì „ë¼ë‚¨ë„ ì‹ ì•ˆêµ°'
    ],
    'ê²½ìƒë¶ë„': [
        'ê²½ìƒë¶ë„ í¬í•­ì‹œ', 'ê²½ìƒë¶ë„ ê²½ì£¼ì‹œ', 'ê²½ìƒë¶ë„ ê¹€ì²œì‹œ', 'ê²½ìƒë¶ë„ ì•ˆë™ì‹œ',
        'ê²½ìƒë¶ë„ êµ¬ë¯¸ì‹œ', 'ê²½ìƒë¶ë„ ì˜ì£¼ì‹œ', 'ê²½ìƒë¶ë„ ì˜ì²œì‹œ', 'ê²½ìƒë¶ë„ ìƒì£¼ì‹œ',
        'ê²½ìƒë¶ë„ ë¬¸ê²½ì‹œ', 'ê²½ìƒë¶ë„ ê²½ì‚°ì‹œ', 'ê²½ìƒë¶ë„ êµ°ìœ„êµ°', 'ê²½ìƒë¶ë„ ì˜ì„±êµ°',
        'ê²½ìƒë¶ë„ ì²­ì†¡êµ°', 'ê²½ìƒë¶ë„ ì˜ì–‘êµ°', 'ê²½ìƒë¶ë„ ì˜ë•êµ°', 'ê²½ìƒë¶ë„ ì²­ë„êµ°',
        'ê²½ìƒë¶ë„ ê³ ë ¹êµ°', 'ê²½ìƒë¶ë„ ì„±ì£¼êµ°', 'ê²½ìƒë¶ë„ ì¹ ê³¡êµ°', 'ê²½ìƒë¶ë„ ì˜ˆì²œêµ°',
        'ê²½ìƒë¶ë„ ë´‰í™”êµ°', 'ê²½ìƒë¶ë„ ìš¸ì§„êµ°', 'ê²½ìƒë¶ë„ ìš¸ë¦‰êµ°'
    ],
    'ê²½ìƒë‚¨ë„': [
        'ê²½ìƒë‚¨ë„ ì°½ì›ì‹œ', 'ê²½ìƒë‚¨ë„ ì§„ì£¼ì‹œ', 'ê²½ìƒë‚¨ë„ í†µì˜ì‹œ', 'ê²½ìƒë‚¨ë„ ì‚¬ì²œì‹œ',
        'ê²½ìƒë‚¨ë„ ê¹€í•´ì‹œ', 'ê²½ìƒë‚¨ë„ ë°€ì–‘ì‹œ', 'ê²½ìƒë‚¨ë„ ê±°ì œì‹œ', 'ê²½ìƒë‚¨ë„ ì–‘ì‚°ì‹œ',
        'ê²½ìƒë‚¨ë„ ì˜ë ¹êµ°', 'ê²½ìƒë‚¨ë„ í•¨ì•ˆêµ°', 'ê²½ìƒë‚¨ë„ ì°½ë…•êµ°', 'ê²½ìƒë‚¨ë„ ê³ ì„±êµ°',
        'ê²½ìƒë‚¨ë„ ë‚¨í•´êµ°', 'ê²½ìƒë‚¨ë„ í•˜ë™êµ°', 'ê²½ìƒë‚¨ë„ ì‚°ì²­êµ°', 'ê²½ìƒë‚¨ë„ í•¨ì–‘êµ°',
        'ê²½ìƒë‚¨ë„ ê±°ì°½êµ°', 'ê²½ìƒë‚¨ë„ í•©ì²œêµ°'
    ],
    'ì œì£¼íŠ¹ë³„ìì¹˜ë„': [
        'ì œì£¼íŠ¹ë³„ìì¹˜ë„ ì œì£¼ì‹œ', 'ì œì£¼íŠ¹ë³„ìì¹˜ë„ ì„œê·€í¬ì‹œ'
    ]
};

// ì¤‘ë‹¨ í”Œë˜ê·¸
let isCollectionStopped = false;

// ì „ì²´ ì„ íƒ/í•´ì œ ë²„íŠ¼
document.getElementById('selectAllBtn').addEventListener('click', function() {
    document.querySelectorAll('.region-checkbox').forEach(cb => cb.checked = true);
});

document.getElementById('deselectAllBtn').addEventListener('click', function() {
    document.querySelectorAll('.region-checkbox').forEach(cb => cb.checked = false);
});

// ê·¸ë£¹ë³„ ì „ì²´ ì„ íƒ ë²„íŠ¼
document.querySelectorAll('.group-select-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const groupIndex = this.dataset.group;
        const groupCheckboxes = document.querySelectorAll(`.group-${groupIndex}`);
        const allChecked = Array.from(groupCheckboxes).every(cb => cb.checked);

        // ì „ì²´ ì„ íƒë˜ì–´ ìˆìœ¼ë©´ í•´ì œ, ì•„ë‹ˆë©´ ì „ì²´ ì„ íƒ
        groupCheckboxes.forEach(cb => cb.checked = !allChecked);

        // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
        this.textContent = allChecked ? 'ê·¸ë£¹ ì „ì²´ ì„ íƒ' : 'ê·¸ë£¹ ì „ì²´ í•´ì œ';
    });
});

// ì¤‘ë‹¨ ë²„íŠ¼ ì´ë²¤íŠ¸
document.getElementById('stopBtn').addEventListener('click', function() {
    isCollectionStopped = true;
    this.disabled = true;
    this.textContent = 'â¸ï¸ ì¤‘ë‹¨ ì¤‘...';
    addLog('ğŸ›‘ ì‚¬ìš©ìê°€ ìˆ˜ì§‘ì„ ì¤‘ë‹¨í–ˆìŠµë‹ˆë‹¤.', 'error');
});

document.getElementById('collectForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    // ì„ íƒëœ ì§€ì—­ ìˆ˜ì§‘
    const selectedRegions = Array.from(document.querySelectorAll('.region-checkbox:checked'))
        .map(cb => cb.value);

    if (selectedRegions.length === 0) {
        alert('ìµœì†Œ 1ê°œ ì´ìƒì˜ ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }

    const categorySelect = document.getElementById('category');
    const categoryId = categorySelect.value;
    const categoryNameKo = categorySelect.options[categorySelect.selectedIndex].dataset.nameKo;
    const limit = parseInt(document.getElementById('limit').value);

    // ì¤‘ë‹¨ í”Œë˜ê·¸ ì´ˆê¸°í™”
    isCollectionStopped = false;

    document.getElementById('progressContainer').style.display = 'block';
    document.getElementById('collectBtn').disabled = true;
    document.getElementById('collectBtn').textContent = 'â³ ìˆ˜ì§‘ ì¤‘...';
    document.getElementById('stopBtn').style.display = 'block';
    document.getElementById('stopBtn').disabled = false;
    document.getElementById('stopBtn').textContent = 'â¹ï¸ ìˆ˜ì§‘ ì¤‘ë‹¨';

    // ì„ íƒëœ ì§€ì—­ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©
    const regions = selectedRegions;

    // ì¹´í…Œê³ ë¦¬ ëª©ë¡ ê²°ì •
    const categories = categoryId === 'ALL'
        ? Array.from(document.querySelectorAll('#category option[data-name-ko]'))
            .filter(opt => opt.value !== 'ALL')
            .map(opt => ({id: opt.value, nameKo: opt.dataset.nameKo, placeType: opt.dataset.placeType}))
        : [{id: categoryId, nameKo: categoryNameKo, placeType: document.querySelector(`#category option[value="${categoryId}"]`)?.dataset.placeType}];

    addLog(`ğŸ“ ì§€ì—­: ${regions.length}ê³³, ì—…ì¢…: ${categories.length}ê°œ, ì§€ì—­ë‹¹ ${limit}ê°œì”© ìˆ˜ì§‘`);

    try {
        for (const targetRegion of regions) {
            // ì¤‘ë‹¨ ì²´í¬
            if (isCollectionStopped) {
                addLog('â¹ï¸ ìˆ˜ì§‘ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.', 'error');
                break;
            }

            for (const cat of categories) {
                // ì¤‘ë‹¨ ì²´í¬
                if (isCollectionStopped) {
                    addLog('â¹ï¸ ìˆ˜ì§‘ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.', 'error');
                    break;
                }

                // êµ¬/ì‹œ ì¶”ì¶œ (ì˜ˆ: "ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬" â†’ "ê°•ë‚¨êµ¬")
                const regionShort = targetRegion.split(' ').pop();
                const coordinates = REGION_COORDINATES[regionShort];

                if (!coordinates) {
                    addLog(`âŒ ${targetRegion}: ì¢Œí‘œ ì •ë³´ ì—†ìŒ`, 'error');
                    continue;
                }

                addLog(`ğŸ” ${targetRegion} - ${cat.nameKo} ê²€ìƒ‰ ì¤‘...`);

                // Google Places API í˜¸ì¶œ (í•œê¸€ ì¹´í…Œê³ ë¦¬ëª… ì‚¬ìš©)
                let places = await fetchGooglePlaces(regionShort, cat.nameKo, coordinates, limit, cat.placeType);

                addLog(`âœ… ${places.length}ê°œ ì—…ì²´ ë°œê²¬ (í•„í„°ë§ í›„)`);

                if (places.length === 0) {
                    addLog(`âš ï¸ ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ`, 'error');
                    continue;
                }

                // ê¸°ì¡´ ì—…ì²´ì˜ ìš”ì•½ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (30ì¼ ìºì‹± í™•ì¸ìš©)
                const placeIds = places.map(p => p.place_id);
                const existingBusinesses = await fetch('/api/local-businesses/?' + new URLSearchParams({
                    google_place_id__in: placeIds.join(',')
                })).then(r => r.json()).catch(() => ({results: []}));

                const existingSummaryMap = {};
                if (existingBusinesses.results) {
                    existingBusinesses.results.forEach(b => {
                        existingSummaryMap[b.google_place_id] = b.editorial_summary;
                    });
                }

                // AI ìš”ì•½ ìƒì„± (ë°°ì¹˜ ì²˜ë¦¬, ê¸°ì¡´ ìš”ì•½ ì¬ì‚¬ìš©)
                addLog(`ğŸ¤– AI ìš”ì•½ í™•ì¸/ìƒì„± ì‹œì‘... (${places.length}ê°œ ì—…ì²´)`);
                const BATCH_SIZE = 10; // 10ê°œì”© ë³‘ë ¬ ì²˜ë¦¬ (ì†ë„ ê°œì„ )

                for (let i = 0; i < places.length; i += BATCH_SIZE) {
                    // ì¤‘ë‹¨ ì²´í¬
                    if (isCollectionStopped) {
                        addLog('â¹ï¸ AI ìš”ì•½ ìƒì„±ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.', 'error');
                        break;
                    }

                    const batch = places.slice(i, i + BATCH_SIZE);

                    addLog(`â³ ë°°ì¹˜ ${Math.floor(i/BATCH_SIZE) + 1} ì²˜ë¦¬ ì¤‘... (${batch.length}ê°œ)`);

                    await Promise.all(
                        batch.map(async (place) => {
                            // ê¸°ì¡´ AI ìš”ì•½ ì¬ì‚¬ìš© ë˜ëŠ” ìƒˆë¡œ ìƒì„±
                            const existingSummary = existingSummaryMap[place.place_id];
                            const aiSummary = await generateAISummary(place, existingSummary);
                            if (aiSummary) {
                                place.editorial_summary = aiSummary;
                            }

                            // ë©”ëª¨ë¦¬ ìµœì í™”: ì²˜ë¦¬ ì™„ë£Œëœ ë¦¬ë·° ë°ì´í„° ì¦‰ì‹œ ì‚­ì œ
                            delete place.reviews;
                        })
                    );

                    addLog(`âœ… ë°°ì¹˜ ${Math.floor(i/BATCH_SIZE) + 1} ì™„ë£Œ`);

                    // ë°°ì¹˜ë§ˆë‹¤ ê°€ë¹„ì§€ ì»¬ë ‰ì…˜ íŒíŠ¸ (ë¸Œë¼ìš°ì €ê°€ ë©”ëª¨ë¦¬ ì •ë¦¬í•˜ë„ë¡)
                    if ((i + BATCH_SIZE) % 30 === 0) {
                        addLog(`ğŸ§¹ ë©”ëª¨ë¦¬ ì •ë¦¬ ì¤‘... (${i + BATCH_SIZE}ê°œ ì²˜ë¦¬ ì™„ë£Œ)`);
                        await new Promise(resolve => setTimeout(resolve, 100)); // 100ms íœ´ì‹
                    }
                }

                // ì¤‘ë‹¨ëœ ê²½ìš° ì €ì¥ ìŠ¤í‚µ
                if (isCollectionStopped) {
                    continue;
                }

                // ë°±ì—”ë“œë¡œ ì €ì¥ - popularity_scoreë¡œ ì •ë ¬ í›„ ìˆœìœ„ í• ë‹¹
                let businesses = places.map((place) => {
                    return {
                        google_place_id: place.place_id,
                        category_id: parseInt(cat.id),
                        region_name: targetRegion,
                        name: place.name,
                        address: place.formatted_address || place.vicinity,
                        phone_number: place.formatted_phone_number,
                        latitude: place.geometry.location.lat(),
                        longitude: place.geometry.location.lng(),
                        rating: place.rating,
                        review_count: place.user_ratings_total || 0,
                        google_maps_url: `https://www.google.com/maps/place/?q=place_id:${place.place_id}`,
                        photo_url: place.photos && place.photos[0] ?
                            `https://places.googleapis.com/v1/${place.photos[0].name}/media?maxWidthPx=800` : null,
                        website_url: place.website,
                        opening_hours: place.opening_hours,
                        editorial_summary: place.editorial_summary,
                        business_status: place.business_status,
                        last_review_time: place.last_review_time,
                        popularity_score: calculatePopularityScore(place.rating || 0, place.user_ratings_total || 0),
                    };
                });

                // popularity_score ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ í›„ ìˆœìœ„ í• ë‹¹
                businesses.sort((a, b) => b.popularity_score - a.popularity_score);
                businesses.forEach((business, index) => {
                    business.rank_in_region = index + 1;
                });

                // ì €ì¥ ë°ì´í„° ìš”ì•½ ë¡œê·¸
                const withSummary = businesses.filter(b => b.editorial_summary).length;
                addLog(`ğŸ“Š ì €ì¥ ì¤€ë¹„: ì´ ${businesses.length}ê°œ (AI ìš”ì•½: ${withSummary}ê°œ)`);

                addLog('ğŸ’¾ ë°±ì—”ë“œì— ì €ì¥ ì¤‘...');

                const response = await fetch('/api/local-businesses/bulk_create/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({businesses})
                });

                // ì‘ë‹µ ìƒíƒœ ì²´í¬
                if (!response.ok) {
                    const errorText = await response.text();
                    addLog(`âŒ ì˜¤ë¥˜: ì„œë²„ ì‘ë‹µ ${response.status} - ${errorText.substring(0, 200)}`, 'error');
                    continue;
                }

                const result = await response.json();

                document.getElementById('successCount').textContent =
                    parseInt(document.getElementById('successCount').textContent || 0) + result.created + result.updated;
                document.getElementById('failCount').textContent =
                    parseInt(document.getElementById('failCount').textContent || 0) + result.errors.length;
                document.getElementById('totalCount').textContent =
                    parseInt(document.getElementById('totalCount').textContent || 0) + result.total;

                addLog(`âœ… ì €ì¥ ì™„ë£Œ! ìƒì„±: ${result.created}ê°œ, ì—…ë°ì´íŠ¸: ${result.updated}ê°œ, ìŠ¤í‚µ: ${result.skipped}ê°œ`);

                if (result.errors.length > 0) {
                    result.errors.forEach(err => addLog(`âŒ ${err}`, 'error'));
                }

                // ì €ì¥ ì™„ë£Œ í›„ ë©”ëª¨ë¦¬ ì •ë¦¬
                businesses = null;
                places = null;

                // API ê³¼ë¶€í•˜ ë°©ì§€: 0.3ì´ˆ ëŒ€ê¸° (0.5ì´ˆì—ì„œ ë‹¨ì¶•)
                await new Promise(resolve => setTimeout(resolve, 300));
            }
        }

        // ìµœì¢… ë©”ëª¨ë¦¬ ì •ë¦¬
        addLog(`ğŸ§¹ ìµœì¢… ë©”ëª¨ë¦¬ ì •ë¦¬ ì¤‘...`);
        if (!isCollectionStopped) {
            addLog(`ğŸ‰ ì „ì²´ ìˆ˜ì§‘ ì™„ë£Œ!`);
        } else {
            addLog(`â¹ï¸ ìˆ˜ì§‘ì´ ì‚¬ìš©ìì— ì˜í•´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'error');
        }

    } catch (error) {
        addLog(`âŒ ì˜¤ë¥˜: ${error.message}`, 'error');
    } finally {
        document.getElementById('collectBtn').disabled = false;
        document.getElementById('collectBtn').textContent = 'ğŸš€ ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘';
        document.getElementById('stopBtn').style.display = 'none';
    }
});

async function fetchGooglePlaces(city, category, coordinates, maxResults, placeType = null) {
    // ë°±ì—”ë“œ í”„ë¡ì‹œë¥¼ í†µí•´ Google API í˜¸ì¶œ (CORS ìš°íšŒ)
    const proxyUrl = '/api/local-businesses/google-search-proxy/';

    // ì§€ì—­ëª… ê°„ì†Œí™”: "ê²½ê¸°ë„ í•˜ë‚¨ì‹œ" â†’ "í•˜ë‚¨ì‹œ", "ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬" â†’ "ê°•ë‚¨êµ¬"
    const shortCityName = city.split(' ').pop();

    // Text Searchë¡œ ê²€ìƒ‰í•  íƒ€ì… ëª©ë¡ (cleaning_service, moving_companyëŠ” íƒ€ì… ë¯¸ì§€ì› ë˜ëŠ” ë¶€ì •í™•)
    const textSearchTypes = ['interior_designer', 'cleaning_service', 'moving_company'];
    const useTextSearch = !placeType || textSearchTypes.includes(placeType);

    // ì—…ì¢…ë³„ ê²€ìƒ‰ì–´ ì„¤ì •
    let searchQuery = `${shortCityName} ${category}`;
    if (placeType === 'cleaning_service') {
        searchQuery = `${shortCityName} ì²­ì†Œ ì—…ì²´`;
    } else if (placeType === 'moving_company') {
        searchQuery = `${shortCityName} ì´ì‚¬ ì—…ì²´`;
    }

    const requestBody = useTextSearch ? {
        // Text Search API (ì²­ì†Œ, ì´ì‚¬, ì¸í…Œë¦¬ì–´ ë“±)
        textQuery: searchQuery,
        languageCode: 'ko',
        locationBias: {
            circle: {
                center: {
                    latitude: coordinates.latitude,
                    longitude: coordinates.longitude
                },
                radius: 5000.0
            }
        },
        maxResultCount: maxResults
    } : {
        // Nearby Search API (ì—…ì¢… íƒ€ì… ì§€ì›ë¨)
        includedTypes: [placeType],
        languageCode: 'ko',
        locationRestriction: {
            circle: {
                center: {
                    latitude: coordinates.latitude,
                    longitude: coordinates.longitude
                },
                radius: 5000.0
            }
        },
        maxResultCount: maxResults
    };

    // useTextSearchê°€ trueë©´ Text Search, falseë©´ Nearby Search

    const response = await fetch(proxyUrl, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
        },
        body: JSON.stringify(requestBody)
    });

    if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`Google API í”„ë¡ì‹œ ì˜¤ë¥˜: ${response.status} - ${errorText}`);
    }

    const data = await response.json();

    if (!data.places || data.places.length === 0) {
        return [];
    }

    // í•„í„°ë§: íì—… ì—…ì²´, ì—°ë½ì²˜ ì—†ëŠ” ì—…ì²´, ë¦¬ë·° ì—†ëŠ” ì—…ì²´, 2ë…„ ì´ìƒ ë¦¬ë·° ì—†ëŠ” ì—…ì²´ ì œì™¸
    const TWO_YEARS_MS = 2 * 365 * 24 * 60 * 60 * 1000;
    const filteredPlaces = data.places.filter(place => {
        // íì—…í•œ ê³³ ì œì™¸
        if (place.businessStatus === 'CLOSED_PERMANENTLY') {
            addLog(`âš ï¸ ${place.displayName.text}: íì—… (ì œì™¸)`, 'error');
            return false;
        }

        // ì—°ë½ì²˜ ì—†ëŠ” ì—…ì²´ ì œì™¸
        if (!place.internationalPhoneNumber) {
            addLog(`âš ï¸ ${place.displayName.text}: ì—°ë½ì²˜ ì—†ìŒ (ì œì™¸)`, 'error');
            return false;
        }

        // ë¦¬ë·° í•„í„° ì™„ì „ ì œê±°
        // ë³€í˜¸ì‚¬, ì„¸ë¬´ì‚¬, íšŒê³„ì‚¬ ë“± ì „ë¬¸ì§ì€ ë¦¬ë·°ê°€ ê±°ì˜ ì—†ìŒ
        // editorialSummary(êµ¬ê¸€ ì—…ì²´ ì†Œê°œ)ë¥¼ ëŒ€ì‹  í™œìš©

        // ì£¼ì†Œ ê²€ì¦: ê²€ìƒ‰í•œ ì§€ì—­ëª…ì´ ì‹¤ì œ ì£¼ì†Œì— í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
        if (place.formattedAddress && city) {
            // "ê°•ë‚¨êµ¬", "ë…¸ì›êµ¬" ë“±ì—ì„œ "êµ¬"ë¥¼ ì œê±°í•œ ìˆœìˆ˜ ì§€ì—­ëª… ì¶”ì¶œ
            const cityName = city.replace(/ì‹œ$|êµ¬$|êµ°$/g, '');
            if (!place.formattedAddress.includes(cityName)) {
                addLog(`âš ï¸ ${place.displayName.text}: ì£¼ì†Œ ë¶ˆì¼ì¹˜ (${place.formattedAddress.substring(0, 20)}... â‰  ${city})`, 'error');
                return false;
            }
        }

        return true;
    });

    // í”„ë¡ íŠ¸ì—”ë“œ ë­í‚¹ í˜•ì‹ìœ¼ë¡œ ë³€í™˜ (ë¦¬ë·° ë°ì´í„° í¬í•¨)
    return filteredPlaces.map(place => {
        return {
            place_id: place.id,
            name: place.displayName.text,
            formatted_address: place.formattedAddress,
            vicinity: place.formattedAddress,
            formatted_phone_number: place.internationalPhoneNumber,
            rating: place.rating,
            user_ratings_total: place.userRatingCount,
            geometry: {
                location: {
                    lat: () => place.location.latitude,
                    lng: () => place.location.longitude
                }
            },
            photos: place.photos ? place.photos.map(photo => ({
                name: photo.name,
                // Photo URLì€ ì§ì ‘ ìƒì„± (API í‚¤ ë…¸ì¶œ ë°©ì§€ë¥¼ ìœ„í•´ ì„ì‹œ í”Œë ˆì´ìŠ¤í™€ë” ì‚¬ìš©)
                getUrl: (opts) => `https://places.googleapis.com/v1/${photo.name}/media?maxWidthPx=${opts.maxWidth}&key=BACKEND_WILL_HANDLE`
            })) : null,
            website: place.websiteUri,
            opening_hours: place.regularOpeningHours?.weekdayDescriptions,
            editorial_summary: place.editorialSummary?.text || null,  // Google ì œê³µ ì—…ì²´ ì†Œê°œ
            business_status: place.businessStatus || 'OPERATIONAL',
            last_review_time: place.reviews && place.reviews.length > 0 ? place.reviews[0].publishTime : null,
            reviews: place.reviews // ë¦¬ë·° ë°ì´í„° ì¶”ê°€ (AI ìš”ì•½ìš©)
        };
    });
}

function calculatePopularityScore(rating, reviewCount) {
    const C = 10;
    const m = 4.0;
    const adjustedRating = (C * m + reviewCount * rating) / (C + reviewCount);
    return adjustedRating * Math.log10(reviewCount + 1);
}

async function generateAISummary(place, existingSummary = null) {
    // ê¸°ì¡´ AI ìš”ì•½ì´ ìˆìœ¼ë©´ ì¬ì‚¬ìš© (30ì¼ ìºì‹±)
    if (existingSummary) {
        addLog(`â™»ï¸ ${place.name}: ê¸°ì¡´ AI ìš”ì•½ ì¬ì‚¬ìš© (í† í° ì ˆì•½)`, 'info');
        return existingSummary;
    }

    // Google editorialSummaryê°€ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš© (ë¦¬ë·°ë³´ë‹¤ ì‹ ë¢°ì„± ë†’ìŒ)
    if (place.editorial_summary) {
        addLog(`ğŸ“ ${place.name}: Google ì—…ì²´ ì†Œê°œ ì‚¬ìš©`, 'info');
        return place.editorial_summary;
    }

    // editorialSummaryë„ ì—†ê³  ë¦¬ë·°ë„ ì—†ìœ¼ë©´ null ë°˜í™˜
    if (!place.reviews || place.reviews.length === 0) {
        addLog(`âš ï¸ ${place.name}: ë¦¬ë·°/ì—…ì²´ì†Œê°œ ì—†ìŒ`, 'error');
        return null;
    }

    try {
        addLog(`ğŸ¤– ${place.name}: AI ìš”ì•½ ìƒì„± ì¤‘...`, 'info');

        // ë¦¬ë·° ë°ì´í„° í¬ë§·íŒ…
        const reviewsData = place.reviews.map(review => ({
            text: review.text?.text || '',
            rating: review.rating || 0
        }));

        // Django ë°±ì—”ë“œ API í˜¸ì¶œ
        const response = await fetch('/api/local-businesses/generate_summary/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                business_name: place.name,
                reviews: reviewsData
            })
        });

        if (response.ok) {
            const data = await response.json();
            if (data.success && data.summary) {
                addLog(`âœ… ${place.name}: AI ìš”ì•½ ìƒì„± ì™„ë£Œ`, 'success');
                return data.summary;
            } else {
                addLog(`âš ï¸ ${place.name}: ${data.error || 'AI ìš”ì•½ ìƒì„± ì‹¤íŒ¨'}`, 'error');
                return null;
            }
        } else {
            const errorData = await response.json().catch(() => ({}));
            addLog(`âš ï¸ ${place.name}: API ì˜¤ë¥˜ (${response.status}) - ${errorData.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`, 'error');
            return null;
        }

    } catch (error) {
        console.error('AI ìš”ì•½ ìƒì„± ì˜¤ë¥˜:', error);
        addLog(`âŒ ${place.name}: ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ - ${error.message}`, 'error');
        return null;
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function addLog(message, type = 'info') {
    const logContainer = document.getElementById('logContainer');
    const color = type === 'error' ? '#f44336' : type === 'success' ? '#4CAF50' : '#666';

    // DOM ìš”ì†Œ ìƒì„± (innerHTMLë³´ë‹¤ ì„±ëŠ¥ ì¢‹ìŒ)
    const logLine = document.createElement('div');
    logLine.style.color = color;
    logLine.textContent = message;
    logContainer.appendChild(logLine);

    // ì¦‰ì‹œ ìŠ¤í¬ë¡¤ (ë¡œê·¸ê°€ ë¹ ë¥´ê²Œ ì¶”ê°€ë  ë•Œ ë”°ë¼ê°€ê¸° ìœ„í•¨)
    requestAnimationFrame(() => {
        logContainer.scrollTop = logContainer.scrollHeight;
    });

    // ë¡œê·¸ ê°œìˆ˜ ì œí•œ (ë©”ëª¨ë¦¬ ê´€ë¦¬)
    if (logContainer.children.length > 500) {
        // ì˜¤ë˜ëœ ë¡œê·¸ 100ê°œ ì œê±°
        for (let i = 0; i < 100; i++) {
            logContainer.removeChild(logContainer.firstChild);
        }
    }
}
</script>
{% endblock %}
