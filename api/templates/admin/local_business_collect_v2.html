{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}ì§€ì—­ ì—…ì²´ ì •ë³´ ìˆ˜ì§‘ (Google API){% endblock %}

{% block extrahead %}
<!-- Google Maps API ë¶ˆí•„ìš” - Fetch APIë¡œ ì§ì ‘ í˜¸ì¶œ -->
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">í™ˆ</a>
    &rsaquo; <a href="{% url 'admin:api_localbusiness_changelist' %}">ì§€ì—­ ì—…ì²´</a>
    &rsaquo; ë°ì´í„° ìˆ˜ì§‘ (Google API)
</div>
{% endblock %}

{% block content %}
<div style="max-width: 800px; margin: 20px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
    <h1 style="margin-bottom: 20px;">ğŸ—ºï¸ ì§€ì—­ ì—…ì²´ ì •ë³´ ìˆ˜ì§‘ (Google Places API)</h1>

    <div style="background: #e7f3ff; border: 1px solid #2196F3; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
        <strong>â„¹ï¸ ì•ˆë‚´</strong>
        <ul style="margin: 10px 0 0 20px;">
            <li>ë¸Œë¼ìš°ì €ì—ì„œ ì§ì ‘ Google Places APIë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤</li>
            <li>í”„ë¡ íŠ¸ì—”ë“œ í™˜ê²½ë³€ìˆ˜ì— ì„¤ì •ëœ API í‚¤ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤</li>
            <li>ë­í‚¹ í˜ì´ì§€ì™€ ë™ì¼í•œ ë°©ì‹ì…ë‹ˆë‹¤</li>
        </ul>
    </div>

    <form id="collectForm" style="margin-top: 20px;">
        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 10px; font-weight: bold;">ì§€ì—­ ì„ íƒ (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥)</label>

            <div style="border: 1px solid #ddd; border-radius: 4px; padding: 15px;">
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                    <label style="display: flex; align-items: center; cursor: pointer; padding: 10px; border: 1px solid #e0e0e0; border-radius: 4px; background: #fafafa;">
                        <input type="checkbox" name="provinces" value="ì„œìš¸ ê°•ë‚¨/ì„œì´ˆ" class="province-checkbox" style="margin-right: 8px; width: 16px; height: 16px; cursor: pointer;">
                        <span style="font-weight: 500;">ì„œìš¸ ê°•ë‚¨/ì„œì´ˆ</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; padding: 10px; border: 1px solid #e0e0e0; border-radius: 4px; background: #fafafa;">
                        <input type="checkbox" name="provinces" value="ì„œìš¸ ê°•ì„œ/ì–‘ì²œ" class="province-checkbox" style="margin-right: 8px; width: 16px; height: 16px; cursor: pointer;">
                        <span style="font-weight: 500;">ì„œìš¸ ê°•ì„œ/ì–‘ì²œ</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; padding: 10px; border: 1px solid #e0e0e0; border-radius: 4px; background: #fafafa;">
                        <input type="checkbox" name="provinces" value="ì„œìš¸ ê°•ë¶/ë…¸ì›" class="province-checkbox" style="margin-right: 8px; width: 16px; height: 16px; cursor: pointer;">
                        <span style="font-weight: 500;">ì„œìš¸ ê°•ë¶/ë…¸ì›</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; padding: 10px; border: 1px solid #e0e0e0; border-radius: 4px; background: #fafafa;">
                        <input type="checkbox" name="provinces" value="ì„œìš¸ ë™ë¶€" class="province-checkbox" style="margin-right: 8px; width: 16px; height: 16px; cursor: pointer;">
                        <span style="font-weight: 500;">ì„œìš¸ ë™ë¶€</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; padding: 10px; border: 1px solid #e0e0e0; border-radius: 4px; background: #fafafa;">
                        <input type="checkbox" name="provinces" value="ì„œìš¸ ì¤‘ë¶€/ì„œë¶€" class="province-checkbox" style="margin-right: 8px; width: 16px; height: 16px; cursor: pointer;">
                        <span style="font-weight: 500;">ì„œìš¸ ì¤‘ë¶€/ì„œë¶€</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; padding: 10px; border: 1px solid #e0e0e0; border-radius: 4px; background: #fafafa;">
                        <input type="checkbox" name="provinces" value="ì„œìš¸ ê´€ì•…/ë™ì‘" class="province-checkbox" style="margin-right: 8px; width: 16px; height: 16px; cursor: pointer;">
                        <span style="font-weight: 500;">ì„œìš¸ ê´€ì•…/ë™ì‘</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; padding: 10px; border: 1px solid #e0e0e0; border-radius: 4px; background: #fafafa;">
                        <input type="checkbox" name="provinces" value="ê²½ê¸° ë¶ë¶€" class="province-checkbox" style="margin-right: 8px; width: 16px; height: 16px; cursor: pointer;">
                        <span style="font-weight: 500;">ê²½ê¸° ë¶ë¶€</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; padding: 10px; border: 1px solid #e0e0e0; border-radius: 4px; background: #fafafa;">
                        <input type="checkbox" name="provinces" value="ê²½ê¸° ë‚¨ë¶€" class="province-checkbox" style="margin-right: 8px; width: 16px; height: 16px; cursor: pointer;">
                        <span style="font-weight: 500;">ê²½ê¸° ë‚¨ë¶€</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; padding: 10px; border: 1px solid #e0e0e0; border-radius: 4px; background: #fafafa;">
                        <input type="checkbox" name="provinces" value="ì¶©ì²­ë¶ë„" class="province-checkbox" style="margin-right: 8px; width: 16px; height: 16px; cursor: pointer;">
                        <span style="font-weight: 500;">ì¶©ë¶</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; padding: 10px; border: 1px solid #e0e0e0; border-radius: 4px; background: #fafafa;">
                        <input type="checkbox" name="provinces" value="ì¶©ì²­ë‚¨ë„" class="province-checkbox" style="margin-right: 8px; width: 16px; height: 16px; cursor: pointer;">
                        <span style="font-weight: 500;">ì¶©ë‚¨</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; padding: 10px; border: 1px solid #e0e0e0; border-radius: 4px; background: #fafafa;">
                        <input type="checkbox" name="provinces" value="ì „ë¼ë¶ë„" class="province-checkbox" style="margin-right: 8px; width: 16px; height: 16px; cursor: pointer;">
                        <span style="font-weight: 500;">ì „ë¶</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; padding: 10px; border: 1px solid #e0e0e0; border-radius: 4px; background: #fafafa;">
                        <input type="checkbox" name="provinces" value="ì „ë¼ë‚¨ë„" class="province-checkbox" style="margin-right: 8px; width: 16px; height: 16px; cursor: pointer;">
                        <span style="font-weight: 500;">ì „ë‚¨</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; padding: 10px; border: 1px solid #e0e0e0; border-radius: 4px; background: #fafafa;">
                        <input type="checkbox" name="provinces" value="ê²½ìƒë¶ë„" class="province-checkbox" style="margin-right: 8px; width: 16px; height: 16px; cursor: pointer;">
                        <span style="font-weight: 500;">ê²½ë¶</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; padding: 10px; border: 1px solid #e0e0e0; border-radius: 4px; background: #fafafa;">
                        <input type="checkbox" name="provinces" value="ê²½ìƒë‚¨ë„" class="province-checkbox" style="margin-right: 8px; width: 16px; height: 16px; cursor: pointer;">
                        <span style="font-weight: 500;">ê²½ë‚¨</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; padding: 10px; border: 1px solid #e0e0e0; border-radius: 4px; background: #fafafa;">
                        <input type="checkbox" name="provinces" value="ì œì£¼íŠ¹ë³„ìì¹˜ë„" class="province-checkbox" style="margin-right: 8px; width: 16px; height: 16px; cursor: pointer;">
                        <span style="font-weight: 500;">ì œì£¼</span>
                    </label>
                </div>
            </div>
        </div>

        <div style="margin-bottom: 20px;">
            <label for="category" style="display: block; margin-bottom: 5px; font-weight: bold;">ì—…ì¢… ì„ íƒ</label>
            <select name="category" id="category" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" required>
                <option value="">-- ì—…ì¢… ì„ íƒ --</option>
                <option value="ALL" data-name-en="ALL" data-place-type="ALL" style="font-weight: bold; background: #e3f2fd;">ğŸ“‹ ì „ì²´ ì—…ì¢… ({{ categories|length }}ê°œ)</option>
                {% for cat in categories %}
                <option value="{{ cat.id }}" data-name-en="{{ cat.name_en }}" data-place-type="{{ cat.google_place_type }}">{{ cat.icon }} {{ cat.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div style="margin-bottom: 20px;">
            <label for="limit" style="display: block; margin-bottom: 5px; font-weight: bold;">ìˆ˜ì§‘ ê°œìˆ˜</label>
            <input type="number" name="limit" id="limit" value="5" min="1" max="20"
                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        </div>

        <button type="submit" id="collectBtn"
                style="width: 100%; padding: 12px 24px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: bold;">
            ğŸš€ ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘
        </button>
        <button type="button" id="stopBtn"
                style="display: none; width: 100%; padding: 12px 24px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: bold; margin-top: 10px;">
            â¹ï¸ ìˆ˜ì§‘ ì¤‘ë‹¨
        </button>
    </form>

    <div id="progressContainer" style="display: none; margin-top: 30px; padding: 20px; background: #f5f5f5; border-radius: 8px;">
        <h3 style="margin-bottom: 15px;">ğŸ“Š ìˆ˜ì§‘ ì§„í–‰ ìƒí™©</h3>

        <div style="background: white; padding: 15px; border-radius: 4px; margin-bottom: 15px;">
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center;">
                <div>
                    <div style="font-size: 24px; font-weight: bold; color: #4CAF50;" id="successCount">0</div>
                    <div style="color: #666; font-size: 12px;">ì„±ê³µ</div>
                </div>
                <div>
                    <div style="font-size: 24px; font-weight: bold; color: #f44336;" id="failCount">0</div>
                    <div style="color: #666; font-size: 12px;">ì‹¤íŒ¨</div>
                </div>
                <div>
                    <div style="font-size: 24px; font-weight: bold; color: #2196F3;" id="totalCount">0</div>
                    <div style="color: #666; font-size: 12px;">ì´</div>
                </div>
            </div>
        </div>

        <div style="background: white; padding: 15px; border-radius: 4px; max-height: 300px; overflow-y: auto;">
            <h4 style="margin-bottom: 10px;">ì‹¤ì‹œê°„ ë¡œê·¸</h4>
            <div id="logContainer" style="font-family: monospace; font-size: 12px; line-height: 1.6;"></div>
        </div>
    </div>
</div>

<script>
// ì§€ì—­ë³„ ì¢Œí‘œ
const REGION_COORDINATES = {
    // ì„œìš¸íŠ¹ë³„ì‹œ 25ê°œ êµ¬
    'ê°•ë‚¨êµ¬': {latitude: 37.5172, longitude: 127.0473},
    'ê°•ë™êµ¬': {latitude: 37.5301, longitude: 127.1238},
    'ê°•ë¶êµ¬': {latitude: 37.6398, longitude: 127.0256},
    'ê°•ì„œêµ¬': {latitude: 37.5509, longitude: 126.8495},
    'ê´€ì•…êµ¬': {latitude: 37.4784, longitude: 126.9516},
    'ê´‘ì§„êµ¬': {latitude: 37.5384, longitude: 127.0822},
    'êµ¬ë¡œêµ¬': {latitude: 37.4954, longitude: 126.8874},
    'ê¸ˆì²œêµ¬': {latitude: 37.4519, longitude: 126.9020},
    'ë…¸ì›êµ¬': {latitude: 37.6542, longitude: 127.0568},
    'ë„ë´‰êµ¬': {latitude: 37.6688, longitude: 127.0471},
    'ë™ëŒ€ë¬¸êµ¬': {latitude: 37.5744, longitude: 127.0399},
    'ë™ì‘êµ¬': {latitude: 37.5124, longitude: 126.9393},
    'ë§ˆí¬êµ¬': {latitude: 37.5663, longitude: 126.9019},
    'ì„œëŒ€ë¬¸êµ¬': {latitude: 37.5791, longitude: 126.9368},
    'ì„œì´ˆêµ¬': {latitude: 37.4837, longitude: 127.0324},
    'ì„±ë™êµ¬': {latitude: 37.5634, longitude: 127.0369},
    'ì„±ë¶êµ¬': {latitude: 37.5894, longitude: 127.0167},
    'ì†¡íŒŒêµ¬': {latitude: 37.5145, longitude: 127.1059},
    'ì–‘ì²œêµ¬': {latitude: 37.5170, longitude: 126.8664},
    'ì˜ë“±í¬êµ¬': {latitude: 37.5264, longitude: 126.8963},
    'ìš©ì‚°êµ¬': {latitude: 37.5326, longitude: 126.9900},
    'ì€í‰êµ¬': {latitude: 37.6027, longitude: 126.9291},
    'ì¢…ë¡œêµ¬': {latitude: 37.5735, longitude: 126.9791},
    'ì¤‘êµ¬': {latitude: 37.5641, longitude: 126.9979},
    'ì¤‘ë‘êµ¬': {latitude: 37.6063, longitude: 127.0929},

    // ê²½ê¸°ë„ ì£¼ìš” ì‹œ
    'ì„±ë‚¨ì‹œ': {latitude: 37.4201, longitude: 127.1262},
    'ìˆ˜ì›ì‹œ': {latitude: 37.2636, longitude: 127.0286},
    'ê³ ì–‘ì‹œ': {latitude: 37.6584, longitude: 126.8320},
    'ìš©ì¸ì‹œ': {latitude: 37.2410, longitude: 127.1776},
    'ë¶€ì²œì‹œ': {latitude: 37.5034, longitude: 126.7660},
    'ì•ˆì‚°ì‹œ': {latitude: 37.3219, longitude: 126.8309},
    'ì•ˆì–‘ì‹œ': {latitude: 37.3943, longitude: 126.9568},
    'ë‚¨ì–‘ì£¼ì‹œ': {latitude: 37.6360, longitude: 127.2166},
    'í™”ì„±ì‹œ': {latitude: 37.1990, longitude: 126.8312},
    'í‰íƒì‹œ': {latitude: 36.9922, longitude: 127.1129},
    'ì˜ì •ë¶€ì‹œ': {latitude: 37.7382, longitude: 127.0338},
    'ì‹œí¥ì‹œ': {latitude: 37.3800, longitude: 126.8028},
    'íŒŒì£¼ì‹œ': {latitude: 37.7608, longitude: 126.7800},
    'ê¹€í¬ì‹œ': {latitude: 37.6152, longitude: 126.7159},
    'ê´‘ëª…ì‹œ': {latitude: 37.4786, longitude: 126.8644},
    'ê´‘ì£¼ì‹œ': {latitude: 37.4295, longitude: 127.2551},
    'êµ°í¬ì‹œ': {latitude: 37.3617, longitude: 126.9352},
    'í•˜ë‚¨ì‹œ': {latitude: 37.5400, longitude: 127.2015},
    'ì˜¤ì‚°ì‹œ': {latitude: 37.1498, longitude: 127.0773},
    'ì–‘ì£¼ì‹œ': {latitude: 37.7853, longitude: 127.0458},
    'ì´ì²œì‹œ': {latitude: 37.2720, longitude: 127.4351},
    'êµ¬ë¦¬ì‹œ': {latitude: 37.5943, longitude: 127.1296},
    'ì•ˆì„±ì‹œ': {latitude: 37.0079, longitude: 127.2797},
    'í¬ì²œì‹œ': {latitude: 37.8950, longitude: 127.2004},
    'ì˜ì™•ì‹œ': {latitude: 37.3449, longitude: 126.9684},
    'ì—¬ì£¼ì‹œ': {latitude: 37.2984, longitude: 127.6377},
    'ë™ë‘ì²œì‹œ': {latitude: 37.9034, longitude: 127.0606},
    'ê³¼ì²œì‹œ': {latitude: 37.4292, longitude: 126.9879},
    'ê°€í‰êµ°': {latitude: 37.8314, longitude: 127.5095},
    'ì—°ì²œêµ°': {latitude: 38.0969, longitude: 127.0753},

    // ì¶©ì²­ë¶ë„
    'ì²­ì£¼ì‹œ': {latitude: 36.6424, longitude: 127.4890},
    'ì¶©ì£¼ì‹œ': {latitude: 36.9910, longitude: 127.9260},
    'ì œì²œì‹œ': {latitude: 37.1326, longitude: 128.1911},
    'ìŒì„±êµ°': {latitude: 36.9402, longitude: 127.6923},
    'ì§„ì²œêµ°': {latitude: 36.8554, longitude: 127.4360},
    'ê´´ì‚°êµ°': {latitude: 36.8156, longitude: 127.7870},
    'ì¦í‰êµ°': {latitude: 36.7848, longitude: 127.5821},
    'ë‹¨ì–‘êµ°': {latitude: 36.9845, longitude: 128.3657},
    'ë³´ì€êµ°': {latitude: 36.4895, longitude: 127.7296},
    'ì˜¥ì²œêµ°': {latitude: 36.3014, longitude: 127.5718},
    'ì˜ë™êµ°': {latitude: 36.1751, longitude: 127.7834},

    // ì¶©ì²­ë‚¨ë„
    'ì²œì•ˆì‹œ': {latitude: 36.8151, longitude: 127.1139},
    'ì•„ì‚°ì‹œ': {latitude: 36.7898, longitude: 127.0020},
    'ì„œì‚°ì‹œ': {latitude: 36.7847, longitude: 126.4503},
    'ë…¼ì‚°ì‹œ': {latitude: 36.1871, longitude: 127.0989},
    'ê³„ë£¡ì‹œ': {latitude: 36.2743, longitude: 127.2488},
    'ë‹¹ì§„ì‹œ': {latitude: 36.8930, longitude: 126.6470},
    'ê³µì£¼ì‹œ': {latitude: 36.4465, longitude: 127.1189},
    'ë³´ë ¹ì‹œ': {latitude: 36.3334, longitude: 126.6128},
    'ê¸ˆì‚°êµ°': {latitude: 36.1088, longitude: 127.4882},
    'ë¶€ì—¬êµ°': {latitude: 36.2756, longitude: 126.9099},
    'ì„œì²œêµ°': {latitude: 36.0803, longitude: 126.6919},
    'ì²­ì–‘êµ°': {latitude: 36.4592, longitude: 126.8024},
    'í™ì„±êµ°': {latitude: 36.6012, longitude: 126.6650},
    'ì˜ˆì‚°êµ°': {latitude: 36.6816, longitude: 126.8469},
    'íƒœì•ˆêµ°': {latitude: 36.7456, longitude: 126.2981},

    // ì „ë¼ë¶ë„
    'ì „ì£¼ì‹œ': {latitude: 35.8242, longitude: 127.1480},
    'êµ°ì‚°ì‹œ': {latitude: 35.9676, longitude: 126.7366},
    'ìµì‚°ì‹œ': {latitude: 35.9483, longitude: 126.9575},
    'ì •ìì‹œ': {latitude: 35.5697, longitude: 126.8560},
    'ë‚¨ì›ì‹œ': {latitude: 35.4164, longitude: 127.3903},
    'ê¹€ì œì‹œ': {latitude: 35.8031, longitude: 126.8809},
    'ì™„ì£¼êµ°': {latitude: 35.9050, longitude: 127.1644},
    'ì§„ì•ˆêµ°': {latitude: 35.7918, longitude: 127.4247},
    'ë¬´ì£¼êµ°': {latitude: 36.0072, longitude: 127.6608},
    'ì¥ìˆ˜êµ°': {latitude: 35.6478, longitude: 127.5215},
    'ì„ì‹¤êµ°': {latitude: 35.6176, longitude: 127.2899},
    'ìˆœì°½êµ°': {latitude: 35.3742, longitude: 127.1377},
    'ê³ ì°½êµ°': {latitude: 35.4354, longitude: 126.7020},
    'ë¶€ì•ˆêµ°': {latitude: 35.7319, longitude: 126.7333},

    // ì „ë¼ë‚¨ë„
    'ëª©í¬ì‹œ': {latitude: 34.8118, longitude: 126.3922},
    'ì—¬ìˆ˜ì‹œ': {latitude: 34.7604, longitude: 127.6622},
    'ìˆœì²œì‹œ': {latitude: 34.9506, longitude: 127.4872},
    'ë‚˜ì£¼ì‹œ': {latitude: 35.0160, longitude: 126.7107},
    'ê´‘ì–‘ì‹œ': {latitude: 34.9406, longitude: 127.6956},
    'ë‹´ì–‘êµ°': {latitude: 35.3208, longitude: 126.9882},
    'ê³¡ì„±êµ°': {latitude: 35.2818, longitude: 127.2925},
    'êµ¬ë¡€êµ°': {latitude: 35.2023, longitude: 127.4632},
    'ê³ í¥êµ°': {latitude: 34.6113, longitude: 127.2754},
    'ë³´ì„±êµ°': {latitude: 34.7713, longitude: 127.0800},
    'í™”ìˆœêµ°': {latitude: 35.0641, longitude: 126.9866},
    'ì¥í¥êµ°': {latitude: 34.6815, longitude: 126.9068},
    'ê°•ì§„êµ°': {latitude: 34.6420, longitude: 126.7672},
    'í•´ë‚¨êµ°': {latitude: 34.5733, longitude: 126.5989},
    'ì˜ì•”êµ°': {latitude: 34.8003, longitude: 126.6967},
    'ë¬´ì•ˆêµ°': {latitude: 34.9904, longitude: 126.4819},
    'í•¨í‰êµ°': {latitude: 35.0664, longitude: 126.5166},
    'ì˜ê´‘êµ°': {latitude: 35.2772, longitude: 126.5119},
    'ì¥ì„±êµ°': {latitude: 35.3018, longitude: 126.7844},
    'ì™„ë„êµ°': {latitude: 34.3114, longitude: 126.7551},
    'ì§„ë„êµ°': {latitude: 34.4868, longitude: 126.2633},
    'ì‹ ì•ˆêµ°': {latitude: 34.8267, longitude: 126.1080},

    // ê²½ìƒë¶ë„
    'í¬í•­ì‹œ': {latitude: 36.0190, longitude: 129.3435},
    'ê²½ì£¼ì‹œ': {latitude: 35.8562, longitude: 129.2247},
    'ê¹€ì²œì‹œ': {latitude: 36.1400, longitude: 128.1139},
    'ì•ˆë™ì‹œ': {latitude: 36.5684, longitude: 128.7294},
    'êµ¬ë¯¸ì‹œ': {latitude: 36.1195, longitude: 128.3445},
    'ì˜ì£¼ì‹œ': {latitude: 36.8056, longitude: 128.6239},
    'ì˜ì²œì‹œ': {latitude: 35.9733, longitude: 128.9386},
    'ìƒì£¼ì‹œ': {latitude: 36.4109, longitude: 128.1590},
    'ë¬¸ê²½ì‹œ': {latitude: 36.5865, longitude: 128.1867},
    'ê²½ì‚°ì‹œ': {latitude: 35.8250, longitude: 128.7414},
    'êµ°ìœ„êµ°': {latitude: 36.2424, longitude: 128.5726},
    'ì˜ì„±êµ°': {latitude: 36.3526, longitude: 128.6973},
    'ì²­ì†¡êµ°': {latitude: 36.4363, longitude: 129.0571},
    'ì˜ì–‘êµ°': {latitude: 36.6666, longitude: 129.1124},
    'ì˜ë•êµ°': {latitude: 36.4151, longitude: 129.3657},
    'ì²­ë„êµ°': {latitude: 35.6476, longitude: 128.7363},
    'ê³ ë ¹êµ°': {latitude: 35.7273, longitude: 128.2629},
    'ì„±ì£¼êµ°': {latitude: 35.9196, longitude: 128.2826},
    'ì¹ ê³¡êµ°': {latitude: 35.9954, longitude: 128.4018},
    'ì˜ˆì²œêµ°': {latitude: 36.6566, longitude: 128.4525},
    'ë´‰í™”êµ°': {latitude: 36.8930, longitude: 128.7323},
    'ìš¸ì§„êµ°': {latitude: 36.9930, longitude: 129.4006},
    'ìš¸ë¦‰êµ°': {latitude: 37.4845, longitude: 130.9058},

    // ê²½ìƒë‚¨ë„
    'ì°½ì›ì‹œ': {latitude: 35.2281, longitude: 128.6811},
    'ì§„ì£¼ì‹œ': {latitude: 35.1800, longitude: 128.1076},
    'í†µì˜ì‹œ': {latitude: 34.8544, longitude: 128.4332},
    'ì‚¬ì²œì‹œ': {latitude: 35.0036, longitude: 128.0642},
    'ê¹€í•´ì‹œ': {latitude: 35.2285, longitude: 128.8894},
    'ë°€ì–‘ì‹œ': {latitude: 35.5038, longitude: 128.7465},
    'ê±°ì œì‹œ': {latitude: 34.8806, longitude: 128.6214},
    'ì–‘ì‚°ì‹œ': {latitude: 35.3350, longitude: 129.0374},
    'ì˜ë ¹êµ°': {latitude: 35.3222, longitude: 128.2617},
    'í•¨ì•ˆêµ°': {latitude: 35.2723, longitude: 128.4064},
    'ì°½ë…•êµ°': {latitude: 35.5445, longitude: 128.4923},
    'ê³ ì„±êµ°': {latitude: 34.9732, longitude: 128.3226},
    'ë‚¨í•´êµ°': {latitude: 34.8376, longitude: 127.8924},
    'í•˜ë™êµ°': {latitude: 35.0673, longitude: 127.7513},
    'ì‚°ì²­êµ°': {latitude: 35.4152, longitude: 127.8734},
    'í•¨ì–‘êµ°': {latitude: 35.5204, longitude: 127.7252},
    'ê±°ì°½êµ°': {latitude: 35.6869, longitude: 127.9095},
    'í•©ì²œêµ°': {latitude: 35.5664, longitude: 128.1656},

    // ì œì£¼íŠ¹ë³„ìì¹˜ë„
    'ì œì£¼ì‹œ': {latitude: 33.4996, longitude: 126.5312},
    'ì„œê·€í¬ì‹œ': {latitude: 33.2541, longitude: 126.5601}
};

// ì‹œ/ë„ë³„ í•˜ë¶€ ì§€ì—­ ë§¤í•‘ (ì„¸ë¶„í™”)
const PROVINCE_TO_REGIONS = {
    'ì„œìš¸ ê°•ë‚¨/ì„œì´ˆ': [
        'ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬', 'ì„œìš¸íŠ¹ë³„ì‹œ ì„œì´ˆêµ¬', 'ì„œìš¸íŠ¹ë³„ì‹œ ì†¡íŒŒêµ¬', 'ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë™êµ¬'
    ],
    'ì„œìš¸ ê°•ì„œ/ì–‘ì²œ': [
        'ì„œìš¸íŠ¹ë³„ì‹œ ê°•ì„œêµ¬', 'ì„œìš¸íŠ¹ë³„ì‹œ ì–‘ì²œêµ¬', 'ì„œìš¸íŠ¹ë³„ì‹œ êµ¬ë¡œêµ¬', 'ì„œìš¸íŠ¹ë³„ì‹œ ê¸ˆì²œêµ¬', 'ì„œìš¸íŠ¹ë³„ì‹œ ì˜ë“±í¬êµ¬'
    ],
    'ì„œìš¸ ê°•ë¶/ë…¸ì›': [
        'ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë¶êµ¬', 'ì„œìš¸íŠ¹ë³„ì‹œ ë…¸ì›êµ¬', 'ì„œìš¸íŠ¹ë³„ì‹œ ë„ë´‰êµ¬', 'ì„œìš¸íŠ¹ë³„ì‹œ ì„±ë¶êµ¬', 'ì„œìš¸íŠ¹ë³„ì‹œ ì¤‘ë‘êµ¬'
    ],
    'ì„œìš¸ ë™ë¶€': [
        'ì„œìš¸íŠ¹ë³„ì‹œ ê´‘ì§„êµ¬', 'ì„œìš¸íŠ¹ë³„ì‹œ ë™ëŒ€ë¬¸êµ¬', 'ì„œìš¸íŠ¹ë³„ì‹œ ì„±ë™êµ¬'
    ],
    'ì„œìš¸ ì¤‘ë¶€/ì„œë¶€': [
        'ì„œìš¸íŠ¹ë³„ì‹œ ì¢…ë¡œêµ¬', 'ì„œìš¸íŠ¹ë³„ì‹œ ì¤‘êµ¬', 'ì„œìš¸íŠ¹ë³„ì‹œ ìš©ì‚°êµ¬', 'ì„œìš¸íŠ¹ë³„ì‹œ ë§ˆí¬êµ¬',
        'ì„œìš¸íŠ¹ë³„ì‹œ ì„œëŒ€ë¬¸êµ¬', 'ì„œìš¸íŠ¹ë³„ì‹œ ì€í‰êµ¬'
    ],
    'ì„œìš¸ ê´€ì•…/ë™ì‘': [
        'ì„œìš¸íŠ¹ë³„ì‹œ ê´€ì•…êµ¬', 'ì„œìš¸íŠ¹ë³„ì‹œ ë™ì‘êµ¬'
    ],
    'ê²½ê¸° ë¶ë¶€': [
        'ê²½ê¸°ë„ ì˜ì •ë¶€ì‹œ', 'ê²½ê¸°ë„ ì–‘ì£¼ì‹œ', 'ê²½ê¸°ë„ ë™ë‘ì²œì‹œ', 'ê²½ê¸°ë„ í¬ì²œì‹œ', 'ê²½ê¸°ë„ íŒŒì£¼ì‹œ',
        'ê²½ê¸°ë„ ê³ ì–‘ì‹œ', 'ê²½ê¸°ë„ ê¹€í¬ì‹œ', 'ê²½ê¸°ë„ ë‚¨ì–‘ì£¼ì‹œ', 'ê²½ê¸°ë„ êµ¬ë¦¬ì‹œ', 'ê²½ê¸°ë„ ê°€í‰êµ°', 'ê²½ê¸°ë„ ì—°ì²œêµ°'
    ],
    'ê²½ê¸° ë‚¨ë¶€': [
        'ê²½ê¸°ë„ ìˆ˜ì›ì‹œ', 'ê²½ê¸°ë„ ì„±ë‚¨ì‹œ', 'ê²½ê¸°ë„ ìš©ì¸ì‹œ', 'ê²½ê¸°ë„ ì•ˆì–‘ì‹œ', 'ê²½ê¸°ë„ ë¶€ì²œì‹œ',
        'ê²½ê¸°ë„ ê´‘ëª…ì‹œ', 'ê²½ê¸°ë„ ê³¼ì²œì‹œ', 'ê²½ê¸°ë„ ì˜ì™•ì‹œ', 'ê²½ê¸°ë„ êµ°í¬ì‹œ', 'ê²½ê¸°ë„ ì•ˆì‚°ì‹œ',
        'ê²½ê¸°ë„ ì‹œí¥ì‹œ', 'ê²½ê¸°ë„ ê´‘ì£¼ì‹œ', 'ê²½ê¸°ë„ í•˜ë‚¨ì‹œ', 'ê²½ê¸°ë„ ì´ì²œì‹œ', 'ê²½ê¸°ë„ ì—¬ì£¼ì‹œ',
        'ê²½ê¸°ë„ í™”ì„±ì‹œ', 'ê²½ê¸°ë„ í‰íƒì‹œ', 'ê²½ê¸°ë„ ì•ˆì„±ì‹œ', 'ê²½ê¸°ë„ ì˜¤ì‚°ì‹œ'
    ],
    'ì¶©ì²­ë¶ë„': [
        'ì¶©ì²­ë¶ë„ ì²­ì£¼ì‹œ', 'ì¶©ì²­ë¶ë„ ì¶©ì£¼ì‹œ', 'ì¶©ì²­ë¶ë„ ì œì²œì‹œ', 'ì¶©ì²­ë¶ë„ ìŒì„±êµ°',
        'ì¶©ì²­ë¶ë„ ì§„ì²œêµ°', 'ì¶©ì²­ë¶ë„ ê´´ì‚°êµ°', 'ì¶©ì²­ë¶ë„ ì¦í‰êµ°', 'ì¶©ì²­ë¶ë„ ë‹¨ì–‘êµ°',
        'ì¶©ì²­ë¶ë„ ë³´ì€êµ°', 'ì¶©ì²­ë¶ë„ ì˜¥ì²œêµ°', 'ì¶©ì²­ë¶ë„ ì˜ë™êµ°'
    ],
    'ì¶©ì²­ë‚¨ë„': [
        'ì¶©ì²­ë‚¨ë„ ì²œì•ˆì‹œ', 'ì¶©ì²­ë‚¨ë„ ì•„ì‚°ì‹œ', 'ì¶©ì²­ë‚¨ë„ ì„œì‚°ì‹œ', 'ì¶©ì²­ë‚¨ë„ ë…¼ì‚°ì‹œ',
        'ì¶©ì²­ë‚¨ë„ ê³„ë£¡ì‹œ', 'ì¶©ì²­ë‚¨ë„ ë‹¹ì§„ì‹œ', 'ì¶©ì²­ë‚¨ë„ ê³µì£¼ì‹œ', 'ì¶©ì²­ë‚¨ë„ ë³´ë ¹ì‹œ',
        'ì¶©ì²­ë‚¨ë„ ê¸ˆì‚°êµ°', 'ì¶©ì²­ë‚¨ë„ ë¶€ì—¬êµ°', 'ì¶©ì²­ë‚¨ë„ ì„œì²œêµ°', 'ì¶©ì²­ë‚¨ë„ ì²­ì–‘êµ°',
        'ì¶©ì²­ë‚¨ë„ í™ì„±êµ°', 'ì¶©ì²­ë‚¨ë„ ì˜ˆì‚°êµ°', 'ì¶©ì²­ë‚¨ë„ íƒœì•ˆêµ°'
    ],
    'ì „ë¼ë¶ë„': [
        'ì „ë¼ë¶ë„ ì „ì£¼ì‹œ', 'ì „ë¼ë¶ë„ êµ°ì‚°ì‹œ', 'ì „ë¼ë¶ë„ ìµì‚°ì‹œ', 'ì „ë¼ë¶ë„ ì •ìì‹œ',
        'ì „ë¼ë¶ë„ ë‚¨ì›ì‹œ', 'ì „ë¼ë¶ë„ ê¹€ì œì‹œ', 'ì „ë¼ë¶ë„ ì™„ì£¼êµ°', 'ì „ë¼ë¶ë„ ì§„ì•ˆêµ°',
        'ì „ë¼ë¶ë„ ë¬´ì£¼êµ°', 'ì „ë¼ë¶ë„ ì¥ìˆ˜êµ°', 'ì „ë¼ë¶ë„ ì„ì‹¤êµ°', 'ì „ë¼ë¶ë„ ìˆœì°½êµ°',
        'ì „ë¼ë¶ë„ ê³ ì°½êµ°', 'ì „ë¼ë¶ë„ ë¶€ì•ˆêµ°'
    ],
    'ì „ë¼ë‚¨ë„': [
        'ì „ë¼ë‚¨ë„ ëª©í¬ì‹œ', 'ì „ë¼ë‚¨ë„ ì—¬ìˆ˜ì‹œ', 'ì „ë¼ë‚¨ë„ ìˆœì²œì‹œ', 'ì „ë¼ë‚¨ë„ ë‚˜ì£¼ì‹œ',
        'ì „ë¼ë‚¨ë„ ê´‘ì–‘ì‹œ', 'ì „ë¼ë‚¨ë„ ë‹´ì–‘êµ°', 'ì „ë¼ë‚¨ë„ ê³¡ì„±êµ°', 'ì „ë¼ë‚¨ë„ êµ¬ë¡€êµ°',
        'ì „ë¼ë‚¨ë„ ê³ í¥êµ°', 'ì „ë¼ë‚¨ë„ ë³´ì„±êµ°', 'ì „ë¼ë‚¨ë„ í™”ìˆœêµ°', 'ì „ë¼ë‚¨ë„ ì¥í¥êµ°',
        'ì „ë¼ë‚¨ë„ ê°•ì§„êµ°', 'ì „ë¼ë‚¨ë„ í•´ë‚¨êµ°', 'ì „ë¼ë‚¨ë„ ì˜ì•”êµ°', 'ì „ë¼ë‚¨ë„ ë¬´ì•ˆêµ°',
        'ì „ë¼ë‚¨ë„ í•¨í‰êµ°', 'ì „ë¼ë‚¨ë„ ì˜ê´‘êµ°', 'ì „ë¼ë‚¨ë„ ì¥ì„±êµ°', 'ì „ë¼ë‚¨ë„ ì™„ë„êµ°',
        'ì „ë¼ë‚¨ë„ ì§„ë„êµ°', 'ì „ë¼ë‚¨ë„ ì‹ ì•ˆêµ°'
    ],
    'ê²½ìƒë¶ë„': [
        'ê²½ìƒë¶ë„ í¬í•­ì‹œ', 'ê²½ìƒë¶ë„ ê²½ì£¼ì‹œ', 'ê²½ìƒë¶ë„ ê¹€ì²œì‹œ', 'ê²½ìƒë¶ë„ ì•ˆë™ì‹œ',
        'ê²½ìƒë¶ë„ êµ¬ë¯¸ì‹œ', 'ê²½ìƒë¶ë„ ì˜ì£¼ì‹œ', 'ê²½ìƒë¶ë„ ì˜ì²œì‹œ', 'ê²½ìƒë¶ë„ ìƒì£¼ì‹œ',
        'ê²½ìƒë¶ë„ ë¬¸ê²½ì‹œ', 'ê²½ìƒë¶ë„ ê²½ì‚°ì‹œ', 'ê²½ìƒë¶ë„ êµ°ìœ„êµ°', 'ê²½ìƒë¶ë„ ì˜ì„±êµ°',
        'ê²½ìƒë¶ë„ ì²­ì†¡êµ°', 'ê²½ìƒë¶ë„ ì˜ì–‘êµ°', 'ê²½ìƒë¶ë„ ì˜ë•êµ°', 'ê²½ìƒë¶ë„ ì²­ë„êµ°',
        'ê²½ìƒë¶ë„ ê³ ë ¹êµ°', 'ê²½ìƒë¶ë„ ì„±ì£¼êµ°', 'ê²½ìƒë¶ë„ ì¹ ê³¡êµ°', 'ê²½ìƒë¶ë„ ì˜ˆì²œêµ°',
        'ê²½ìƒë¶ë„ ë´‰í™”êµ°', 'ê²½ìƒë¶ë„ ìš¸ì§„êµ°', 'ê²½ìƒë¶ë„ ìš¸ë¦‰êµ°'
    ],
    'ê²½ìƒë‚¨ë„': [
        'ê²½ìƒë‚¨ë„ ì°½ì›ì‹œ', 'ê²½ìƒë‚¨ë„ ì§„ì£¼ì‹œ', 'ê²½ìƒë‚¨ë„ í†µì˜ì‹œ', 'ê²½ìƒë‚¨ë„ ì‚¬ì²œì‹œ',
        'ê²½ìƒë‚¨ë„ ê¹€í•´ì‹œ', 'ê²½ìƒë‚¨ë„ ë°€ì–‘ì‹œ', 'ê²½ìƒë‚¨ë„ ê±°ì œì‹œ', 'ê²½ìƒë‚¨ë„ ì–‘ì‚°ì‹œ',
        'ê²½ìƒë‚¨ë„ ì˜ë ¹êµ°', 'ê²½ìƒë‚¨ë„ í•¨ì•ˆêµ°', 'ê²½ìƒë‚¨ë„ ì°½ë…•êµ°', 'ê²½ìƒë‚¨ë„ ê³ ì„±êµ°',
        'ê²½ìƒë‚¨ë„ ë‚¨í•´êµ°', 'ê²½ìƒë‚¨ë„ í•˜ë™êµ°', 'ê²½ìƒë‚¨ë„ ì‚°ì²­êµ°', 'ê²½ìƒë‚¨ë„ í•¨ì–‘êµ°',
        'ê²½ìƒë‚¨ë„ ê±°ì°½êµ°', 'ê²½ìƒë‚¨ë„ í•©ì²œêµ°'
    ],
    'ì œì£¼íŠ¹ë³„ìì¹˜ë„': [
        'ì œì£¼íŠ¹ë³„ìì¹˜ë„ ì œì£¼ì‹œ', 'ì œì£¼íŠ¹ë³„ìì¹˜ë„ ì„œê·€í¬ì‹œ'
    ]
};

// ì¤‘ë‹¨ í”Œë˜ê·¸
let isCollectionStopped = false;

// ì¤‘ë‹¨ ë²„íŠ¼ ì´ë²¤íŠ¸
document.getElementById('stopBtn').addEventListener('click', function() {
    isCollectionStopped = true;
    this.disabled = true;
    this.textContent = 'â¸ï¸ ì¤‘ë‹¨ ì¤‘...';
    addLog('ğŸ›‘ ì‚¬ìš©ìê°€ ìˆ˜ì§‘ì„ ì¤‘ë‹¨í–ˆìŠµë‹ˆë‹¤.', 'error');
});

document.getElementById('collectForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    // ì„ íƒëœ ì‹œ/ë„ ìˆ˜ì§‘
    const selectedProvinces = Array.from(document.querySelectorAll('input[name="provinces"]:checked'))
        .map(cb => cb.value);

    if (selectedProvinces.length === 0) {
        alert('ìµœì†Œ 1ê°œ ì´ìƒì˜ ì‹œ/ë„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }

    const categorySelect = document.getElementById('category');
    const categoryId = categorySelect.value;
    const categoryNameEn = categorySelect.options[categorySelect.selectedIndex].dataset.nameEn;
    const limit = parseInt(document.getElementById('limit').value);

    // ì¤‘ë‹¨ í”Œë˜ê·¸ ì´ˆê¸°í™”
    isCollectionStopped = false;

    document.getElementById('progressContainer').style.display = 'block';
    document.getElementById('collectBtn').disabled = true;
    document.getElementById('collectBtn').textContent = 'â³ ìˆ˜ì§‘ ì¤‘...';
    document.getElementById('stopBtn').style.display = 'block';
    document.getElementById('stopBtn').disabled = false;
    document.getElementById('stopBtn').textContent = 'â¹ï¸ ìˆ˜ì§‘ ì¤‘ë‹¨';

    // ì„ íƒëœ ì‹œ/ë„ë¥¼ í•˜ë¶€ ì§€ì—­ìœ¼ë¡œ í™•ì¥
    const regions = [];
    selectedProvinces.forEach(province => {
        const subRegions = PROVINCE_TO_REGIONS[province];
        if (subRegions) {
            regions.push(...subRegions);
        } else {
            addLog(`âš ï¸ ${province}: í•˜ë¶€ ì§€ì—­ ì •ë³´ ì—†ìŒ`, 'error');
        }
    });

    // ì¹´í…Œê³ ë¦¬ ëª©ë¡ ê²°ì •
    const categories = categoryId === 'ALL'
        ? Array.from(document.querySelectorAll('#category option[data-name-en]'))
            .filter(opt => opt.value !== 'ALL')
            .map(opt => ({id: opt.value, nameEn: opt.dataset.nameEn, placeType: opt.dataset.placeType}))
        : [{id: categoryId, nameEn: categoryNameEn, placeType: document.querySelector(`#category option[value="${categoryId}"]`)?.dataset.placeType}];

    addLog(`ğŸ“ ì§€ì—­: ${regions.length}ê³³, ì—…ì¢…: ${categories.length}ê°œ, ì§€ì—­ë‹¹ ${limit}ê°œì”© ìˆ˜ì§‘`);

    try {
        for (const targetRegion of regions) {
            // ì¤‘ë‹¨ ì²´í¬
            if (isCollectionStopped) {
                addLog('â¹ï¸ ìˆ˜ì§‘ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.', 'error');
                break;
            }

            for (const cat of categories) {
                // ì¤‘ë‹¨ ì²´í¬
                if (isCollectionStopped) {
                    addLog('â¹ï¸ ìˆ˜ì§‘ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.', 'error');
                    break;
                }

                // êµ¬/ì‹œ ì¶”ì¶œ (ì˜ˆ: "ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬" â†’ "ê°•ë‚¨êµ¬")
                const regionShort = targetRegion.split(' ').pop();
                const coordinates = REGION_COORDINATES[regionShort];

                if (!coordinates) {
                    addLog(`âŒ ${targetRegion}: ì¢Œí‘œ ì •ë³´ ì—†ìŒ`, 'error');
                    continue;
                }

                addLog(`ğŸ” ${targetRegion} - ${cat.nameEn} ê²€ìƒ‰ ì¤‘...`);

                // Google Places API í˜¸ì¶œ (includedTypes ì‚¬ìš©)
                const places = await fetchGooglePlaces(regionShort, cat.nameEn, coordinates, limit, cat.placeType);

                addLog(`âœ… ${places.length}ê°œ ì—…ì²´ ë°œê²¬ (í•„í„°ë§ í›„)`);

                if (places.length === 0) {
                    addLog(`âš ï¸ ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ`, 'error');
                    continue;
                }

                // ê¸°ì¡´ ì—…ì²´ì˜ ìš”ì•½ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (30ì¼ ìºì‹± í™•ì¸ìš©)
                const placeIds = places.map(p => p.place_id);
                const existingBusinesses = await fetch('/api/local-businesses/?' + new URLSearchParams({
                    google_place_id__in: placeIds.join(',')
                })).then(r => r.json()).catch(() => ({results: []}));

                const existingSummaryMap = {};
                if (existingBusinesses.results) {
                    existingBusinesses.results.forEach(b => {
                        existingSummaryMap[b.google_place_id] = b.editorial_summary;
                    });
                }

                // AI ìš”ì•½ ìƒì„± (ë°°ì¹˜ ì²˜ë¦¬, ê¸°ì¡´ ìš”ì•½ ì¬ì‚¬ìš©)
                addLog(`ğŸ¤– AI ìš”ì•½ í™•ì¸/ìƒì„± ì‹œì‘... (${places.length}ê°œ ì—…ì²´)`);
                const BATCH_SIZE = 5; // 5ê°œì”© ë³‘ë ¬ ì²˜ë¦¬ (OpenAI Rate Limit ì¶©ë¶„)

                for (let i = 0; i < places.length; i += BATCH_SIZE) {
                    // ì¤‘ë‹¨ ì²´í¬
                    if (isCollectionStopped) {
                        addLog('â¹ï¸ AI ìš”ì•½ ìƒì„±ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.', 'error');
                        break;
                    }

                    const batch = places.slice(i, i + BATCH_SIZE);

                    addLog(`â³ ë°°ì¹˜ ${Math.floor(i/BATCH_SIZE) + 1} ì²˜ë¦¬ ì¤‘... (${batch.length}ê°œ)`);

                    await Promise.all(
                        batch.map(async (place) => {
                            // ê¸°ì¡´ AI ìš”ì•½ ì¬ì‚¬ìš© ë˜ëŠ” ìƒˆë¡œ ìƒì„±
                            const existingSummary = existingSummaryMap[place.place_id];
                            const aiSummary = await generateAISummary(place, existingSummary);
                            if (aiSummary) {
                                place.editorial_summary = aiSummary;
                                console.log(`[AI ìš”ì•½ ì €ì¥] ${place.name}: "${aiSummary.substring(0, 30)}..."`);
                            } else {
                                console.log(`[AI ìš”ì•½ ì‹¤íŒ¨] ${place.name}: ìš”ì•½ ìƒì„± ì•ˆ ë¨ (ë¦¬ë·°: ${place.reviews?.length || 0}ê°œ)`);
                            }
                        })
                    );

                    addLog(`âœ… ë°°ì¹˜ ${Math.floor(i/BATCH_SIZE) + 1} ì™„ë£Œ`);
                }

                // ì¤‘ë‹¨ëœ ê²½ìš° ì €ì¥ ìŠ¤í‚µ
                if (isCollectionStopped) {
                    continue;
                }

                // ë°±ì—”ë“œë¡œ ì €ì¥ - popularity_scoreë¡œ ì •ë ¬ í›„ ìˆœìœ„ í• ë‹¹
                const businesses = places.map((place) => {
                    return {
                        google_place_id: place.place_id,
                        category_id: parseInt(cat.id),
                        region_name: targetRegion,
                        name: place.name,
                        address: place.formatted_address || place.vicinity,
                        phone_number: place.formatted_phone_number,
                        latitude: place.geometry.location.lat(),
                        longitude: place.geometry.location.lng(),
                        rating: place.rating,
                        review_count: place.user_ratings_total || 0,
                        google_maps_url: `https://www.google.com/maps/place/?q=place_id:${place.place_id}`,
                        photo_url: place.photos && place.photos[0] ?
                            `https://places.googleapis.com/v1/${place.photos[0].name}/media?maxWidthPx=800` : null,
                        website_url: place.website,
                        opening_hours: place.opening_hours,
                        editorial_summary: place.editorial_summary,
                        business_status: place.business_status,
                        last_review_time: place.last_review_time,
                        popularity_score: calculatePopularityScore(place.rating || 0, place.user_ratings_total || 0),
                    };
                });

                // popularity_score ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ í›„ ìˆœìœ„ í• ë‹¹
                businesses.sort((a, b) => b.popularity_score - a.popularity_score);
                businesses.forEach((business, index) => {
                    business.rank_in_region = index + 1;

                    // ìš”ì•½ ì €ì¥ ë¡œê·¸
                    if (business.editorial_summary) {
                        console.log(`[ì €ì¥ ë°ì´í„°] ${business.name} (ìˆœìœ„ ${business.rank_in_region}, ì ìˆ˜ ${business.popularity_score.toFixed(2)}): editorial_summary="${business.editorial_summary.substring(0, 50)}..."`);
                    } else {
                        console.log(`[ì €ì¥ ë°ì´í„°] ${business.name} (ìˆœìœ„ ${business.rank_in_region}, ì ìˆ˜ ${business.popularity_score.toFixed(2)}): editorial_summary=null`);
                    }
                });

                addLog('ğŸ’¾ ë°±ì—”ë“œì— ì €ì¥ ì¤‘...');

                const response = await fetch('/api/local-businesses/bulk_create/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({businesses})
                });

                // ì‘ë‹µ ìƒíƒœ ì²´í¬
                if (!response.ok) {
                    const errorText = await response.text();
                    addLog(`âŒ ì˜¤ë¥˜: ì„œë²„ ì‘ë‹µ ${response.status} - ${errorText.substring(0, 200)}`, 'error');
                    continue;
                }

                const result = await response.json();

                document.getElementById('successCount').textContent =
                    parseInt(document.getElementById('successCount').textContent || 0) + result.created + result.updated;
                document.getElementById('failCount').textContent =
                    parseInt(document.getElementById('failCount').textContent || 0) + result.errors.length;
                document.getElementById('totalCount').textContent =
                    parseInt(document.getElementById('totalCount').textContent || 0) + result.total;

                addLog(`âœ… ì €ì¥ ì™„ë£Œ! ìƒì„±: ${result.created}ê°œ, ì—…ë°ì´íŠ¸: ${result.updated}ê°œ, ìŠ¤í‚µ: ${result.skipped}ê°œ`);

                if (result.errors.length > 0) {
                    result.errors.forEach(err => addLog(`âŒ ${err}`, 'error'));
                }

                // API ê³¼ë¶€í•˜ ë°©ì§€: 0.5ì´ˆ ëŒ€ê¸°
                await new Promise(resolve => setTimeout(resolve, 500));
            }
        }

        if (!isCollectionStopped) {
            addLog(`ğŸ‰ ì „ì²´ ìˆ˜ì§‘ ì™„ë£Œ!`);
        } else {
            addLog(`â¹ï¸ ìˆ˜ì§‘ì´ ì‚¬ìš©ìì— ì˜í•´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'error');
        }

    } catch (error) {
        addLog(`âŒ ì˜¤ë¥˜: ${error.message}`, 'error');
    } finally {
        document.getElementById('collectBtn').disabled = false;
        document.getElementById('collectBtn').textContent = 'ğŸš€ ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘';
        document.getElementById('stopBtn').style.display = 'none';
    }
});

async function fetchGooglePlaces(city, category, coordinates, maxResults, placeType = null) {
    // ë°±ì—”ë“œ í”„ë¡ì‹œë¥¼ í†µí•´ Google API í˜¸ì¶œ (CORS ìš°íšŒ)
    const proxyUrl = '/api/local-businesses/google-search-proxy/';

    const requestBody = {
        textQuery: `${city} ${category}`,
        languageCode: 'ko',
        locationBias: {
            circle: {
                center: {
                    latitude: coordinates.latitude,
                    longitude: coordinates.longitude
                },
                radius: 5000.0
            }
        },
        minRating: 4.0,
        maxResultCount: maxResults
    };

    // Note: includedTypesëŠ” Text Search APIì—ì„œ ì§€ì›í•˜ì§€ ì•ŠìŒ
    // Text SearchëŠ” textQuery ê¸°ë°˜ìœ¼ë¡œë§Œ í•„í„°ë§ ê°€ëŠ¥

    const response = await fetch(proxyUrl, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
        },
        body: JSON.stringify(requestBody)
    });

    if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`Google API í”„ë¡ì‹œ ì˜¤ë¥˜: ${response.status} - ${errorText}`);
    }

    const data = await response.json();

    if (!data.places || data.places.length === 0) {
        return [];
    }

    // í•„í„°ë§: íì—… ì—…ì²´, ì—°ë½ì²˜ ì—†ëŠ” ì—…ì²´, ë¦¬ë·° ì—†ëŠ” ì—…ì²´, 2ë…„ ì´ìƒ ë¦¬ë·° ì—†ëŠ” ì—…ì²´ ì œì™¸
    const TWO_YEARS_MS = 2 * 365 * 24 * 60 * 60 * 1000;
    const filteredPlaces = data.places.filter(place => {
        // íì—…í•œ ê³³ ì œì™¸
        if (place.businessStatus === 'CLOSED_PERMANENTLY') {
            addLog(`âš ï¸ ${place.displayName.text}: íì—… (ì œì™¸)`, 'error');
            return false;
        }

        // ì—°ë½ì²˜ ì—†ëŠ” ì—…ì²´ ì œì™¸
        if (!place.internationalPhoneNumber) {
            addLog(`âš ï¸ ${place.displayName.text}: ì—°ë½ì²˜ ì—†ìŒ (ì œì™¸)`, 'error');
            return false;
        }

        // ë¦¬ë·°ê°€ 2ê°œ ë¯¸ë§Œì¸ ì—…ì²´ ì œì™¸
        if (!place.userRatingCount || place.userRatingCount < 2) {
            addLog(`âš ï¸ ${place.displayName.text}: ë¦¬ë·° ${place.userRatingCount || 0}ê°œ (2ê°œ ë¯¸ë§Œ ì œì™¸)`, 'error');
            return false;
        }

        // ë¦¬ë·°ê°€ ìˆê³ , ìµœì‹  ë¦¬ë·°ê°€ 2ë…„ ì´ìƒ ì§€ë‚¬ìœ¼ë©´ ì œì™¸
        if (place.reviews && place.reviews.length > 0) {
            const latestReview = place.reviews[0];
            const reviewDate = new Date(latestReview.publishTime);
            const daysSinceReview = (Date.now() - reviewDate) / (1000 * 60 * 60 * 24);

            if (daysSinceReview > 730) {
                addLog(`âš ï¸ ${place.displayName.text}: ìµœê·¼ ë¦¬ë·° ${Math.floor(daysSinceReview)}ì¼ ì „ (ì œì™¸)`, 'error');
                return false;
            }
        }

        // ì£¼ì†Œ ê²€ì¦: ê²€ìƒ‰í•œ ì§€ì—­ëª…ì´ ì‹¤ì œ ì£¼ì†Œì— í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
        if (place.formattedAddress && city) {
            // "ê°•ë‚¨êµ¬", "ë…¸ì›êµ¬" ë“±ì—ì„œ "êµ¬"ë¥¼ ì œê±°í•œ ìˆœìˆ˜ ì§€ì—­ëª… ì¶”ì¶œ
            const cityName = city.replace(/ì‹œ$|êµ¬$|êµ°$/g, '');
            if (!place.formattedAddress.includes(cityName)) {
                addLog(`âš ï¸ ${place.displayName.text}: ì£¼ì†Œ ë¶ˆì¼ì¹˜ (${place.formattedAddress.substring(0, 20)}... â‰  ${city})`, 'error');
                return false;
            }
        }

        // ì „ì—­ ì œì™¸ í‚¤ì›Œë“œ (ëª¨ë“  ì—…ì¢…ì— ì ìš©)
        const globalExcludeKeywords = [
            'ì¹´í˜', 'cafe', 'coffee',
            'í˜¸í…”', 'hotel', 'motel',
            'êµ°ì²­', 'ì‹œì²­', 'êµ¬ì²­', 'ë©´ì‚¬ë¬´ì†Œ', 'ì£¼ë¯¼ì„¼í„°', 'í–‰ì •ë³µì§€ì„¼í„°',
            'ë³‘ì›', 'hospital', 'clinic',
            'ì•½êµ­', 'pharmacy',
            'í¸ì˜ì ', 'convenience',
            'ë§ˆíŠ¸', 'mart',
            'ì‹ë‹¹', 'restaurant',
            'í•™êµ', 'school', 'ëŒ€í•™êµ', 'university',
            'ì€í–‰', 'bank',
            'ìš°ì²´êµ­', 'post office'
        ];

        const name = place.displayName.text.toLowerCase();
        const address = (place.formattedAddress || '').toLowerCase();

        // ì „ì—­ ì œì™¸ í‚¤ì›Œë“œ ì²´í¬
        if (globalExcludeKeywords.some(keyword => name.includes(keyword))) {
            addLog(`âš ï¸ ${place.displayName.text}: ë¶€ì í•© ì—…ì¢… (${globalExcludeKeywords.find(k => name.includes(k))})`, 'error');
            return false;
        }

        // ì¹´í…Œê³ ë¦¬ë³„ í•„ìˆ˜ í‚¤ì›Œë“œ ê²€ì¦
        const categoryRequirements = {
            'lawyer': {
                required: ['ë²•ë¥ ', 'ë²•ë¬´', 'ë³€í˜¸ì‚¬', 'law'],
                name: 'ë³€í˜¸ì‚¬'
            },
            'legal': {
                required: ['ë²•ë¥ ', 'ë²•ë¬´', 'ë³€í˜¸ì‚¬', 'law'],
                name: 'ë²•ë¬´ì‚¬'
            },
            'accounting': {
                required: ['íšŒê³„', 'ì„¸ë¬´', 'ê³µì¸íšŒê³„ì‚¬', 'accounting', 'cpa'],
                name: 'íšŒê³„ì‚¬'
            },
            'tax': {
                required: ['ì„¸ë¬´', 'ì„¸ë¬´ì‚¬', 'tax'],
                name: 'ì„¸ë¬´ì‚¬'
            },
            'real_estate': {
                required: ['ë¶€ë™ì‚°', 'ê³µì¸ì¤‘ê°œì‚¬', 'real estate', 'realty'],
                name: 'ë¶€ë™ì‚°'
            }
        };

        const categoryKey = category.toLowerCase();
        if (categoryRequirements[categoryKey]) {
            const req = categoryRequirements[categoryKey];
            const hasRequired = req.required.some(keyword =>
                name.includes(keyword) || address.includes(keyword)
            );

            if (!hasRequired) {
                addLog(`âš ï¸ ${place.displayName.text}: ${req.name} í•„ìˆ˜ í‚¤ì›Œë“œ ì—†ìŒ`, 'error');
                return false;
            }
        }

        return true;
    });

    // í”„ë¡ íŠ¸ì—”ë“œ ë­í‚¹ í˜•ì‹ìœ¼ë¡œ ë³€í™˜ (ë¦¬ë·° ë°ì´í„° í¬í•¨)
    return filteredPlaces.map(place => {
        return {
            place_id: place.id,
            name: place.displayName.text,
            formatted_address: place.formattedAddress,
            vicinity: place.formattedAddress,
            formatted_phone_number: place.internationalPhoneNumber,
            rating: place.rating,
            user_ratings_total: place.userRatingCount,
            geometry: {
                location: {
                    lat: () => place.location.latitude,
                    lng: () => place.location.longitude
                }
            },
            photos: place.photos ? place.photos.map(photo => ({
                name: photo.name,
                // Photo URLì€ ì§ì ‘ ìƒì„± (API í‚¤ ë…¸ì¶œ ë°©ì§€ë¥¼ ìœ„í•´ ì„ì‹œ í”Œë ˆì´ìŠ¤í™€ë” ì‚¬ìš©)
                getUrl: (opts) => `https://places.googleapis.com/v1/${photo.name}/media?maxWidthPx=${opts.maxWidth}&key=BACKEND_WILL_HANDLE`
            })) : null,
            website: place.websiteUri,
            opening_hours: place.regularOpeningHours?.weekdayDescriptions,
            editorial_summary: null,  // AI ìš”ì•½ìœ¼ë¡œ ëŒ€ì²´
            business_status: place.businessStatus || 'OPERATIONAL',
            last_review_time: place.reviews && place.reviews.length > 0 ? place.reviews[0].publishTime : null,
            reviews: place.reviews // ë¦¬ë·° ë°ì´í„° ì¶”ê°€ (AI ìš”ì•½ìš©)
        };
    });
}

function calculatePopularityScore(rating, reviewCount) {
    const C = 10;
    const m = 4.0;
    const adjustedRating = (C * m + reviewCount * rating) / (C + reviewCount);
    return adjustedRating * Math.log10(reviewCount + 1);
}

async function generateAISummary(place, existingSummary = null) {
    // ê¸°ì¡´ AI ìš”ì•½ì´ ìˆìœ¼ë©´ ì¬ì‚¬ìš© (30ì¼ ìºì‹±)
    if (existingSummary) {
        addLog(`â™»ï¸ ${place.name}: ê¸°ì¡´ AI ìš”ì•½ ì¬ì‚¬ìš© (í† í° ì ˆì•½)`, 'info');
        return existingSummary;
    }

    // ë¦¬ë·°ê°€ ì—†ìœ¼ë©´ null ë°˜í™˜
    if (!place.reviews || place.reviews.length === 0) {
        addLog(`âš ï¸ ${place.name}: ë¦¬ë·° ì—†ìŒ, ìš”ì•½ ìƒì„± ë¶ˆê°€`, 'error');
        return null;
    }

    try {
        addLog(`ğŸ¤– ${place.name}: AI ìš”ì•½ ìƒì„± ì¤‘...`, 'info');

        // ë¦¬ë·° ë°ì´í„° í¬ë§·íŒ…
        const reviewsData = place.reviews.map(review => ({
            text: review.text?.text || '',
            rating: review.rating || 0
        }));

        // Django ë°±ì—”ë“œ API í˜¸ì¶œ
        const response = await fetch('/api/local-businesses/generate_summary/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                business_name: place.name,
                reviews: reviewsData
            })
        });

        if (response.ok) {
            const data = await response.json();
            if (data.success && data.summary) {
                addLog(`âœ… ${place.name}: AI ìš”ì•½ ìƒì„± ì™„ë£Œ`, 'success');
                return data.summary;
            } else {
                addLog(`âš ï¸ ${place.name}: ${data.error || 'AI ìš”ì•½ ìƒì„± ì‹¤íŒ¨'}`, 'error');
                return null;
            }
        } else {
            const errorData = await response.json().catch(() => ({}));
            addLog(`âš ï¸ ${place.name}: API ì˜¤ë¥˜ (${response.status}) - ${errorData.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`, 'error');
            return null;
        }

    } catch (error) {
        console.error('AI ìš”ì•½ ìƒì„± ì˜¤ë¥˜:', error);
        addLog(`âŒ ${place.name}: ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ - ${error.message}`, 'error');
        return null;
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function addLog(message, type = 'info') {
    const logContainer = document.getElementById('logContainer');
    const color = type === 'error' ? '#f44336' : type === 'success' ? '#4CAF50' : '#666';
    logContainer.innerHTML += `<div style="color: ${color};">${message}</div>`;
    logContainer.scrollTop = logContainer.scrollHeight;
}
</script>
{% endblock %}
