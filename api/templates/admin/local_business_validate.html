{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}ì—…ì²´ ë°ì´í„° ê²€ì¦ (OpenAI){% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">í™ˆ</a>
    &rsaquo; <a href="{% url 'admin:api_localbusiness_changelist' %}">ì§€ì—­ ì—…ì²´</a>
    &rsaquo; ë°ì´í„° ê²€ì¦
</div>
{% endblock %}

{% block content %}
<div style="max-width: 1000px; margin: 20px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
    <h1 style="margin-bottom: 20px;">ğŸ¤– ì—…ì²´ ë°ì´í„° ê²€ì¦ (OpenAI)</h1>

    <div style="background: #fff3cd; border: 1px solid #ffc107; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
        <strong>âš ï¸ ì£¼ì˜ì‚¬í•­</strong>
        <ul style="margin: 10px 0 0 20px;">
            <li>OpenAI APIë¥¼ ì‚¬ìš©í•˜ì—¬ ì—…ì²´ ë°ì´í„°ë¥¼ ê²€ì¦í•©ë‹ˆë‹¤.</li>
            <li>í•œ ë²ˆì— ìµœëŒ€ 50ê°œ ì—…ì²´ë¥¼ ê²€ì¦í•©ë‹ˆë‹¤.</li>
            <li>ê²€ì¦ ì‹œê°„: ì•½ 1~2ë¶„ (ì—…ì²´ ìˆ˜ì— ë”°ë¼ ë‹¤ë¦„)</li>
            <li id="validationInfo">ë¬¸ì œê°€ ìˆëŠ” ì—…ì²´ëŠ” ëª©ë¡ì— í‘œì‹œë©ë‹ˆë‹¤.</li>
        </ul>
    </div>

    <div style="background: #e8f5e9; border: 1px solid #4CAF50; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap;">
            <div>
                <strong>ì„¸ë¬´/ë³€í˜¸ ì—…ì¢… ì¬ë¶„ë¥˜</strong>
                <div style="color: #2e7d32; margin-top: 6px; font-size: 13px;">
                    ì—…ì²´ëª…ì— "ì„¸ë¬´"ê°€ í¬í•¨ëœ í•­ëª©ì€ ì„¸ë¬´ì‚¬, "ë³€í˜¸"ê°€ í¬í•¨ëœ í•­ëª©ì€ ë³€í˜¸ì‚¬ë¡œ ì¦‰ì‹œ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <button type="button" id="retagTaxLawBtn"
                        style="padding: 8px 14px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                    ì„¸ë¬´/ë³€í˜¸ ì¬ë¶„ë¥˜ ì‹¤í–‰
                </button>
                <span id="retagStatus" style="color: #2e7d32; font-size: 13px;"></span>
            </div>
        </div>
    </div>

    <form id="validateForm" style="margin-top: 20px;">
        {% csrf_token %}

        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 10px; font-weight: bold;">ê²€ì¦ ëª¨ë“œ ì„ íƒ</label>
            <div style="display: flex; gap: 10px;">
                <label id="categoryModeLabel" style="flex: 1; padding: 15px; border: 2px solid #2196F3; border-radius: 8px; cursor: pointer; background: #e3f2fd; transition: all 0.2s;">
                    <input type="radio" name="validation_mode" value="category" checked style="margin-right: 8px;">
                    <strong>ğŸ¢ ì—…ì¢… ê²€ì¦</strong>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">ì—…ì²´ëª…ê³¼ ì—…ì¢…ì´ ì¼ì¹˜í•˜ëŠ”ì§€ ê²€ì¦</div>
                </label>
                <label id="duplicateModeLabel" style="flex: 1; padding: 15px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; background: white; transition: all 0.2s;">
                    <input type="radio" name="validation_mode" value="duplicate" style="margin-right: 8px;">
                    <strong>ğŸ”„ ì¤‘ë³µ ê²€ì¦</strong>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">ì¤‘ë³µëœ ì—…ì²´ëª… ê²€ì¦</div>
                </label>
                <label id="websiteModeLabel" style="flex: 1; padding: 15px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; background: white; transition: all 0.2s;">
                    <input type="radio" name="validation_mode" value="website" style="margin-right: 8px;">
                    <strong>ğŸŒ ì›¹ì‚¬ì´íŠ¸ ê²€ì¦</strong>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">ì›¹ì‚¬ì´íŠ¸ ìƒíƒœ ë° ìœ íš¨ì„± ê²€ì¦</div>
                </label>
            </div>
        </div>

        <div style="margin-bottom: 20px;">
            <label for="category" style="display: block; margin-bottom: 10px; font-weight: bold;">ì—…ì¢… ì„ íƒ</label>
            <select name="category" id="category" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="">-- ì „ì²´ ì—…ì¢… --</option>
                {% for cat in categories %}
                <option value="{{ cat.id }}">{{ cat.icon }} {{ cat.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 10px; font-weight: bold;">ì§€ì—­ ì„ íƒ (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥)</label>
            <div style="border: 1px solid #ddd; border-radius: 4px; padding: 15px; max-height: 400px; overflow-y: auto;">
                {% for group in region_groups %}
                <div style="margin-bottom: 15px;" data-group-index="{{ forloop.counter0 }}">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding-bottom: 5px; border-bottom: 1px solid #e0e0e0;">
                        <span style="font-weight: bold; color: #2196F3;">{{ group.name }}</span>
                        <button type="button" class="group-select-btn" data-group="{{ forloop.counter0 }}"
                                style="padding: 4px 10px; background: #4CAF50; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">
                            ê·¸ë£¹ ì „ì²´ ì„ íƒ
                        </button>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                        {% for region in group.regions %}
                        <label style="display: flex; align-items: center; cursor: pointer; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px; background: #fafafa; transition: background 0.2s;">
                            <input type="checkbox" name="regions" value="{{ region }}" class="region-checkbox group-{{ forloop.parentloop.counter0 }}" style="margin-right: 8px; width: 16px; height: 16px; cursor: pointer;">
                            <span style="font-size: 13px;">{{ region }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
            <div style="margin-top: 10px; text-align: right;">
                <button type="button" id="selectAllBtn" style="padding: 6px 12px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; margin-right: 5px;">ì „ì²´ ì„ íƒ</button>
                <button type="button" id="deselectAllBtn" style="padding: 6px 12px; background: #9E9E9E; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">ì „ì²´ í•´ì œ</button>
            </div>
        </div>

        <button type="submit" id="validateBtn"
                style="width: 100%; padding: 12px 24px; background: #FF9800; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: bold;">
            <span id="validateBtnText">ğŸ” ì—…ì¢… ê²€ì¦ ì‹œì‘</span>
        </button>
    </form>

    <!-- ê²€ì¦ ì§„í–‰ ìƒí™© -->
    <div id="progressContainer" style="display: none; margin-top: 30px; padding: 20px; background: #f5f5f5; border-radius: 8px;">
        <h3 style="margin-bottom: 15px;">ğŸ”„ ê²€ì¦ ì§„í–‰ ì¤‘...</h3>
        <div style="text-align: center; padding: 20px;">
            <div class="spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #FF9800; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto;"></div>
            <p style="margin-top: 15px; color: #666;">OpenAIë¡œ ì—…ì²´ ê²€ì¦ ì¤‘...</p>
        </div>
    </div>

    <!-- ê²€ì¦ ê²°ê³¼ -->
    <div id="resultContainer" style="display: none; margin-top: 30px;">
        <h3 style="margin-bottom: 15px;">ğŸ“Š ê²€ì¦ ê²°ê³¼</h3>

        <div style="background: #e3f2fd; border: 1px solid #2196F3; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-around; text-align: center;">
                <div>
                    <div style="font-size: 24px; font-weight: bold; color: #2196F3;" id="totalChecked">0</div>
                    <div style="color: #666; font-size: 12px;">ê²€ì¦í•œ ì—…ì²´</div>
                </div>
                <div>
                    <div style="font-size: 24px; font-weight: bold; color: #f44336;" id="invalidCount">0</div>
                    <div style="color: #666; font-size: 12px;">ì˜ëª» ë¶„ë¥˜ë¨</div>
                </div>
            </div>
        </div>

        <!-- ì˜ëª» ë¶„ë¥˜ëœ ì—…ì²´ ëª©ë¡ -->
        <div id="invalidList" style="background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 400px; overflow-y: auto;">
            <!-- JavaScriptë¡œ ì±„ì›Œì§ -->
        </div>

        <div id="deleteSection" style="display: none; margin-top: 20px;">
            <button id="deleteBtn"
                    style="width: 100%; padding: 12px 24px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: bold;">
                <span id="deleteBtnText">ğŸ—‘ï¸ ì„ íƒí•œ ì—…ì²´ ì‚­ì œ</span> (<span id="selectedCount">0</span>ê°œ)
            </button>
        </div>
    </div>
</div>

<style>
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
.business-item {
    padding: 15px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    transition: background 0.2s;
}
.business-item:hover {
    background: #f5f5f5;
}
.business-item.selected {
    background: #fff3cd;
}
.business-item input[type="checkbox"] {
    margin-right: 10px;
    transform: scale(1.2);
}
</style>

<script>
// ì„¸ë¬´/ë³€í˜¸ ìë™ ì¬ë¶„ë¥˜ ì‹¤í–‰ (CSRF í† í° ì§ì ‘ ì£¼ì…)
const retagCsrfToken = '{{ csrf_token }}';
const retagBtn = document.getElementById('retagTaxLawBtn');
const retagStatus = document.getElementById('retagStatus');

if (retagBtn) {
    retagBtn.addEventListener('click', async () => {
        retagBtn.disabled = true;
        if (retagStatus) retagStatus.textContent = 'ì¬ë¶„ë¥˜ ì‹¤í–‰ ì¤‘...';

        try {
            const response = await fetch('/admin/api/localbusiness/retag-tax-law/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': retagCsrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            const data = await response.json();
            if (!response.ok) {
                throw new Error(data.error || 'ì¬ë¶„ë¥˜ ì‹¤íŒ¨');
            }

            if (retagStatus) {
                retagStatus.textContent = `ì„¸ë¬´ì‚¬ ${data.tax_updated}ê±´, ë³€í˜¸ì‚¬ ${data.lawyer_updated}ê±´ ì—…ë°ì´íŠ¸`;
                retagStatus.style.color = '#2e7d32';
            }
        } catch (err) {
            if (retagStatus) {
                retagStatus.textContent = err.message || 'ì¬ë¶„ë¥˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                retagStatus.style.color = '#d32f2f';
            }
        } finally {
            retagBtn.disabled = false;
        }
    });
}
</script>

<script>
const csrfToken = '{{ csrf_token }}';
let invalidBusinesses = [];

// ê²€ì¦ ëª¨ë“œ ì„ íƒ ì‹œ UI ì—…ë°ì´íŠ¸
document.querySelectorAll('input[name="validation_mode"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const mode = this.value;
        const categoryLabel = document.getElementById('categoryModeLabel');
        const duplicateLabel = document.getElementById('duplicateModeLabel');
        const websiteLabel = document.getElementById('websiteModeLabel');
        const validateBtnText = document.getElementById('validateBtnText');
        const validationInfo = document.getElementById('validationInfo');
        const deleteBtnText = document.getElementById('deleteBtnText');

        // ëª¨ë“  ë¼ë²¨ ì´ˆê¸°í™”
        categoryLabel.style.border = '2px solid #ddd';
        categoryLabel.style.background = 'white';
        duplicateLabel.style.border = '2px solid #ddd';
        duplicateLabel.style.background = 'white';
        websiteLabel.style.border = '2px solid #ddd';
        websiteLabel.style.background = 'white';

        if (mode === 'category') {
            categoryLabel.style.border = '2px solid #2196F3';
            categoryLabel.style.background = '#e3f2fd';
            validateBtnText.textContent = 'ğŸ” ì—…ì¢… ê²€ì¦ ì‹œì‘';
            validationInfo.textContent = 'ì—…ì¢…ì´ ë§ì§€ ì•Šê±°ë‚˜ ê³µê³µê¸°ê´€ìœ¼ë¡œ íŒë‹¨ëœ ì—…ì²´ê°€ í‘œì‹œë©ë‹ˆë‹¤.';
            if (deleteBtnText) deleteBtnText.textContent = 'ğŸ—‘ï¸ ì„ íƒí•œ ì—…ì²´ ì‚­ì œ';
        } else if (mode === 'duplicate') {
            duplicateLabel.style.border = '2px solid #2196F3';
            duplicateLabel.style.background = '#e3f2fd';
            validateBtnText.textContent = 'ğŸ”„ ì¤‘ë³µ ê²€ì¦ ì‹œì‘';
            validationInfo.textContent = 'ì¤‘ë³µëœ ì—…ì²´ëª…ì„ ê°€ì§„ ì—…ì²´ê°€ í‘œì‹œë©ë‹ˆë‹¤.';
            if (deleteBtnText) deleteBtnText.textContent = 'ğŸ—‘ï¸ ì„ íƒí•œ ì—…ì²´ ì‚­ì œ';
        } else {
            websiteLabel.style.border = '2px solid #2196F3';
            websiteLabel.style.background = '#e3f2fd';
            validateBtnText.textContent = 'ğŸŒ ì›¹ì‚¬ì´íŠ¸ ê²€ì¦ ì‹œì‘';
            validationInfo.textContent = 'ìœ íš¨í•˜ì§€ ì•Šê±°ë‚˜ ë§Œë£Œëœ ì›¹ì‚¬ì´íŠ¸ë¥¼ ê°€ì§„ ì—…ì²´ê°€ í‘œì‹œë©ë‹ˆë‹¤.';
            if (deleteBtnText) deleteBtnText.textContent = 'ğŸ”— ì„ íƒí•œ ì›¹ì‚¬ì´íŠ¸ ë§í¬ ì‚­ì œ';
        }
    });
});

// ì „ì²´ ì„ íƒ/í•´ì œ ë²„íŠ¼
document.getElementById('selectAllBtn').addEventListener('click', function() {
    document.querySelectorAll('.region-checkbox').forEach(cb => cb.checked = true);
});

document.getElementById('deselectAllBtn').addEventListener('click', function() {
    document.querySelectorAll('.region-checkbox').forEach(cb => cb.checked = false);
});

// ê·¸ë£¹ë³„ ì „ì²´ ì„ íƒ ë²„íŠ¼
document.querySelectorAll('.group-select-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const groupIndex = this.dataset.group;
        const groupCheckboxes = document.querySelectorAll(`.group-${groupIndex}`);
        const allChecked = Array.from(groupCheckboxes).every(cb => cb.checked);

        // ì „ì²´ ì„ íƒë˜ì–´ ìˆìœ¼ë©´ í•´ì œ, ì•„ë‹ˆë©´ ì „ì²´ ì„ íƒ
        groupCheckboxes.forEach(cb => cb.checked = !allChecked);

        // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
        this.textContent = allChecked ? 'ê·¸ë£¹ ì „ì²´ ì„ íƒ' : 'ê·¸ë£¹ ì „ì²´ í•´ì œ';
    });
});

document.getElementById('validateForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const mode = document.querySelector('input[name="validation_mode"]:checked').value;
    const category = document.getElementById('category').value;
    const selectedRegions = Array.from(document.querySelectorAll('.region-checkbox:checked'))
        .map(cb => cb.value);

    // UI ì´ˆê¸°í™”
    document.getElementById('progressContainer').style.display = 'block';
    document.getElementById('resultContainer').style.display = 'none';
    document.getElementById('validateBtn').disabled = true;

    try {
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', csrfToken);
        formData.append('action', 'validate');
        formData.append('validation_mode', mode);
        formData.append('category', category);

        // ë‹¤ì¤‘ ì§€ì—­ ì „ì†¡
        selectedRegions.forEach(region => {
            formData.append('regions[]', region);
        });

        const response = await fetch('', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        const data = await response.json();

        if (data.status === 'success') {
            invalidBusinesses = data.invalid_businesses;
            displayResults(data);
        } else {
            alert('ì˜¤ë¥˜: ' + data.message);
        }
    } catch (error) {
        alert('ì˜¤ë¥˜ ë°œìƒ: ' + error);
    } finally {
        document.getElementById('progressContainer').style.display = 'none';
        document.getElementById('validateBtn').disabled = false;
    }
});

function displayResults(data) {
    document.getElementById('resultContainer').style.display = 'block';
    document.getElementById('totalChecked').textContent = data.total_checked;
    document.getElementById('invalidCount').textContent = data.invalid_count;

    const invalidList = document.getElementById('invalidList');
    invalidList.innerHTML = '';

    if (data.invalid_count === 0) {
        invalidList.innerHTML = '<div style="padding: 20px; text-align: center; color: #4CAF50;">âœ… ëª¨ë“  ì—…ì²´ê°€ ì˜¬ë°”ë¥´ê²Œ ë¶„ë¥˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤!</div>';
        document.getElementById('deleteSection').style.display = 'none';
    } else {
        const mode = document.querySelector('input[name="validation_mode"]:checked').value;

        data.invalid_businesses.forEach(business => {
            const item = document.createElement('div');
            item.className = 'business-item';

            let detailHtml = '';
            if (mode === 'website') {
                // ì›¹ì‚¬ì´íŠ¸ ê²€ì¦ ëª¨ë“œ: URL í´ë¦­ ê°€ëŠ¥í•˜ê²Œ í‘œì‹œ
                detailHtml = `
                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">
                        ${business.region} | ${business.address}
                    </div>
                    <div style="font-size: 12px;">
                        <span style="color: #f44336;">âŒ ë¬¸ì œ: ${business.issue || 'ìœ íš¨í•˜ì§€ ì•Šì€ ì›¹ì‚¬ì´íŠ¸'}</span>
                    </div>
                    ${business.website_url ? `
                        <div style="margin-top: 5px;">
                            <a href="${business.website_url}" target="_blank" rel="noopener noreferrer"
                               style="color: #2196F3; text-decoration: none; font-size: 12px; display: inline-flex; align-items: center; gap: 4px;"
                               onclick="event.stopPropagation();">
                                ğŸŒ ${business.website_url}
                                <span style="font-size: 10px;">â†—</span>
                            </a>
                        </div>
                    ` : ''}
                `;
            } else {
                // ì—…ì¢… ê²€ì¦ ëª¨ë“œ: ê¸°ì¡´ ë°©ì‹
                detailHtml = `
                    <div style="font-size: 12px; color: #666;">
                        <span style="color: #f44336;">âŒ ì—…ì¢…: ${business.category}</span> |
                        ${business.region} |
                        ${business.address}
                    </div>
                `;
            }

            item.innerHTML = `
                <label style="display: flex; align-items: start; cursor: pointer;">
                    <input type="checkbox" class="business-checkbox" data-id="${business.id}">
                    <div style="flex: 1;">
                        <div style="font-weight: bold; margin-bottom: 5px;">${business.name}</div>
                        ${detailHtml}
                    </div>
                </label>
            `;
            item.addEventListener('click', function(e) {
                if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'A') {
                    const checkbox = item.querySelector('input[type="checkbox"]');
                    checkbox.checked = !checkbox.checked;
                    updateSelectedCount();
                }
            });
            invalidList.appendChild(item);
        });

        document.getElementById('deleteSection').style.display = 'block';

        // ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸
        document.querySelectorAll('.business-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', updateSelectedCount);
        });
    }
}

function updateSelectedCount() {
    const selected = document.querySelectorAll('.business-checkbox:checked');
    document.getElementById('selectedCount').textContent = selected.length;
    document.getElementById('deleteBtn').disabled = selected.length === 0;
}

document.getElementById('deleteBtn').addEventListener('click', async function() {
    const selected = document.querySelectorAll('.business-checkbox:checked');
    const mode = document.querySelector('input[name="validation_mode"]:checked').value;

    if (selected.length === 0) {
        alert(mode === 'website' ? 'ì‚­ì œí•  ì›¹ì‚¬ì´íŠ¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!' : 'ì‚­ì œí•  ì—…ì²´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
        return;
    }

    const confirmMsg = mode === 'website'
        ? `ì •ë§ ${selected.length}ê°œ ì—…ì²´ì˜ ì›¹ì‚¬ì´íŠ¸ ë§í¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì—…ì²´ëŠ” ìœ ì§€ë˜ê³  ì›¹ì‚¬ì´íŠ¸ URLë§Œ ë¹„ì›Œì§‘ë‹ˆë‹¤)`
        : `ì •ë§ ${selected.length}ê°œ ì—…ì²´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;

    if (!confirm(confirmMsg)) {
        return;
    }

    const businessIds = Array.from(selected).map(cb => cb.dataset.id);

    try {
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', csrfToken);
        formData.append('action', 'delete');
        formData.append('validation_mode', mode);
        businessIds.forEach(id => formData.append('business_ids[]', id));

        const response = await fetch('', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        const data = await response.json();

        if (data.status === 'success') {
            const successMsg = mode === 'website'
                ? `${data.deleted_count}ê°œ ì—…ì²´ì˜ ì›¹ì‚¬ì´íŠ¸ ë§í¬ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!`
                : `${data.deleted_count}ê°œ ì—…ì²´ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!`;
            alert(successMsg);

            // ì‚­ì œëœ í•­ëª© ì œê±°
            selected.forEach(cb => {
                cb.closest('.business-item').remove();
            });
            // ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
            const remaining = document.querySelectorAll('.business-item').length;
            document.getElementById('invalidCount').textContent = remaining;
            if (remaining === 0) {
                const completeMsg = mode === 'website'
                    ? 'âœ… ëª¨ë“  ìœ íš¨í•˜ì§€ ì•Šì€ ì›¹ì‚¬ì´íŠ¸ ë§í¬ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!'
                    : 'âœ… ëª¨ë“  ì˜ëª» ë¶„ë¥˜ëœ ì—…ì²´ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!';
                document.getElementById('invalidList').innerHTML = `<div style="padding: 20px; text-align: center; color: #4CAF50;">${completeMsg}</div>`;
                document.getElementById('deleteSection').style.display = 'none';
            }
        } else {
            alert('ì˜¤ë¥˜: ' + data.message);
        }
    } catch (error) {
        alert('ì˜¤ë¥˜ ë°œìƒ: ' + error);
    }
});
</script>
{% endblock %}
