{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}ì—…ì²´ ë°ì´í„° ê²€ì¦ (OpenAI){% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">í™ˆ</a>
    &rsaquo; <a href="{% url 'admin:api_localbusiness_changelist' %}">ì§€ì—­ ì—…ì²´</a>
    &rsaquo; ë°ì´í„° ê²€ì¦
</div>
{% endblock %}

{% block content %}
<div style="max-width: 1000px; margin: 20px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
    <h1 style="margin-bottom: 20px;">ğŸ¤– ì—…ì²´ ë°ì´í„° ê²€ì¦ (OpenAI)</h1>

    <div style="background: #fff3cd; border: 1px solid #ffc107; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
        <strong>âš ï¸ ì£¼ì˜ì‚¬í•­</strong>
        <ul style="margin: 10px 0 0 20px;">
            <li>OpenAI APIë¥¼ ì‚¬ìš©í•˜ì—¬ ì—…ì²´ëª…ê³¼ ì—…ì¢…ì´ ì¼ì¹˜í•˜ëŠ”ì§€ ê²€ì¦í•©ë‹ˆë‹¤.</li>
            <li>í•œ ë²ˆì— ìµœëŒ€ 50ê°œ ì—…ì²´ë¥¼ ê²€ì¦í•©ë‹ˆë‹¤.</li>
            <li>ê²€ì¦ ì‹œê°„: ì•½ 1~2ë¶„ (ì—…ì²´ ìˆ˜ì— ë”°ë¼ ë‹¤ë¦„)</li>
            <li>ì˜ëª» ë¶„ë¥˜ëœ ê²ƒìœ¼ë¡œ íŒë‹¨ëœ ì—…ì²´ëŠ” ëª©ë¡ì— í‘œì‹œë©ë‹ˆë‹¤.</li>
        </ul>
    </div>

    <form id="validateForm" style="margin-top: 20px;">
        {% csrf_token %}

        <div style="margin-bottom: 20px;">
            <label for="category" style="display: block; margin-bottom: 5px; font-weight: bold;">ì—…ì¢… ì„ íƒ (í•„ìˆ˜)</label>
            <select name="category" id="category" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="">-- ì—…ì¢…ì„ ì„ íƒí•˜ì„¸ìš” --</option>
                {% for cat in categories %}
                <option value="{{ cat.id }}">{{ cat.icon }} {{ cat.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div style="margin-bottom: 20px;">
            <label for="region" style="display: block; margin-bottom: 5px; font-weight: bold;">ì§€ì—­ ì„ íƒ (ì„ íƒì‚¬í•­)</label>
            <select name="region" id="region" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="">-- ì „ì²´ ì§€ì—­ --</option>
                {% for group in region_groups %}
                    <optgroup label="{{ group.name }}">
                        {% for region in group.regions %}
                        <option value="{{ region }}">{{ region }}</option>
                        {% endfor %}
                    </optgroup>
                {% endfor %}
            </select>
        </div>

        <button type="submit" id="validateBtn"
                style="width: 100%; padding: 12px 24px; background: #FF9800; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: bold;">
            ğŸ” ê²€ì¦ ì‹œì‘
        </button>
    </form>

    <!-- ê²€ì¦ ì§„í–‰ ìƒí™© -->
    <div id="progressContainer" style="display: none; margin-top: 30px; padding: 20px; background: #f5f5f5; border-radius: 8px;">
        <h3 style="margin-bottom: 15px;">ğŸ”„ ê²€ì¦ ì§„í–‰ ì¤‘...</h3>
        <div style="text-align: center; padding: 20px;">
            <div class="spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #FF9800; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto;"></div>
            <p style="margin-top: 15px; color: #666;">OpenAIë¡œ ì—…ì²´ ê²€ì¦ ì¤‘...</p>
        </div>
    </div>

    <!-- ê²€ì¦ ê²°ê³¼ -->
    <div id="resultContainer" style="display: none; margin-top: 30px;">
        <h3 style="margin-bottom: 15px;">ğŸ“Š ê²€ì¦ ê²°ê³¼</h3>

        <div style="background: #e3f2fd; border: 1px solid #2196F3; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-around; text-align: center;">
                <div>
                    <div style="font-size: 24px; font-weight: bold; color: #2196F3;" id="totalChecked">0</div>
                    <div style="color: #666; font-size: 12px;">ê²€ì¦í•œ ì—…ì²´</div>
                </div>
                <div>
                    <div style="font-size: 24px; font-weight: bold; color: #f44336;" id="invalidCount">0</div>
                    <div style="color: #666; font-size: 12px;">ì˜ëª» ë¶„ë¥˜ë¨</div>
                </div>
            </div>
        </div>

        <!-- ì˜ëª» ë¶„ë¥˜ëœ ì—…ì²´ ëª©ë¡ -->
        <div id="invalidList" style="background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 400px; overflow-y: auto;">
            <!-- JavaScriptë¡œ ì±„ì›Œì§ -->
        </div>

        <div id="deleteSection" style="display: none; margin-top: 20px;">
            <button id="deleteBtn"
                    style="width: 100%; padding: 12px 24px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: bold;">
                ğŸ—‘ï¸ ì„ íƒí•œ ì—…ì²´ ì‚­ì œ (<span id="selectedCount">0</span>ê°œ)
            </button>
        </div>
    </div>
</div>

<style>
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
.business-item {
    padding: 15px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    transition: background 0.2s;
}
.business-item:hover {
    background: #f5f5f5;
}
.business-item.selected {
    background: #fff3cd;
}
.business-item input[type="checkbox"] {
    margin-right: 10px;
    transform: scale(1.2);
}
</style>

<script>
const csrfToken = '{{ csrf_token }}';
let invalidBusinesses = [];

document.getElementById('validateForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const category = document.getElementById('category').value;
    const region = document.getElementById('region').value;

    if (!category) {
        alert('ì—…ì¢…ì„ ì„ íƒí•´ì£¼ì„¸ìš”!');
        return;
    }

    // UI ì´ˆê¸°í™”
    document.getElementById('progressContainer').style.display = 'block';
    document.getElementById('resultContainer').style.display = 'none';
    document.getElementById('validateBtn').disabled = true;

    try {
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', csrfToken);
        formData.append('action', 'validate');
        formData.append('category', category);
        formData.append('region', region);

        const response = await fetch('', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        const data = await response.json();

        if (data.status === 'success') {
            invalidBusinesses = data.invalid_businesses;
            displayResults(data);
        } else {
            alert('ì˜¤ë¥˜: ' + data.message);
        }
    } catch (error) {
        alert('ì˜¤ë¥˜ ë°œìƒ: ' + error);
    } finally {
        document.getElementById('progressContainer').style.display = 'none';
        document.getElementById('validateBtn').disabled = false;
    }
});

function displayResults(data) {
    document.getElementById('resultContainer').style.display = 'block';
    document.getElementById('totalChecked').textContent = data.total_checked;
    document.getElementById('invalidCount').textContent = data.invalid_count;

    const invalidList = document.getElementById('invalidList');
    invalidList.innerHTML = '';

    if (data.invalid_count === 0) {
        invalidList.innerHTML = '<div style="padding: 20px; text-align: center; color: #4CAF50;">âœ… ëª¨ë“  ì—…ì²´ê°€ ì˜¬ë°”ë¥´ê²Œ ë¶„ë¥˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤!</div>';
        document.getElementById('deleteSection').style.display = 'none';
    } else {
        data.invalid_businesses.forEach(business => {
            const item = document.createElement('div');
            item.className = 'business-item';
            item.innerHTML = `
                <label style="display: flex; align-items: start; cursor: pointer;">
                    <input type="checkbox" class="business-checkbox" data-id="${business.id}">
                    <div style="flex: 1;">
                        <div style="font-weight: bold; margin-bottom: 5px;">${business.name}</div>
                        <div style="font-size: 12px; color: #666;">
                            <span style="color: #f44336;">âŒ ì—…ì¢…: ${business.category}</span> |
                            ${business.region} |
                            ${business.address}
                        </div>
                    </div>
                </label>
            `;
            item.addEventListener('click', function(e) {
                if (e.target.tagName !== 'INPUT') {
                    const checkbox = item.querySelector('input[type="checkbox"]');
                    checkbox.checked = !checkbox.checked;
                    updateSelectedCount();
                }
            });
            invalidList.appendChild(item);
        });

        document.getElementById('deleteSection').style.display = 'block';

        // ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸
        document.querySelectorAll('.business-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', updateSelectedCount);
        });
    }
}

function updateSelectedCount() {
    const selected = document.querySelectorAll('.business-checkbox:checked');
    document.getElementById('selectedCount').textContent = selected.length;
    document.getElementById('deleteBtn').disabled = selected.length === 0;
}

document.getElementById('deleteBtn').addEventListener('click', async function() {
    const selected = document.querySelectorAll('.business-checkbox:checked');

    if (selected.length === 0) {
        alert('ì‚­ì œí•  ì—…ì²´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
        return;
    }

    if (!confirm(`ì •ë§ ${selected.length}ê°œ ì—…ì²´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
    }

    const businessIds = Array.from(selected).map(cb => cb.dataset.id);

    try {
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', csrfToken);
        formData.append('action', 'delete');
        businessIds.forEach(id => formData.append('business_ids[]', id));

        const response = await fetch('', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        const data = await response.json();

        if (data.status === 'success') {
            alert(`${data.deleted_count}ê°œ ì—…ì²´ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!`);
            // ì‚­ì œëœ í•­ëª© ì œê±°
            selected.forEach(cb => {
                cb.closest('.business-item').remove();
            });
            // ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
            const remaining = document.querySelectorAll('.business-item').length;
            document.getElementById('invalidCount').textContent = remaining;
            if (remaining === 0) {
                document.getElementById('invalidList').innerHTML = '<div style="padding: 20px; text-align: center; color: #4CAF50;">âœ… ëª¨ë“  ì˜ëª» ë¶„ë¥˜ëœ ì—…ì²´ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!</div>';
                document.getElementById('deleteSection').style.display = 'none';
            }
        } else {
            alert('ì˜¤ë¥˜: ' + data.message);
        }
    } catch (error) {
        alert('ì˜¤ë¥˜ ë°œìƒ: ' + error);
    }
});
</script>
{% endblock %}
