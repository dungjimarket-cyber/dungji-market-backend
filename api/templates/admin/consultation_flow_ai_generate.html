{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}ìƒë‹´ í”Œë¡œìš° ê´€ë¦¬{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">í™ˆ</a>
    &rsaquo; <a href="{% url 'admin:api_consultationflow_changelist' %}">ìƒë‹´ ì§ˆë¬¸ í”Œë¡œìš°</a>
    &rsaquo; í”Œë¡œìš° ê´€ë¦¬
</div>
{% endblock %}

{% block content %}
<style>
    .ai-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }
    .ai-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 30px;
    }
    .ai-header h1 {
        margin: 0;
        font-size: 24px;
    }
    .ai-badge {
        background: linear-gradient(135deg, #8b5cf6, #6366f1);
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
    }
    .ai-grid {
        display: grid;
        grid-template-columns: 350px 1fr;
        gap: 30px;
    }
    @media (max-width: 1024px) {
        .ai-grid {
            grid-template-columns: 1fr;
        }
    }
    .ai-form-section {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 24px;
        position: sticky;
        top: 20px;
        height: fit-content;
    }
    .ai-form-section h2 {
        margin: 0 0 20px 0;
        font-size: 18px;
        color: #374151;
    }
    .form-group {
        margin-bottom: 20px;
    }
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #374151;
    }
    .form-group select,
    .form-group textarea,
    .form-group input[type="text"] {
        width: 100%;
        padding: 12px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.2s, box-shadow 0.2s;
        box-sizing: border-box;
    }
    .form-group select:focus,
    .form-group textarea:focus,
    .form-group input[type="text"]:focus {
        outline: none;
        border-color: #8b5cf6;
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }
    .form-group textarea {
        min-height: 100px;
        resize: vertical;
    }
    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .checkbox-group input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }
    .checkbox-group label {
        margin: 0;
        cursor: pointer;
    }
    .btn {
        width: 100%;
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-bottom: 10px;
    }
    .btn-generate {
        background: linear-gradient(135deg, #8b5cf6, #6366f1);
        color: white;
    }
    .btn-generate:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
    }
    .btn-load {
        background: #f3f4f6;
        color: #374151;
        border: 1px solid #d1d5db;
    }
    .btn-load:hover {
        background: #e5e7eb;
    }
    .btn-save {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
    }
    .btn-save:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    .btn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    .spinner {
        width: 18px;
        height: 18px;
        border: 2px solid rgba(255,255,255,0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    .editor-section {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 24px;
    }
    .editor-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    .editor-header h2 {
        margin: 0;
        font-size: 18px;
        color: #374151;
    }
    .editor-actions {
        display: flex;
        gap: 10px;
    }
    .btn-sm {
        padding: 8px 16px;
        font-size: 13px;
        width: auto;
        margin: 0;
    }
    .btn-add {
        background: #3b82f6;
        color: white;
    }
    .message {
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .message.success {
        background: #d1fae5;
        color: #065f46;
        border: 1px solid #6ee7b7;
    }
    .message.error {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #fca5a5;
    }
    .hint {
        background: #eff6ff;
        border: 1px solid #bfdbfe;
        border-radius: 8px;
        padding: 12px 16px;
        margin-bottom: 20px;
        font-size: 13px;
        color: #1e40af;
    }
    .flow-card {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 16px;
        position: relative;
    }
    .flow-card.editing {
        border-color: #8b5cf6;
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }
    .flow-card-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
    }
    .flow-step-badge {
        width: 32px;
        height: 32px;
        background: #8b5cf6;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: bold;
        flex-shrink: 0;
    }
    .flow-question-input {
        flex: 1;
        padding: 10px 14px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 15px;
        font-weight: 500;
    }
    .flow-card-actions {
        display: flex;
        gap: 8px;
        margin-left: auto;
    }
    .btn-icon {
        width: 32px;
        height: 32px;
        padding: 0;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        background: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        transition: all 0.2s;
    }
    .btn-icon:hover {
        background: #f3f4f6;
    }
    .btn-icon.delete:hover {
        background: #fee2e2;
        border-color: #fca5a5;
        color: #dc2626;
    }
    .flow-settings {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
        margin-bottom: 16px;
        padding: 12px;
        background: white;
        border-radius: 6px;
    }
    .flow-setting {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    .flow-setting label {
        font-size: 11px;
        color: #6b7280;
        font-weight: 600;
    }
    .flow-setting select,
    .flow-setting input {
        padding: 6px 10px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        font-size: 13px;
    }
    .options-container {
        margin-top: 12px;
    }
    .options-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    .options-header h4 {
        margin: 0;
        font-size: 13px;
        color: #6b7280;
    }
    .option-row {
        display: grid;
        grid-template-columns: 80px 40px 1fr 1fr 80px 40px;
        gap: 8px;
        align-items: center;
        margin-bottom: 8px;
        padding: 10px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
    }
    .option-row.custom-input {
        background: #eff6ff;
        border-color: #bfdbfe;
    }
    .option-row input {
        padding: 6px 10px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        font-size: 13px;
    }
    .option-row .btn-icon {
        width: 28px;
        height: 28px;
        font-size: 14px;
    }
    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 300px;
        color: #9ca3af;
        text-align: center;
    }
    .empty-state svg {
        width: 64px;
        height: 64px;
        margin-bottom: 16px;
        opacity: 0.5;
    }
    .divider {
        height: 1px;
        background: #e5e7eb;
        margin: 20px 0;
    }
</style>

<div class="ai-container">
    <div class="ai-header">
        <h1>ìƒë‹´ í”Œë¡œìš° ê´€ë¦¬</h1>
        <span class="ai-badge">GPT-4o</span>
    </div>

    <div id="message-container"></div>

    <div class="ai-grid">
        <div class="ai-form-section">
            <h2>1. ì¹´í…Œê³ ë¦¬ ì„ íƒ</h2>

            <div class="form-group">
                <label for="category">ì¹´í…Œê³ ë¦¬ *</label>
                <select id="category" name="category" required>
                    <option value="">-- ì¹´í…Œê³ ë¦¬ ì„ íƒ --</option>
                    {% for cat in categories %}
                    <option value="{{ cat.id }}" data-name="{{ cat.name }}">{{ cat.icon }} {{ cat.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <button type="button" class="btn btn-load" id="loadBtn">
                ğŸ“¥ ê¸°ì¡´ í”Œë¡œìš° ë¶ˆëŸ¬ì˜¤ê¸°
            </button>

            <div class="divider"></div>

            <h2>2. AI ìƒì„± (ì„ íƒ)</h2>

            <div class="form-group">
                <label for="prompt">AI ì§€ì‹œì‚¬í•­</label>
                <textarea id="prompt" name="prompt"
                    placeholder="ì˜ˆ: ê¸°ì—… ê³ ê° ëŒ€ìƒ ì§ˆë¬¸ë„ í¬í•¨, ì„¸ê¸ˆ ê´€ë ¨ ì§ˆë¬¸ ë” ìƒì„¸í•˜ê²Œ"></textarea>
            </div>

            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="replace_existing" name="replace_existing">
                    <label for="replace_existing">ê¸°ì¡´ í”Œë¡œìš° ì‚­ì œ í›„ ìƒˆë¡œ ìƒì„±</label>
                </div>
            </div>

            <button type="button" class="btn btn-generate" id="generateBtn">
                ğŸ¤– AIë¡œ í”Œë¡œìš° ìƒì„±
            </button>

            <div class="divider"></div>

            <h2>3. ì €ì¥</h2>

            <button type="button" class="btn btn-save" id="saveBtn">
                ğŸ’¾ ë³€ê²½ì‚¬í•­ ì €ì¥
            </button>
        </div>

        <div class="editor-section">
            <div class="editor-header">
                <h2>
                    í”Œë¡œìš° í¸ì§‘ê¸°
                    <span id="editor-category-name" style="font-weight: normal; color: #8b5cf6;"></span>
                </h2>
                <div class="editor-actions">
                    <button type="button" class="btn btn-sm btn-add" id="addFlowBtn">
                        + ì§ˆë¬¸ ì¶”ê°€
                    </button>
                </div>
            </div>

            <div id="flows-editor">
                <div class="empty-state" id="empty-state">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                    </svg>
                    <p>ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ê³  í”Œë¡œìš°ë¥¼ ë¶ˆëŸ¬ì˜¤ê±°ë‚˜<br>AIë¡œ ìƒˆë¡œ ìƒì„±í•˜ì„¸ìš”</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentCategoryId = null;
    let currentCategoryName = '';
    let flowsData = [];

    const categorySelect = document.getElementById('category');
    const loadBtn = document.getElementById('loadBtn');
    const generateBtn = document.getElementById('generateBtn');
    const saveBtn = document.getElementById('saveBtn');
    const addFlowBtn = document.getElementById('addFlowBtn');
    const messageContainer = document.getElementById('message-container');

    // ë©”ì‹œì§€ í‘œì‹œ
    function showMessage(text, type) {
        messageContainer.innerHTML = `
            <div class="message ${type}">
                ${type === 'success' ? 'âœ…' : 'âŒ'} ${text}
            </div>
        `;
        setTimeout(() => messageContainer.innerHTML = '', 5000);
    }

    // í”Œë¡œìš° ì—ë””í„° ë Œë”ë§
    function renderEditor() {
        const editor = document.getElementById('flows-editor');
        const emptyState = document.getElementById('empty-state');
        const categoryNameEl = document.getElementById('editor-category-name');

        if (!flowsData || flowsData.length === 0) {
            emptyState.style.display = 'flex';
            categoryNameEl.textContent = currentCategoryName ? `- ${currentCategoryName}` : '';
            editor.innerHTML = '';
            editor.appendChild(emptyState);
            return;
        }

        categoryNameEl.textContent = `- ${currentCategoryName}`;

        editor.innerHTML = flowsData.map((flow, flowIndex) => `
            <div class="flow-card" data-index="${flowIndex}">
                <div class="flow-card-header">
                    <span class="flow-step-badge">${flow.step_number || flowIndex + 1}</span>
                    <input type="text" class="flow-question-input"
                           value="${escapeHtml(flow.question)}"
                           placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”"
                           onchange="updateFlow(${flowIndex}, 'question', this.value)">
                    <div class="flow-card-actions">
                        <button type="button" class="btn-icon" onclick="moveFlow(${flowIndex}, -1)" title="ìœ„ë¡œ">â¬†ï¸</button>
                        <button type="button" class="btn-icon" onclick="moveFlow(${flowIndex}, 1)" title="ì•„ë˜ë¡œ">â¬‡ï¸</button>
                        <button type="button" class="btn-icon delete" onclick="deleteFlow(${flowIndex})" title="ì‚­ì œ">ğŸ—‘ï¸</button>
                    </div>
                </div>

                <div class="flow-settings">
                    <div class="flow-setting">
                        <label>Step ë²ˆí˜¸</label>
                        <input type="number" value="${flow.step_number || flowIndex + 1}" min="1"
                               onchange="updateFlow(${flowIndex}, 'step_number', parseInt(this.value))">
                    </div>
                    <div class="flow-setting">
                        <label>í•„ìˆ˜ ì—¬ë¶€</label>
                        <select onchange="updateFlow(${flowIndex}, 'is_required', this.value === 'true')">
                            <option value="true" ${flow.is_required !== false ? 'selected' : ''}>í•„ìˆ˜</option>
                            <option value="false" ${flow.is_required === false ? 'selected' : ''}>ì„ íƒ</option>
                        </select>
                    </div>
                    <div class="flow-setting">
                        <label>ì˜ì¡´ Step</label>
                        <select onchange="updateFlow(${flowIndex}, 'depends_on_step', this.value ? parseInt(this.value) : null)">
                            <option value="">ì—†ìŒ</option>
                            ${flowsData.filter((_, i) => i < flowIndex).map(f =>
                                `<option value="${f.step_number}" ${flow.depends_on_step === f.step_number ? 'selected' : ''}>
                                    Step ${f.step_number}
                                </option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="flow-setting">
                        <label>ì˜ì¡´ ì˜µì…˜ (ì½¤ë§ˆ)</label>
                        <input type="text" value="${(flow.depends_on_options || []).join(', ')}"
                               placeholder="option1, option2"
                               onchange="updateFlow(${flowIndex}, 'depends_on_options', this.value.split(',').map(s=>s.trim()).filter(Boolean))">
                    </div>
                </div>

                <div class="options-container">
                    <div class="options-header">
                        <h4>ì„ íƒì§€</h4>
                        <button type="button" class="btn-icon" onclick="addOption(${flowIndex})" title="ì„ íƒì§€ ì¶”ê°€">â•</button>
                    </div>
                    ${(flow.options || []).map((opt, optIndex) => `
                        <div class="option-row ${opt.is_custom_input ? 'custom-input' : ''}">
                            <input type="text" value="${escapeHtml(opt.key)}" placeholder="key"
                                   onchange="updateOption(${flowIndex}, ${optIndex}, 'key', this.value)">
                            <input type="text" value="${escapeHtml(opt.icon || '')}" placeholder="ğŸ”¹" style="text-align:center;"
                                   onchange="updateOption(${flowIndex}, ${optIndex}, 'icon', this.value)">
                            <input type="text" value="${escapeHtml(opt.label)}" placeholder="ë¼ë²¨"
                                   onchange="updateOption(${flowIndex}, ${optIndex}, 'label', this.value)">
                            <input type="text" value="${escapeHtml(opt.description || '')}" placeholder="ì„¤ëª…"
                                   onchange="updateOption(${flowIndex}, ${optIndex}, 'description', this.value)">
                            <select onchange="updateOption(${flowIndex}, ${optIndex}, 'is_custom_input', this.value === 'true')">
                                <option value="false" ${!opt.is_custom_input ? 'selected' : ''}>ì¼ë°˜</option>
                                <option value="true" ${opt.is_custom_input ? 'selected' : ''}>ì§ì ‘ì…ë ¥</option>
                            </select>
                            <button type="button" class="btn-icon delete" onclick="deleteOption(${flowIndex}, ${optIndex})" title="ì‚­ì œ">ğŸ—‘ï¸</button>
                        </div>
                    `).join('')}
                </div>
            </div>
        `).join('');
    }

    // HTML ì´ìŠ¤ì¼€ì´í”„
    function escapeHtml(str) {
        if (!str) return '';
        return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    // í”Œë¡œìš° ì—…ë°ì´íŠ¸
    window.updateFlow = function(index, field, value) {
        flowsData[index][field] = value;
    };

    // ì˜µì…˜ ì—…ë°ì´íŠ¸
    window.updateOption = function(flowIndex, optIndex, field, value) {
        flowsData[flowIndex].options[optIndex][field] = value;
        if (field === 'is_custom_input') {
            renderEditor();
        }
    };

    // í”Œë¡œìš° ì´ë™
    window.moveFlow = function(index, direction) {
        const newIndex = index + direction;
        if (newIndex < 0 || newIndex >= flowsData.length) return;

        [flowsData[index], flowsData[newIndex]] = [flowsData[newIndex], flowsData[index]];

        // step_number ì¬ì •ë ¬
        flowsData.forEach((f, i) => f.step_number = i + 1);
        renderEditor();
    };

    // í”Œë¡œìš° ì‚­ì œ
    window.deleteFlow = function(index) {
        if (!confirm('ì´ ì§ˆë¬¸ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        flowsData.splice(index, 1);
        flowsData.forEach((f, i) => f.step_number = i + 1);
        renderEditor();
    };

    // ì˜µì…˜ ì¶”ê°€
    window.addOption = function(flowIndex) {
        flowsData[flowIndex].options.push({
            key: 'new_option',
            label: 'ìƒˆ ì„ íƒì§€',
            icon: 'ğŸ“‹',
            description: '',
            is_custom_input: false
        });
        renderEditor();
    };

    // ì˜µì…˜ ì‚­ì œ
    window.deleteOption = function(flowIndex, optIndex) {
        flowsData[flowIndex].options.splice(optIndex, 1);
        renderEditor();
    };

    // í”Œë¡œìš° ì¶”ê°€
    addFlowBtn.addEventListener('click', function() {
        if (!currentCategoryId) {
            showMessage('ë¨¼ì € ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
            return;
        }

        flowsData.push({
            step_number: flowsData.length + 1,
            question: '',
            is_required: true,
            depends_on_step: null,
            depends_on_options: [],
            options: [
                { key: 'custom', label: 'ì§ì ‘ ì…ë ¥', icon: 'âœï¸', description: '', is_custom_input: true }
            ]
        });
        renderEditor();
    });

    // ê¸°ì¡´ í”Œë¡œìš° ë¶ˆëŸ¬ì˜¤ê¸°
    loadBtn.addEventListener('click', async function() {
        currentCategoryId = categorySelect.value;
        currentCategoryName = categorySelect.selectedOptions[0]?.dataset.name || '';

        if (!currentCategoryId) {
            showMessage('ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
            return;
        }

        loadBtn.disabled = true;
        loadBtn.innerHTML = '<div class="spinner" style="border-color: rgba(0,0,0,0.2); border-top-color: #374151;"></div> ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';

        try {
            const response = await fetch(`/admin/api/consultationflow/preview/${currentCategoryId}/`);
            const data = await response.json();

            if (response.ok) {
                flowsData = data.flows || [];
                renderEditor();
                showMessage(`${currentCategoryName} í”Œë¡œìš°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤. (${flowsData.length}ê°œ ì§ˆë¬¸)`, 'success');
            } else {
                showMessage(data.error || 'í”Œë¡œìš°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        } catch (error) {
            showMessage('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        } finally {
            loadBtn.disabled = false;
            loadBtn.innerHTML = 'ğŸ“¥ ê¸°ì¡´ í”Œë¡œìš° ë¶ˆëŸ¬ì˜¤ê¸°';
        }
    });

    // AI ìƒì„±
    generateBtn.addEventListener('click', async function() {
        currentCategoryId = categorySelect.value;
        currentCategoryName = categorySelect.selectedOptions[0]?.dataset.name || '';

        if (!currentCategoryId) {
            showMessage('ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
            return;
        }

        const prompt = document.getElementById('prompt').value;
        const replaceExisting = document.getElementById('replace_existing').checked;

        generateBtn.disabled = true;
        generateBtn.innerHTML = '<div class="spinner"></div> ìƒì„± ì¤‘...';

        try {
            const response = await fetch('{% url "admin:consultation_flow_ai_generate_run" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    category_id: currentCategoryId,
                    prompt: prompt,
                    replace_existing: replaceExisting
                })
            });

            const data = await response.json();

            if (response.ok && data.success) {
                flowsData = data.flows || [];
                renderEditor();
                showMessage(data.message, 'success');
            } else {
                showMessage(data.error || 'ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        } catch (error) {
            showMessage('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
        } finally {
            generateBtn.disabled = false;
            generateBtn.innerHTML = 'ğŸ¤– AIë¡œ í”Œë¡œìš° ìƒì„±';
        }
    });

    // ì €ì¥
    saveBtn.addEventListener('click', async function() {
        if (!currentCategoryId) {
            showMessage('ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
            return;
        }

        if (flowsData.length === 0) {
            showMessage('ì €ì¥í•  í”Œë¡œìš°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
            return;
        }

        // ìœ íš¨ì„± ê²€ì‚¬
        for (let i = 0; i < flowsData.length; i++) {
            if (!flowsData[i].question || !flowsData[i].question.trim()) {
                showMessage(`${i+1}ë²ˆ ì§ˆë¬¸ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.`, 'error');
                return;
            }
        }

        saveBtn.disabled = true;
        saveBtn.innerHTML = '<div class="spinner"></div> ì €ì¥ ì¤‘...';

        try {
            const response = await fetch('{% url "admin:consultation_flow_bulk_save" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    category_id: currentCategoryId,
                    flows: flowsData
                })
            });

            const data = await response.json();

            if (response.ok && data.success) {
                showMessage(data.message, 'success');
                // ì €ì¥ í›„ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
                loadBtn.click();
            } else {
                showMessage(data.error || 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        } catch (error) {
            showMessage('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
        } finally {
            saveBtn.disabled = false;
            saveBtn.innerHTML = 'ğŸ’¾ ë³€ê²½ì‚¬í•­ ì €ì¥';
        }
    });

    // ì¹´í…Œê³ ë¦¬ ë³€ê²½ ì‹œ
    categorySelect.addEventListener('change', function() {
        currentCategoryId = this.value;
        currentCategoryName = this.selectedOptions[0]?.dataset.name || '';
    });
});
</script>
{% endblock %}
