name: Deploy Backend to EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©

# ë™ì‹œ ì‹¤í–‰ ì œí•œ - ì´ì „ ë°°í¬ê°€ ì§„í–‰ ì¤‘ì´ë©´ ì·¨ì†Œí•˜ê³  ìƒˆë¡œìš´ ë°°í¬ ì‹œì‘
concurrency:
  group: production-deploy
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production  # ì´ ì„¤ì •ì´ queued ìƒíƒœë¥¼ ìœ ë°œí•  ìˆ˜ ìˆìŒ

    steps:
    - name: Checkout source
      uses: actions/checkout@v4

    - name: Validate secrets
      run: |
        echo "Validating required secrets..."
        if [ -z "${{ secrets.EC2_HOST }}" ]; then
          echo "âŒ EC2_HOST secret is not set!"
          exit 1
        fi
        if [ -z "${{ secrets.EC2_SSH_KEY }}" ]; then
          echo "âŒ EC2_SSH_KEY secret is not set!"
          exit 1
        fi
        echo "âœ… All required secrets are configured"

    - name: Prepare files for deployment
      run: |
        # ë°°í¬ìš© ì„ì‹œ ë””ë ‰í† ë¦¬ ìƒì„±
        mkdir -p deploy-files
        # í•„ìš”í•œ íŒŒì¼ë§Œ ë³µì‚¬ (venv, .git, .next ë“± ì œì™¸)
        rsync -av --exclude='venv/' \
                  --exclude='__pycache__/' \
                  --exclude='*.pyc' \
                  --exclude='*.log' \
                  --exclude='.DS_Store' \
                  --exclude='node_modules/' \
                  --exclude='.env' \
                  --exclude='*.sqlite3' \
                  --exclude='db.sqlite3' \
                  --exclude='server_new.log' \
                  --exclude='.next/' \
                  --exclude='deploy-files/' \
                  ./ deploy-files/
        echo "âœ… Files prepared for deployment"
        du -sh deploy-files/
        # ë””ë ‰í† ë¦¬ ë‚´ìš© í™•ì¸
        echo "ğŸ“ Deploy files structure:"
        ls -la deploy-files/ | head -20
        
    - name: Copy files to EC2
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        source: "deploy-files/*"
        target: "~/dungji-market-backend"
        rm: true
        strip_components: 1
        timeout: 120s
        command_timeout: 5m

    - name: Upload .env to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          # ENV_FILEì´ ì„¤ì •ë˜ì–´ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸, ì•„ë‹ˆë©´ ê¸°ì¡´ íŒŒì¼ ìœ ì§€
          if [ ! -z "${{ secrets.ENV_FILE }}" ]; then
            echo "${{ secrets.ENV_FILE }}" > ~/dungji-market-backend/.env
          else
            echo "Using existing .env file on server"
          fi

          # Firebase ì„œë¹„ìŠ¤ ê³„ì • í‚¤ë¥¼ .envì— ì¶”ê°€ (Base64 ë””ì½”ë”©)
          if [ -n "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" ]; then
            echo "" >> ~/dungji-market-backend/.env
            echo "FIREBASE_SERVICE_ACCOUNT=$(echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}' | base64 -d)" >> ~/dungji-market-backend/.env
            echo "âœ… Firebase credentials added to .env"
          fi

          # OpenAI API í‚¤ë¥¼ .envì— ì¶”ê°€
          if [ -n "${{ secrets.OPENAI_API_KEY }}" ]; then
            # ê¸°ì¡´ OPENAI_API_KEY ë¼ì¸ ì œê±° (ìˆë‹¤ë©´)
            sed -i '/^OPENAI_API_KEY=/d' ~/dungji-market-backend/.env 2>/dev/null || true
            echo "" >> ~/dungji-market-backend/.env
            echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> ~/dungji-market-backend/.env
            echo "âœ… OpenAI API key added to .env"
          fi

          # Google Places API í‚¤ë¥¼ .envì— ì¶”ê°€
          if [ -n "${{ secrets.GOOGLE_PLACES_API_KEY }}" ]; then
            # ê¸°ì¡´ GOOGLE_PLACES_API_KEY ë¼ì¸ ì œê±° (ìˆë‹¤ë©´)
            sed -i '/^GOOGLE_PLACES_API_KEY=/d' ~/dungji-market-backend/.env 2>/dev/null || true
            echo "" >> ~/dungji-market-backend/.env
            echo "GOOGLE_PLACES_API_KEY=${{ secrets.GOOGLE_PLACES_API_KEY }}" >> ~/dungji-market-backend/.env
            echo "âœ… Google Places API key added to .env"
          fi

    - name: Deploy application
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        timeout: 60s
        command_timeout: 30m
        script: |
          set -e  # Exit on any error
          
          echo "ğŸš€ Starting deployment process..."
          cd ~/dungji-market-backend
          
          # ë°°í¬ ì „ ìƒíƒœ í™•ì¸
          echo "ğŸ” Pre-deployment check..."
          echo "Current containers:"
          sudo docker ps -a --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" || true
          echo "Port 8000 usage:"
          sudo lsof -i :8000 || echo "Port 8000 is free"
          echo ""

          # í•„ìˆ˜ íŒŒì¼ í™•ì¸
          if [ ! -f .env ]; then
            echo "âŒ ERROR: .env file not found!"
            echo "Please create .env file on the server first."
            echo "Refer to DEPLOYMENT.md for configuration details."
            exit 1
          fi
          echo "âœ… Environment file found"
          
          if [ ! -f docker-compose.yml ]; then
            echo "âŒ ERROR: docker-compose.yml file not found!"
            exit 1
          fi
          echo "âœ… Docker Compose file found"
          
          # ğŸ”¥ Nuclear cleanup: PID ë ˆë²¨ì—ì„œ ê°•ì œ ì •ë¦¬
          echo "ğŸ”¥ Nuclear cleanup: Killing container processes at PID level..."

          # ëª¨ë“  dungji ê´€ë ¨ ì»¨í…Œì´ë„ˆì˜ PID ì°¾ì•„ì„œ kill
          for container_id in $(sudo docker ps -aq --filter "name=dungji"); do
            if [ ! -z "$container_id" ]; then
              echo "Found container: $container_id"
              PID=$(sudo docker inspect -f '{{.State.Pid}}' "$container_id" 2>/dev/null || echo "")
              if [ ! -z "$PID" ] && [ "$PID" != "0" ]; then
                echo "Killing PID $PID for container $container_id"
                sudo kill -9 "$PID" 2>/dev/null || echo "PID already dead"
              fi
            fi
          done

          # Docker system pruneìœ¼ë¡œ ì™„ì „ ì •ë¦¬ (ì¢€ë¹„ ì»¨í…Œì´ë„ˆ í¬í•¨)
          echo "ğŸ§¹ Running docker system prune (removing ALL stopped containers, networks, images)..."
          sudo docker system prune --all --force --volumes || true

          # ìµœì¢… í™•ì¸
          echo "ğŸ“Š Remaining containers after cleanup:"
          sudo docker ps -a

          # ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ í™•ì¸
          echo "ğŸ’¾ Disk usage after cleanup:"
          df -h / | head -2

          # í¬íŠ¸ 8000 ìµœì¢… í™•ì¸ ë° ê°•ì œ í•´ì œ
          echo "ğŸ” Checking port 8000..."
          if sudo lsof -i :8000 2>/dev/null; then
            echo "âš ï¸  Port 8000 still in use, force killing..."
            sudo fuser -k 8000/tcp || true
            sleep 2
          fi

          # ìµœì¢… í¬íŠ¸ í™•ì¸
          if sudo lsof -i :8000 2>/dev/null; then
            echo "âŒ ERROR: Port 8000 is still in use after all cleanup attempts!"
            sudo lsof -i :8000
            exit 1
          else
            echo "âœ… Port 8000 is now available"
          fi
          
          # ìƒˆ ì´ë¯¸ì§€ ë¹Œë“œ ë° ì»¨í…Œì´ë„ˆ ì‹œì‘
          echo "ğŸ—ï¸  Building and starting containers..."
          # container_nameì´ ì§€ì •ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ì¼ê´€ëœ ì´ë¦„ ì‚¬ìš©
          sudo docker-compose up --build -d --force-recreate --remove-orphans

          # ì»¨í…Œì´ë„ˆ ì‹œì‘ ëŒ€ê¸°
          echo "â³ Waiting for containers to be ready..."
          sleep 10

          # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
          echo "ğŸ“Š Checking container status..."
          sudo docker ps --filter "name=dungji-backend-web"

          # ì›¹ ì„œë¹„ìŠ¤ í™•ì¸
          echo "ğŸ” Checking web service..."
          if sudo docker ps --filter "name=dungji-backend-web" --filter "status=running" | grep -q dungji-backend-web; then
            echo "âœ… Web container is running"
          else
            echo "âŒ Web container is not running"
            sudo docker logs dungji-backend-web
            exit 1
          fi

          # ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
          echo "ğŸ”„ Running database migrations..."
          sudo docker exec dungji-backend-web python manage.py migrate --noinput

          # ì •ì  íŒŒì¼ ìˆ˜ì§‘
          echo "ğŸ“¦ Collecting static files..."
          sudo docker exec dungji-backend-web python manage.py collectstatic --noinput

          # ìµœì¢… ìƒíƒœ í™•ì¸
          echo "ğŸ¥ Final health check..."
          sudo docker ps --filter "name=dungji-backend-web"

          # ë¡œê·¸ ì¶œë ¥
          echo "ğŸ“‹ Recent application logs:"
          sudo docker logs --tail=20 dungji-backend-web
          
          # ê°„ë‹¨í•œ API í…ŒìŠ¤íŠ¸ (ë¹ ë¥¸ í™•ì¸)
          echo "ğŸ§ª Testing API endpoint..."
          sleep 5
          if curl -f -s http://localhost:8000/api/health/ > /dev/null 2>&1; then
            echo "âœ… API health check passed"
          else
            echo "âš ï¸  API health check failed (will continue)"
          fi
          
          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸ“ Application is running at: http://${{ secrets.EC2_HOST }}:8000"