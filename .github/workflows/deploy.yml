name: Deploy Backend to EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production  # GitHub Environment ì‚¬ìš© (ì„ íƒì‚¬í•­)

    steps:
    - name: Checkout source
      uses: actions/checkout@v4

    - name: Validate secrets
      run: |
        echo "Validating required secrets..."
        if [ -z "${{ secrets.EC2_HOST }}" ]; then
          echo "âŒ EC2_HOST secret is not set!"
          exit 1
        fi
        if [ -z "${{ secrets.EC2_SSH_KEY }}" ]; then
          echo "âŒ EC2_SSH_KEY secret is not set!"
          exit 1
        fi
        echo "âœ… All required secrets are configured"

    - name: Copy files to EC2
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        source: "."
        target: "~/dungji-market-backend"
        rm: true
        strip_components: 0
        timeout: 60s
        command_timeout: 15m

    - name: Upload .env to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          echo "${{ secrets.ENV_FILE }}" > ~/dungji-market-backend/.env

    - name: Deploy application
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        timeout: 60s
        command_timeout: 15m
        script: |
          set -e  # Exit on any error
          
          echo "ğŸš€ Starting deployment process..."
          cd ~/dungji-market-backend
          
          # í¬íŠ¸ 8000ì„ ì‚¬ìš©í•˜ëŠ” í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
          echo "ğŸ” Checking for processes using port 8000..."
          if lsof -i :8000; then
            echo "ğŸ›‘ Port 8000 is already in use. Killing processes..."
            sudo fuser -k 8000/tcp || true
            sleep 5  # í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ëŒ€ê¸°
          else
            echo "âœ… Port 8000 is available"
          fi

          # í•„ìˆ˜ íŒŒì¼ í™•ì¸
          if [ ! -f .env ]; then
            echo "âŒ ERROR: .env file not found!"
            echo "Please create .env file on the server first."
            echo "Refer to DEPLOYMENT.md for configuration details."
            exit 1
          fi
          echo "âœ… Environment file found"
          
          if [ ! -f docker-compose.yml ]; then
            echo "âŒ ERROR: docker-compose.yml file not found!"
            exit 1
          fi
          echo "âœ… Docker Compose file found"
          
          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì •ë¦¬
          echo "ğŸ›‘ Stopping existing containers..."
          docker-compose down --remove-orphans || true
          
          # ëª¨ë“  ê´€ë ¨ ì»¨í…Œì´ë„ˆ ê°•ì œ ì •ë¦¬
          echo "ğŸ§¹ Cleaning up any remaining containers..."
          docker ps -a | grep dungji-market-backend | awk '{print $1}' | xargs -r docker stop || true
          docker ps -a | grep dungji-market-backend | awk '{print $1}' | xargs -r docker rm || true
          
          # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” Docker ë¦¬ì†ŒìŠ¤ ì •ë¦¬
          echo "ğŸ§¹ Cleaning up unused Docker resources..."
          docker system prune -f || true
          
          # ìƒˆ ì´ë¯¸ì§€ ë¹Œë“œ ë° ì»¨í…Œì´ë„ˆ ì‹œì‘
          echo "ğŸ—ï¸  Building and starting containers..."
          docker-compose up --build -d --force-recreate
          
          # ì»¨í…Œì´ë„ˆ ì‹œì‘ ëŒ€ê¸°
          echo "â³ Waiting for containers to be ready..."
          sleep 30
          
          # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
          echo "ğŸ“Š Checking container status..."
          docker-compose ps
          
          # ì›¹ ì„œë¹„ìŠ¤ê°€ ì¤€ë¹„ë  ë•Œê¹Œì§€ ëŒ€ê¸°
          echo "ğŸ” Waiting for web service to be ready..."
          WEB_READY=false
          for i in {1..30}; do
            if docker-compose ps | grep -q "web.*Up"; then
              echo "âœ… Web container is running"
              if docker-compose exec -T web python manage.py check --deploy 2>/dev/null; then
                echo "âœ… Web service is ready"
                WEB_READY=true
                break
              fi
            fi
            echo "Attempt $i/30: Web service not ready yet, waiting..."
            sleep 10
          done
          
          if [ "$WEB_READY" = false ]; then
            echo "âŒ Web service failed to start within timeout"
            echo "Container logs:"
            docker-compose logs web
            exit 1
          fi
          
          # ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
          echo "ğŸ”„ Running database migrations..."
          docker-compose exec -T web python manage.py migrate --noinput
          
          # ì •ì  íŒŒì¼ ìˆ˜ì§‘
          echo "ğŸ“¦ Collecting static files..."
          docker-compose exec -T web python manage.py collectstatic --noinput
          
          # ìµœì¢… ìƒíƒœ í™•ì¸
          echo "ğŸ¥ Final health check..."
          docker-compose ps
          
          # ë¡œê·¸ ì¶œë ¥
          echo "ğŸ“‹ Recent application logs:"
          docker-compose logs --tail=20 web
          
          # ê°„ë‹¨í•œ API í…ŒìŠ¤íŠ¸
          echo "ğŸ§ª Testing API endpoint..."
          API_HEALTHY=false
          for i in {1..10}; do
            if curl -f -s http://localhost:8000/api/health/ > /dev/null 2>&1; then
              echo "âœ… API health check passed"
              API_HEALTHY=true
              break
            fi
            echo "API check attempt $i/10: waiting..."
            sleep 3
          done
          
          if [ "$API_HEALTHY" = false ]; then
            echo "âš ï¸  API health check failed after multiple attempts"
            echo "This might indicate the application is not fully ready"
          fi
          
          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸ“ Application is running at: http://${{ secrets.EC2_HOST }}:8000"