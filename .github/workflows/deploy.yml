name: Deploy Backend to EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©

# ë™ì‹œ ì‹¤í–‰ ì œí•œ - ì´ì „ ë°°í¬ê°€ ì§„í–‰ ì¤‘ì´ë©´ ì·¨ì†Œí•˜ê³  ìƒˆë¡œìš´ ë°°í¬ ì‹œì‘
concurrency:
  group: production-deploy
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production  # ì´ ì„¤ì •ì´ queued ìƒíƒœë¥¼ ìœ ë°œí•  ìˆ˜ ìˆìŒ

    steps:
    - name: Checkout source
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Docker Hub (if credentials available)
      uses: docker/login-action@v3
      continue-on-error: true  # Don't fail if no credentials
      if: ${{ secrets.DOCKERHUB_USERNAME && secrets.DOCKERHUB_TOKEN }}
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Validate secrets
      run: |
        echo "Validating required secrets..."
        if [ -z "${{ secrets.EC2_HOST }}" ]; then
          echo "âŒ EC2_HOST secret is not set!"
          exit 1
        fi
        if [ -z "${{ secrets.EC2_SSH_KEY }}" ]; then
          echo "âŒ EC2_SSH_KEY secret is not set!"
          exit 1
        fi
        echo "âœ… All required secrets are configured"

    - name: Prepare files for deployment
      run: |
        # ë°°í¬ìš© ì„ì‹œ ë””ë ‰í† ë¦¬ ìƒì„±
        mkdir -p deploy-files
        # í•„ìš”í•œ íŒŒì¼ë§Œ ë³µì‚¬ (venv, .git, .next ë“± ì œì™¸)
        rsync -av --exclude='venv/' \
                  --exclude='__pycache__/' \
                  --exclude='*.pyc' \
                  --exclude='*.log' \
                  --exclude='.DS_Store' \
                  --exclude='node_modules/' \
                  --exclude='.env' \
                  --exclude='*.sqlite3' \
                  --exclude='db.sqlite3' \
                  --exclude='server_new.log' \
                  --exclude='.next/' \
                  --exclude='deploy-files/' \
                  ./ deploy-files/
        echo "âœ… Files prepared for deployment"
        du -sh deploy-files/
        # ë””ë ‰í† ë¦¬ ë‚´ìš© í™•ì¸
        echo "ğŸ“ Deploy files structure:"
        ls -la deploy-files/ | head -20
        
    - name: Copy files to EC2
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        source: "deploy-files/*"
        target: "~/dungji-market-backend"
        rm: true
        strip_components: 1
        timeout: 120s
        command_timeout: 5m

    - name: Upload .env to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          # ENV_FILEì´ ì„¤ì •ë˜ì–´ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸, ì•„ë‹ˆë©´ ê¸°ì¡´ íŒŒì¼ ìœ ì§€
          if [ ! -z "${{ secrets.ENV_FILE }}" ]; then
            echo "${{ secrets.ENV_FILE }}" > ~/dungji-market-backend/.env
          else
            echo "Using existing .env file on server"
          fi

    - name: Deploy application
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        timeout: 60s
        command_timeout: 30m
        script: |
          set -e  # Exit on any error
          
          echo "ğŸš€ Starting deployment process..."
          cd ~/dungji-market-backend
          
          # í¬íŠ¸ 8000ì„ ì‚¬ìš©í•˜ëŠ” í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
          echo "ğŸ” Checking for processes using port 8000..."
          
          # íŠ¹ì • ë¬¸ì œ ì»¨í…Œì´ë„ˆëŠ” ì´ë¯¸ ì œê±°ë¨
          
          # ëª¨ë“  Docker ì»¨í…Œì´ë„ˆ ì¤‘ì§€ (í¬íŠ¸ ì¶©ëŒ ë°©ì§€)
          echo "Stopping all Docker containers that might use port 8000..."
          sudo docker ps -q | xargs -r sudo docker stop || true
          
          # ëª¨ë“  ì¢…ë£Œëœ ì»¨í…Œì´ë„ˆ ì œê±°
          echo "Removing all stopped containers..."
          sudo docker container prune -f || true
          
          # netstat ëŒ€ì‹  ss ì‚¬ìš© (Ubuntuì— ê¸°ë³¸ ì„¤ì¹˜ë¨)
          echo "Checking port usage..."
          sudo ss -tlnp | grep :8000 || true
          
          # lsofë¡œ í¬íŠ¸ í™•ì¸
          if sudo lsof -i :8000; then
            echo "ğŸ›‘ Port 8000 is in use. Force killing processes..."
            sudo lsof -ti:8000 | xargs -r sudo kill -9 || true
            sleep 5
          fi
          
          # fuserë¡œ ì¶”ê°€ í™•ì¸
          sudo fuser -k 8000/tcp || true
          sleep 2
          
          # ìµœì¢… í™•ì¸
          if sudo lsof -i :8000; then
            echo "âŒ ERROR: Port 8000 is still in use after cleanup!"
            sudo lsof -i :8000
            exit 1
          else
            echo "âœ… Port 8000 is now available"
          fi

          # í•„ìˆ˜ íŒŒì¼ í™•ì¸
          if [ ! -f .env ]; then
            echo "âŒ ERROR: .env file not found!"
            echo "Please create .env file on the server first."
            echo "Refer to DEPLOYMENT.md for configuration details."
            exit 1
          fi
          echo "âœ… Environment file found"
          
          if [ ! -f docker-compose.yml ]; then
            echo "âŒ ERROR: docker-compose.yml file not found!"
            exit 1
          fi
          echo "âœ… Docker Compose file found"
          
          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì •ë¦¬
          echo "ğŸ›‘ Stopping existing containers..."
          # docker-compose downì´ ì‹¤íŒ¨í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ê°œë³„ì ìœ¼ë¡œ ì²˜ë¦¬
          sudo docker-compose stop || true
          sudo docker-compose rm -f || true
          sudo docker-compose down --remove-orphans || true
          
          # ëª¨ë“  ê´€ë ¨ ì»¨í…Œì´ë„ˆ ê°•ì œ ì •ë¦¬
          echo "ğŸ§¹ Cleaning up any remaining containers..."
          # sudoë¥¼ ì‚¬ìš©í•˜ì—¬ ê¶Œí•œ ë¬¸ì œ í•´ê²°
          sudo docker ps -a | grep dungji-market-backend | awk '{print $1}' | xargs -r sudo docker stop || true
          sudo docker ps -a | grep dungji-market-backend | awk '{print $1}' | xargs -r sudo docker rm -f || true
          
          # ê°„ì†Œí™”ëœ ì •ë¦¬ í”„ë¡œì„¸ìŠ¤
          echo "ğŸ§¹ Cleaning up ALL dungji containers (including old timestamped ones)..."
          # íƒ€ì„ìŠ¤íƒ¬í”„ê°€ í¬í•¨ëœ ëª¨ë“  dungji ê´€ë ¨ ì»¨í…Œì´ë„ˆ ì •ë¦¬
          sudo docker ps -a | grep -E "dungji.*backend" | awk '{print $1}' | xargs -r sudo docker rm -f || true
          sudo docker ps -a | grep dungji | awk '{print $1}' | xargs -r sudo docker rm -f || true
          
          # Docker ë„¤íŠ¸ì›Œí¬ ì •ë¦¬ (íƒ€ì„ìŠ¤íƒ¬í”„ í¬í•¨ëœ ê²ƒë“¤ë„)
          echo "ğŸ§¹ Cleaning up Docker networks..."
          sudo docker network ls | grep -E "dungji.*backend" | awk '{print $2}' | xargs -r sudo docker network rm || true
          sudo docker network ls | grep dungji-market-backend | awk '{print $2}' | xargs -r sudo docker network rm || true
          
          # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” Docker ë¦¬ì†ŒìŠ¤ ì •ë¦¬
          echo "ğŸ§¹ Cleaning up unused Docker resources..."
          sudo docker system prune -f || true
          
          # ë””ìŠ¤í¬ ê³µê°„ í™•ë³´ë¥¼ ìœ„í•œ ì¶”ê°€ ì •ë¦¬
          echo "ğŸ§¹ Deep cleaning Docker resources to free up disk space..."
          sudo docker image prune -a -f || true
          sudo docker volume prune -f || true
          sudo docker builder prune -a -f || true
          
          # ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ í™•ì¸
          echo "ğŸ’¾ Checking disk usage..."
          df -h /
          
          # í¬íŠ¸ 8000ì´ ì—¬ì „íˆ ì‚¬ìš© ì¤‘ì¸ì§€ ìµœì¢… í™•ì¸
          if sudo lsof -i :8000 2>/dev/null; then
            echo "âš ï¸  Port 8000 is still in use. Using alternative approach..."
            # ì»¨í…Œì´ë„ˆë¥¼ ë‹¤ë¥¸ í¬íŠ¸ë¡œ ì‹¤í–‰í•˜ëŠ” ëŒ€ì•ˆ
            export HOST_PORT=8001
            echo "Using alternative port $HOST_PORT"
          else
            export HOST_PORT=8000
          fi
          
          # Docker Hub ì¸ì¦ ë¬¸ì œ í•´ê²°
          echo "ğŸ”§ Setting up Docker authentication..."
          # Docker ë¡œê·¸ì•„ì›ƒ í›„ ì¬ì‹œë„ (ìµëª… ì‚¬ìš©ìë¡œ)
          sudo docker logout docker.io || true

          # Docker buildx ì„¤ì • (ë” ë‚˜ì€ ë¹Œë“œ ì„±ëŠ¥ê³¼ ìºì‹±)
          sudo docker buildx create --use --name mybuilder || true
          sudo docker buildx inspect --bootstrap || true

          # ì¬ì‹œë„ í•¨ìˆ˜ ì •ì˜
          retry_docker_build() {
              local max_attempts=3
              local delay=30
              local attempt=1

              while [ $attempt -le $max_attempts ]; do
                  echo "ğŸ”„ Build attempt $attempt/$max_attempts"
                  if sudo docker-compose -p $PROJECT_NAME build --no-cache; then
                      echo "âœ… Build succeeded on attempt $attempt"
                      return 0
                  else
                      if [ $attempt -lt $max_attempts ]; then
                          echo "âŒ Build failed on attempt $attempt. Retrying in ${delay}s..."
                          sleep $delay
                          delay=$((delay + 30))
                      else
                          echo "âŒ Build failed after $max_attempts attempts"
                          return 1
                      fi
                  fi
                  attempt=$((attempt + 1))
              done
          }

          # ìƒˆ ì´ë¯¸ì§€ ë¹Œë“œ ë° ì»¨í…Œì´ë„ˆ ì‹œì‘
          echo "ğŸ—ï¸  Building and starting containers..."
          # ê³ ì •ëœ í”„ë¡œì íŠ¸ ì´ë¦„ ì‚¬ìš© (ê¸°ì¡´ ì»¨í…Œì´ë„ˆë¥¼ êµì²´)
          PROJECT_NAME="dungji-backend"
          echo "Using project name: $PROJECT_NAME"
          export PROJECT_NAME

          # ì¬ì‹œë„ ë¡œì§ìœ¼ë¡œ ë¹Œë“œ ìˆ˜í–‰
          if retry_docker_build; then
              echo "âœ… Images built successfully, starting containers..."
              sudo docker-compose -p $PROJECT_NAME up -d --force-recreate --remove-orphans
          else
              echo "âŒ Build failed. Trying with existing images..."
              # ê¸°ì¡´ ì´ë¯¸ì§€ê°€ ìˆë‹¤ë©´ ê·¸ê²ƒìœ¼ë¡œ ì‹œë„
              if sudo docker-compose -p $PROJECT_NAME up -d --force-recreate --remove-orphans; then
                  echo "âœ… Started with existing images"
              else
                  echo "âŒ Failed to start containers"
                  sudo docker-compose -p $PROJECT_NAME logs --tail=50
                  exit 1
              fi
          fi
          
          # ì»¨í…Œì´ë„ˆ ì‹œì‘ ëŒ€ê¸°
          echo "â³ Waiting for containers to be ready..."
          sleep 10
          
          # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
          echo "ğŸ“Š Checking container status..."
          sudo docker-compose -p $PROJECT_NAME ps
          
          # ì›¹ ì„œë¹„ìŠ¤ í™•ì¸ (ê°„ì†Œí™”)
          echo "ğŸ” Checking web service..."
          if sudo docker-compose -p $PROJECT_NAME ps | grep -q "web.*Up"; then
            echo "âœ… Web container is running"
          else
            echo "âŒ Web container is not running"
            sudo docker-compose -p $PROJECT_NAME logs web
            exit 1
          fi
          
          # ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
          echo "ğŸ”„ Running database migrations..."
          sudo docker-compose -p $PROJECT_NAME exec -T web python manage.py migrate --noinput
          
          # ì •ì  íŒŒì¼ ìˆ˜ì§‘
          echo "ğŸ“¦ Collecting static files..."
          sudo docker-compose -p $PROJECT_NAME exec -T web python manage.py collectstatic --noinput
          
          # ìµœì¢… ìƒíƒœ í™•ì¸
          echo "ğŸ¥ Final health check..."
          sudo docker-compose -p $PROJECT_NAME ps
          
          # ë¡œê·¸ ì¶œë ¥
          echo "ğŸ“‹ Recent application logs:"
          sudo docker-compose -p $PROJECT_NAME logs --tail=20 web
          
          # ê°„ë‹¨í•œ API í…ŒìŠ¤íŠ¸ (ë¹ ë¥¸ í™•ì¸)
          echo "ğŸ§ª Testing API endpoint..."
          sleep 5
          if curl -f -s http://localhost:8000/api/health/ > /dev/null 2>&1; then
            echo "âœ… API health check passed"
          else
            echo "âš ï¸  API health check failed (will continue)"
          fi
          
          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸ“ Application is running at: http://${{ secrets.EC2_HOST }}:8000"