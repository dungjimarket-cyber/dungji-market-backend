{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}견적 티켓 수동 조절 관리{% endblock %}

{% block content %}
<div class="bid-token-management" style="padding: 20px;">
    <h1>🎫 견적 티켓 수동 조절 관리</h1>
    
    <!-- 전체 통계 대시보드 -->
    <div class="stats-dashboard" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
        <div class="stat-card" style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #007BFF;">
            <h3 style="margin: 0; color: #007BFF;">총 판매회원</h3>
            <p style="font-size: 24px; font-weight: bold; margin: 5px 0;">{{ total_sellers }}명</p>
        </div>
        <div class="stat-card" style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #28A745;">
            <h3 style="margin: 0; color: #28A745;">활성 견적티켓</h3>
            <p style="font-size: 24px; font-weight: bold; margin: 5px 0;">{{ total_active_tokens }}개</p>
        </div>
        <div class="stat-card" style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #6C757D;">
            <h3 style="margin: 0; color: #6C757D;">사용된 티켓</h3>
            <p style="font-size: 24px; font-weight: bold; margin: 5px 0;">{{ total_used_tokens }}개</p>
        </div>
        <div class="stat-card" style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #6F42C1;">
            <h3 style="margin: 0; color: #6F42C1;">무제한 구독권</h3>
            <p style="font-size: 24px; font-weight: bold; margin: 5px 0;">{{ total_unlimited_subscriptions }}개</p>
        </div>
    </div>

    <!-- 토큰 보유 현황 -->
    <div class="token-distribution" style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 30px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <h2>📊 견적 티켓 보유 현황</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
            {% for stat in token_stats %}
            <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                <div style="font-weight: bold; color: #495057;">{{ stat.range }}</div>
                <div style="font-size: 20px; color: #007BFF; font-weight: bold;">{{ stat.count }}명</div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- 개별 조정 섹션 -->
    <div class="individual-adjustment" style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 30px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <h2>👤 개별 판매자 티켓 조정</h2>
        
        <!-- 판매자 검색 -->
        <div class="seller-search" style="margin-bottom: 20px;">
            <label for="seller-search-input" style="display: block; font-weight: bold; margin-bottom: 8px;">판매자 검색:</label>
            <input type="text" id="seller-search-input" placeholder="닉네임, 이메일, 사업자번호로 검색..." 
                   style="width: 100%; max-width: 400px; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            <div id="seller-search-results" style="margin-top: 10px;"></div>
        </div>

        <!-- 선택된 판매자 정보 -->
        <div id="selected-seller-info" style="display: none; background: #e3f2fd; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
            <h4 style="margin: 0 0 10px 0;">선택된 판매자</h4>
            <div id="seller-details"></div>
        </div>

        <!-- 조정 폼 -->
        <div id="adjustment-form" style="display: none;">
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div>
                    <label style="display: block; font-weight: bold; margin-bottom: 8px;">조정 유형:</label>
                    <select id="adjustment-type" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="add">티켓 추가</option>
                        <option value="subtract">티켓 차감</option>
                        <option value="grant_subscription">구독권 부여</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; font-weight: bold; margin-bottom: 8px;">수량/일수:</label>
                    <input type="number" id="adjustment-quantity" min="1" max="100" value="1" 
                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div>
                    <label style="display: block; font-weight: bold; margin-bottom: 8px;">사유:</label>
                    <input type="text" id="adjustment-reason" placeholder="조정 사유 입력..." 
                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
            </div>
            <button type="button" id="apply-adjustment" 
                    style="background: #007BFF; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                조정 적용
            </button>
        </div>
    </div>

    <!-- 대량 조정 섹션 -->
    <div class="bulk-adjustment" style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 30px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <h2>👥 대량 티켓 조정</h2>
        <div style="background: #fff3cd; padding: 15px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
            <strong>⚠️ 주의:</strong> 대량 조정은 최대 100명까지만 처리됩니다. 신중히 사용해주세요.
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
            <div>
                <label style="display: block; font-weight: bold; margin-bottom: 8px;">대상 필터:</label>
                <select id="bulk-filter-type" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="all">모든 판매회원</option>
                    <option value="no_tokens">티켓이 없는 판매회원</option>
                    <option value="low_tokens">티켓 5개 이하 판매회원</option>
                    <option value="business_verified">사업자 인증 판매회원</option>
                </select>
            </div>
            <div>
                <label style="display: block; font-weight: bold; margin-bottom: 8px;">조정 유형:</label>
                <select id="bulk-adjustment-type" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="add">티켓 추가</option>
                    <option value="grant_subscription">구독권 부여</option>
                </select>
            </div>
            <div>
                <label style="display: block; font-weight: bold; margin-bottom: 8px;">수량/일수:</label>
                <input type="number" id="bulk-quantity" min="1" max="50" value="5" 
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
                <label style="display: block; font-weight: bold; margin-bottom: 8px;">사유:</label>
                <input type="text" id="bulk-reason" placeholder="대량 조정 사유..." 
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
        </div>
        
        <button type="button" id="apply-bulk-adjustment" 
                style="background: #DC3545; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
            대량 조정 실행
        </button>
    </div>

    <!-- 최근 조정 이력 -->
    <div class="recent-adjustments" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <h2>📝 최근 조정 이력 (최근 50개)</h2>
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #f8f9fa;">
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">날짜</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">판매자</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">조정 유형</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">수량</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">사유</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">관리자</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in recent_adjustments %}
                    <tr style="border-bottom: 1px solid #dee2e6;">
                        <td style="padding: 10px;">{{ log.created_at|date:"Y-m-d H:i" }}</td>
                        <td style="padding: 10px;">
                            <strong>{{ log.seller.nickname|default:log.seller.username }}</strong><br>
                            <small style="color: #6c757d;">{{ log.seller.email }}</small>
                        </td>
                        <td style="padding: 10px;">
                            {% if log.adjustment_type == 'add' %}
                                <span style="background: #d4edda; color: #155724; padding: 2px 8px; border-radius: 4px; font-size: 12px;">추가</span>
                            {% elif log.adjustment_type == 'subtract' %}
                                <span style="background: #f8d7da; color: #721c24; padding: 2px 8px; border-radius: 4px; font-size: 12px;">차감</span>
                            {% elif log.adjustment_type == 'grant_subscription' %}
                                <span style="background: #d1ecf1; color: #0c5460; padding: 2px 8px; border-radius: 4px; font-size: 12px;">구독권</span>
                            {% endif %}
                        </td>
                        <td style="padding: 10px;">
                            <strong>{{ log.quantity }}</strong>
                            {% if log.adjustment_type == 'grant_subscription' %}일{% else %}개{% endif %}
                        </td>
                        <td style="padding: 10px;">
                            <span title="{{ log.reason }}">
                                {{ log.reason|truncatechars:30 }}
                            </span>
                        </td>
                        <td style="padding: 10px;">
                            {{ log.admin.username|default:"시스템" }}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" style="padding: 20px; text-align: center; color: #6c757d;">
                            조정 이력이 없습니다.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let selectedSeller = null;
    let searchTimeout = null;
    
    // 판매자 검색
    const searchInput = document.getElementById('seller-search-input');
    const searchResults = document.getElementById('seller-search-results');
    const selectedSellerInfo = document.getElementById('selected-seller-info');
    const sellerDetails = document.getElementById('seller-details');
    const adjustmentForm = document.getElementById('adjustment-form');
    
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();
        
        if (query.length < 2) {
            searchResults.innerHTML = '';
            return;
        }
        
        searchTimeout = setTimeout(() => {
            fetch(`/admin/bid-token-management/seller-search/?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    let html = '';
                    if (data.sellers.length > 0) {
                        html = '<div style="border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto;">';
                        data.sellers.forEach(seller => {
                            html += `
                                <div class="seller-option" data-seller-id="${seller.id}" 
                                     style="padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>${seller.display_name}</strong>
                                        ${seller.business_number ? `<br><small>사업자번호: ${seller.business_number}</small>` : ''}
                                    </div>
                                    <div style="text-align: right; font-size: 12px; color: #6c757d;">
                                        티켓: ${seller.active_tokens}개<br>
                                        ${seller.has_subscription ? '<span style="color: #6F42C1;">구독권 ✓</span>' : ''}
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div>';
                    } else {
                        html = '<div style="padding: 10px; color: #6c757d;">검색 결과가 없습니다.</div>';
                    }
                    searchResults.innerHTML = html;
                    
                    // 판매자 선택 이벤트
                    document.querySelectorAll('.seller-option').forEach(option => {
                        option.addEventListener('click', function() {
                            const sellerId = this.dataset.sellerId;
                            selectedSeller = data.sellers.find(s => s.id == sellerId);
                            selectSeller(selectedSeller);
                        });
                        
                        option.addEventListener('mouseenter', function() {
                            this.style.backgroundColor = '#f8f9fa';
                        });
                        
                        option.addEventListener('mouseleave', function() {
                            this.style.backgroundColor = '';
                        });
                    });
                })
                .catch(error => {
                    console.error('검색 중 오류:', error);
                    searchResults.innerHTML = '<div style="padding: 10px; color: #dc3545;">검색 중 오류가 발생했습니다.</div>';
                });
        }, 300);
    });
    
    function selectSeller(seller) {
        selectedSeller = seller;
        searchResults.innerHTML = '';
        searchInput.value = seller.display_name;
        
        sellerDetails.innerHTML = `
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                <div><strong>이름:</strong> ${seller.nickname || seller.username}</div>
                <div><strong>이메일:</strong> ${seller.email}</div>
                <div><strong>사업자번호:</strong> ${seller.business_number || '없음'}</div>
                <div><strong>활성 티켓:</strong> <span style="color: #28A745; font-weight: bold;">${seller.active_tokens}개</span></div>
                <div><strong>사용된 티켓:</strong> <span style="color: #6c757d;">${seller.used_tokens}개</span></div>
                <div><strong>구독권:</strong> ${seller.has_subscription ? '<span style="color: #6F42C1; font-weight: bold;">활성 ✓</span>' : '<span style="color: #6c757d;">없음</span>'}</div>
            </div>
        `;
        
        selectedSellerInfo.style.display = 'block';
        adjustmentForm.style.display = 'block';
    }
    
    // 개별 조정 적용
    document.getElementById('apply-adjustment').addEventListener('click', function() {
        if (!selectedSeller) {
            alert('판매자를 먼저 선택해주세요.');
            return;
        }
        
        const adjustmentType = document.getElementById('adjustment-type').value;
        const quantity = parseInt(document.getElementById('adjustment-quantity').value);
        const reason = document.getElementById('adjustment-reason').value.trim();
        
        if (!quantity || quantity <= 0) {
            alert('올바른 수량을 입력해주세요.');
            return;
        }
        
        if (!reason) {
            alert('조정 사유를 입력해주세요.');
            return;
        }
        
        if (!confirm(`${selectedSeller.display_name}님에게 ${adjustmentType === 'grant_subscription' ? quantity + '일 구독권을' : quantity + '개 티켓을'} ${adjustmentType === 'add' ? '추가' : adjustmentType === 'subtract' ? '차감' : '부여'}하시겠습니까?`)) {
            return;
        }
        
        this.disabled = true;
        this.textContent = '처리중...';
        
        fetch('/admin/bid-token-management/adjust/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                seller_id: selectedSeller.id,
                adjustment_type: adjustmentType,
                quantity: quantity,
                reason: reason
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                // 선택된 판매자 정보 업데이트
                selectedSeller.active_tokens = data.current_tokens;
                selectedSeller.has_subscription = data.has_subscription;
                selectSeller(selectedSeller);
                // 폼 초기화
                document.getElementById('adjustment-quantity').value = '1';
                document.getElementById('adjustment-reason').value = '';
                // 페이지 새로고침
                location.reload();
            } else {
                alert('오류: ' + data.error);
            }
        })
        .catch(error => {
            console.error('조정 중 오류:', error);
            alert('조정 중 오류가 발생했습니다.');
        })
        .finally(() => {
            this.disabled = false;
            this.textContent = '조정 적용';
        });
    });
    
    // 대량 조정 적용
    document.getElementById('apply-bulk-adjustment').addEventListener('click', function() {
        const filterType = document.getElementById('bulk-filter-type').value;
        const adjustmentType = document.getElementById('bulk-adjustment-type').value;
        const quantity = parseInt(document.getElementById('bulk-quantity').value);
        const reason = document.getElementById('bulk-reason').value.trim();
        
        if (!quantity || quantity <= 0) {
            alert('올바른 수량을 입력해주세요.');
            return;
        }
        
        if (!reason) {
            alert('조정 사유를 입력해주세요.');
            return;
        }
        
        const filterNames = {
            'all': '모든 판매회원',
            'no_tokens': '티켓이 없는 판매회원',
            'low_tokens': '티켓 5개 이하 판매회원',
            'business_verified': '사업자 인증 판매회원'
        };
        
        if (!confirm(`${filterNames[filterType]}에게 대량으로 ${adjustmentType === 'grant_subscription' ? quantity + '일 구독권을' : quantity + '개 티켓을'} ${adjustmentType === 'add' ? '추가' : '부여'}하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다.`)) {
            return;
        }
        
        this.disabled = true;
        this.textContent = '처리중...';
        
        fetch('/admin/bid-token-management/bulk-adjust/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                filter_type: filterType,
                adjustment_type: adjustmentType,
                quantity: quantity,
                reason: reason
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                // 폼 초기화
                document.getElementById('bulk-quantity').value = '5';
                document.getElementById('bulk-reason').value = '';
                // 페이지 새로고침
                location.reload();
            } else {
                alert('오류: ' + data.error);
            }
        })
        .catch(error => {
            console.error('대량 조정 중 오류:', error);
            alert('대량 조정 중 오류가 발생했습니다.');
        })
        .finally(() => {
            this.disabled = false;
            this.textContent = '대량 조정 실행';
        });
    });
    
    // CSRF 토큰 가져오기
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}