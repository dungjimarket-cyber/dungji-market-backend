{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}ê²¬ì  í‹°ì¼“ ìˆ˜ë™ ì¡°ì ˆ ê´€ë¦¬{% endblock %}

{% block content %}
<div class="bid-token-management" style="padding: 20px;">
    <h1>ğŸ« ê²¬ì  í‹°ì¼“ ìˆ˜ë™ ì¡°ì ˆ ê´€ë¦¬</h1>
    
    <!-- ì „ì²´ í†µê³„ ëŒ€ì‹œë³´ë“œ -->
    <div class="stats-dashboard" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
        <div class="stat-card" style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #007BFF;">
            <h3 style="margin: 0; color: #007BFF;">ì´ íŒë§¤íšŒì›</h3>
            <p style="font-size: 24px; font-weight: bold; margin: 5px 0;">{{ total_sellers }}ëª…</p>
        </div>
        <div class="stat-card" style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #28A745;">
            <h3 style="margin: 0; color: #28A745;">í™œì„± ê²¬ì í‹°ì¼“</h3>
            <p style="font-size: 24px; font-weight: bold; margin: 5px 0;">{{ total_active_tokens }}ê°œ</p>
        </div>
        <div class="stat-card" style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #6C757D;">
            <h3 style="margin: 0; color: #6C757D;">ì‚¬ìš©ëœ í‹°ì¼“</h3>
            <p style="font-size: 24px; font-weight: bold; margin: 5px 0;">{{ total_used_tokens }}ê°œ</p>
        </div>
        <div class="stat-card" style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #6F42C1;">
            <h3 style="margin: 0; color: #6F42C1;">ë¬´ì œí•œ êµ¬ë…ê¶Œ</h3>
            <p style="font-size: 24px; font-weight: bold; margin: 5px 0;">{{ total_unlimited_subscriptions }}ê°œ</p>
        </div>
    </div>

    <!-- í† í° ë³´ìœ  í˜„í™© -->
    <div class="token-distribution" style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 30px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <h2>ğŸ“Š ê²¬ì  í‹°ì¼“ ë³´ìœ  í˜„í™©</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
            {% for stat in token_stats %}
            <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                <div style="font-weight: bold; color: #495057;">{{ stat.range }}</div>
                <div style="font-size: 20px; color: #007BFF; font-weight: bold;">{{ stat.count }}ëª…</div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- ê°œë³„ ì¡°ì • ì„¹ì…˜ -->
    <div class="individual-adjustment" style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 30px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <h2>ğŸ‘¤ ê°œë³„ íŒë§¤ì í‹°ì¼“ ì¡°ì •</h2>
        
        <!-- íŒë§¤ì ê²€ìƒ‰ -->
        <div class="seller-search" style="margin-bottom: 20px;">
            <label for="seller-search-input" style="display: block; font-weight: bold; margin-bottom: 8px;">íŒë§¤ì ê²€ìƒ‰:</label>
            <input type="text" id="seller-search-input" placeholder="ë‹‰ë„¤ì„, ì´ë©”ì¼, ì‚¬ì—…ìë²ˆí˜¸ë¡œ ê²€ìƒ‰..." 
                   style="width: 100%; max-width: 400px; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            <div id="seller-search-results" style="margin-top: 10px;"></div>
        </div>

        <!-- ì„ íƒëœ íŒë§¤ì ì •ë³´ -->
        <div id="selected-seller-info" style="display: none; background: #e3f2fd; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
            <h4 style="margin: 0 0 10px 0;">ì„ íƒëœ íŒë§¤ì</h4>
            <div id="seller-details"></div>
        </div>

        <!-- ì¡°ì • í¼ -->
        <div id="adjustment-form" style="display: none;">
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div>
                    <label style="display: block; font-weight: bold; margin-bottom: 8px;">ì¡°ì • ìœ í˜•:</label>
                    <select id="adjustment-type" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="add">í‹°ì¼“ ì¶”ê°€</option>
                        <option value="subtract">í‹°ì¼“ ì°¨ê°</option>
                        <option value="grant_subscription">êµ¬ë…ê¶Œ ë¶€ì—¬</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; font-weight: bold; margin-bottom: 8px;">ìˆ˜ëŸ‰/ì¼ìˆ˜:</label>
                    <input type="number" id="adjustment-quantity" min="1" max="100" value="1" 
                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div>
                    <label style="display: block; font-weight: bold; margin-bottom: 8px;">ì‚¬ìœ :</label>
                    <input type="text" id="adjustment-reason" placeholder="ì¡°ì • ì‚¬ìœ  ì…ë ¥..." 
                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
            </div>
            <button type="button" id="apply-adjustment" 
                    style="background: #007BFF; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                ì¡°ì • ì ìš©
            </button>
        </div>
    </div>

    <!-- ëŒ€ëŸ‰ ì¡°ì • ì„¹ì…˜ -->
    <div class="bulk-adjustment" style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 30px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <h2>ğŸ‘¥ ëŒ€ëŸ‰ í‹°ì¼“ ì¡°ì •</h2>
        <div style="background: #fff3cd; padding: 15px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
            <strong>âš ï¸ ì£¼ì˜:</strong> ëŒ€ëŸ‰ ì¡°ì •ì€ ìµœëŒ€ 100ëª…ê¹Œì§€ë§Œ ì²˜ë¦¬ë©ë‹ˆë‹¤. ì‹ ì¤‘íˆ ì‚¬ìš©í•´ì£¼ì„¸ìš”.
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
            <div>
                <label style="display: block; font-weight: bold; margin-bottom: 8px;">ëŒ€ìƒ í•„í„°:</label>
                <select id="bulk-filter-type" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="all">ëª¨ë“  íŒë§¤íšŒì›</option>
                    <option value="no_tokens">í‹°ì¼“ì´ ì—†ëŠ” íŒë§¤íšŒì›</option>
                    <option value="low_tokens">í‹°ì¼“ 5ê°œ ì´í•˜ íŒë§¤íšŒì›</option>
                    <option value="business_verified">ì‚¬ì—…ì ì¸ì¦ íŒë§¤íšŒì›</option>
                </select>
            </div>
            <div>
                <label style="display: block; font-weight: bold; margin-bottom: 8px;">ì¡°ì • ìœ í˜•:</label>
                <select id="bulk-adjustment-type" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="add">í‹°ì¼“ ì¶”ê°€</option>
                    <option value="grant_subscription">êµ¬ë…ê¶Œ ë¶€ì—¬</option>
                </select>
            </div>
            <div>
                <label style="display: block; font-weight: bold; margin-bottom: 8px;">ìˆ˜ëŸ‰/ì¼ìˆ˜:</label>
                <input type="number" id="bulk-quantity" min="1" max="50" value="5" 
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
                <label style="display: block; font-weight: bold; margin-bottom: 8px;">ì‚¬ìœ :</label>
                <input type="text" id="bulk-reason" placeholder="ëŒ€ëŸ‰ ì¡°ì • ì‚¬ìœ ..." 
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
        </div>
        
        <button type="button" id="apply-bulk-adjustment" 
                style="background: #DC3545; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
            ëŒ€ëŸ‰ ì¡°ì • ì‹¤í–‰
        </button>
    </div>

    <!-- ìµœê·¼ ì¡°ì • ì´ë ¥ -->
    <div class="recent-adjustments" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <h2>ğŸ“ ìµœê·¼ ì¡°ì • ì´ë ¥ (ìµœê·¼ 50ê°œ)</h2>
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #f8f9fa;">
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">ë‚ ì§œ</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">íŒë§¤ì</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">ì¡°ì • ìœ í˜•</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">ìˆ˜ëŸ‰</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">ì‚¬ìœ </th>
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">ê´€ë¦¬ì</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in recent_adjustments %}
                    <tr style="border-bottom: 1px solid #dee2e6;">
                        <td style="padding: 10px;">{{ log.created_at|date:"Y-m-d H:i" }}</td>
                        <td style="padding: 10px;">
                            <strong>{{ log.seller.nickname|default:log.seller.username }}</strong><br>
                            <small style="color: #6c757d;">{{ log.seller.email }}</small>
                        </td>
                        <td style="padding: 10px;">
                            {% if log.adjustment_type == 'add' %}
                                <span style="background: #d4edda; color: #155724; padding: 2px 8px; border-radius: 4px; font-size: 12px;">ì¶”ê°€</span>
                            {% elif log.adjustment_type == 'subtract' %}
                                <span style="background: #f8d7da; color: #721c24; padding: 2px 8px; border-radius: 4px; font-size: 12px;">ì°¨ê°</span>
                            {% elif log.adjustment_type == 'grant_subscription' %}
                                <span style="background: #d1ecf1; color: #0c5460; padding: 2px 8px; border-radius: 4px; font-size: 12px;">êµ¬ë…ê¶Œ</span>
                            {% endif %}
                        </td>
                        <td style="padding: 10px;">
                            <strong>{{ log.quantity }}</strong>
                            {% if log.adjustment_type == 'grant_subscription' %}ì¼{% else %}ê°œ{% endif %}
                        </td>
                        <td style="padding: 10px;">
                            <span title="{{ log.reason }}">
                                {{ log.reason|truncatechars:30 }}
                            </span>
                        </td>
                        <td style="padding: 10px;">
                            {{ log.admin.username|default:"ì‹œìŠ¤í…œ" }}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" style="padding: 20px; text-align: center; color: #6c757d;">
                            ì¡°ì • ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let selectedSeller = null;
    let searchTimeout = null;
    
    // íŒë§¤ì ê²€ìƒ‰
    const searchInput = document.getElementById('seller-search-input');
    const searchResults = document.getElementById('seller-search-results');
    const selectedSellerInfo = document.getElementById('selected-seller-info');
    const sellerDetails = document.getElementById('seller-details');
    const adjustmentForm = document.getElementById('adjustment-form');
    
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();
        
        if (query.length < 2) {
            searchResults.innerHTML = '';
            return;
        }
        
        searchTimeout = setTimeout(() => {
            fetch(`/admin/bid-token-management/seller-search/?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    let html = '';
                    if (data.sellers.length > 0) {
                        html = '<div style="border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto;">';
                        data.sellers.forEach(seller => {
                            html += `
                                <div class="seller-option" data-seller-id="${seller.id}" 
                                     style="padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>${seller.display_name}</strong>
                                        ${seller.business_number ? `<br><small>ì‚¬ì—…ìë²ˆí˜¸: ${seller.business_number}</small>` : ''}
                                    </div>
                                    <div style="text-align: right; font-size: 12px; color: #6c757d;">
                                        í‹°ì¼“: ${seller.active_tokens}ê°œ<br>
                                        ${seller.has_subscription ? '<span style="color: #6F42C1;">êµ¬ë…ê¶Œ âœ“</span>' : ''}
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div>';
                    } else {
                        html = '<div style="padding: 10px; color: #6c757d;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                    }
                    searchResults.innerHTML = html;
                    
                    // íŒë§¤ì ì„ íƒ ì´ë²¤íŠ¸
                    document.querySelectorAll('.seller-option').forEach(option => {
                        option.addEventListener('click', function() {
                            const sellerId = this.dataset.sellerId;
                            selectedSeller = data.sellers.find(s => s.id == sellerId);
                            selectSeller(selectedSeller);
                        });
                        
                        option.addEventListener('mouseenter', function() {
                            this.style.backgroundColor = '#f8f9fa';
                        });
                        
                        option.addEventListener('mouseleave', function() {
                            this.style.backgroundColor = '';
                        });
                    });
                })
                .catch(error => {
                    console.error('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜:', error);
                    searchResults.innerHTML = '<div style="padding: 10px; color: #dc3545;">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
                });
        }, 300);
    });
    
    function selectSeller(seller) {
        selectedSeller = seller;
        searchResults.innerHTML = '';
        searchInput.value = seller.display_name;
        
        sellerDetails.innerHTML = `
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                <div><strong>ì´ë¦„:</strong> ${seller.nickname || seller.username}</div>
                <div><strong>ì´ë©”ì¼:</strong> ${seller.email}</div>
                <div><strong>ì‚¬ì—…ìë²ˆí˜¸:</strong> ${seller.business_number || 'ì—†ìŒ'}</div>
                <div><strong>í™œì„± í‹°ì¼“:</strong> <span style="color: #28A745; font-weight: bold;">${seller.active_tokens}ê°œ</span></div>
                <div><strong>ì‚¬ìš©ëœ í‹°ì¼“:</strong> <span style="color: #6c757d;">${seller.used_tokens}ê°œ</span></div>
                <div><strong>êµ¬ë…ê¶Œ:</strong> ${seller.has_subscription ? '<span style="color: #6F42C1; font-weight: bold;">í™œì„± âœ“</span>' : '<span style="color: #6c757d;">ì—†ìŒ</span>'}</div>
            </div>
        `;
        
        selectedSellerInfo.style.display = 'block';
        adjustmentForm.style.display = 'block';
    }
    
    // ê°œë³„ ì¡°ì • ì ìš©
    document.getElementById('apply-adjustment').addEventListener('click', function() {
        if (!selectedSeller) {
            alert('íŒë§¤ìë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }
        
        const adjustmentType = document.getElementById('adjustment-type').value;
        const quantity = parseInt(document.getElementById('adjustment-quantity').value);
        const reason = document.getElementById('adjustment-reason').value.trim();
        
        if (!quantity || quantity <= 0) {
            alert('ì˜¬ë°”ë¥¸ ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        
        if (!reason) {
            alert('ì¡°ì • ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        
        if (!confirm(`${selectedSeller.display_name}ë‹˜ì—ê²Œ ${adjustmentType === 'grant_subscription' ? quantity + 'ì¼ êµ¬ë…ê¶Œì„' : quantity + 'ê°œ í‹°ì¼“ì„'} ${adjustmentType === 'add' ? 'ì¶”ê°€' : adjustmentType === 'subtract' ? 'ì°¨ê°' : 'ë¶€ì—¬'}í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            return;
        }
        
        this.disabled = true;
        this.textContent = 'ì²˜ë¦¬ì¤‘...';
        
        fetch('/admin/bid-token-management/adjust/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                seller_id: selectedSeller.id,
                adjustment_type: adjustmentType,
                quantity: quantity,
                reason: reason
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                // ì„ íƒëœ íŒë§¤ì ì •ë³´ ì—…ë°ì´íŠ¸
                selectedSeller.active_tokens = data.current_tokens;
                selectedSeller.has_subscription = data.has_subscription;
                selectSeller(selectedSeller);
                // í¼ ì´ˆê¸°í™”
                document.getElementById('adjustment-quantity').value = '1';
                document.getElementById('adjustment-reason').value = '';
                // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                location.reload();
            } else {
                alert('ì˜¤ë¥˜: ' + data.error);
            }
        })
        .catch(error => {
            console.error('ì¡°ì • ì¤‘ ì˜¤ë¥˜:', error);
            alert('ì¡°ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        })
        .finally(() => {
            this.disabled = false;
            this.textContent = 'ì¡°ì • ì ìš©';
        });
    });
    
    // ëŒ€ëŸ‰ ì¡°ì • ì ìš©
    document.getElementById('apply-bulk-adjustment').addEventListener('click', function() {
        const filterType = document.getElementById('bulk-filter-type').value;
        const adjustmentType = document.getElementById('bulk-adjustment-type').value;
        const quantity = parseInt(document.getElementById('bulk-quantity').value);
        const reason = document.getElementById('bulk-reason').value.trim();
        
        if (!quantity || quantity <= 0) {
            alert('ì˜¬ë°”ë¥¸ ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        
        if (!reason) {
            alert('ì¡°ì • ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        
        const filterNames = {
            'all': 'ëª¨ë“  íŒë§¤íšŒì›',
            'no_tokens': 'í‹°ì¼“ì´ ì—†ëŠ” íŒë§¤íšŒì›',
            'low_tokens': 'í‹°ì¼“ 5ê°œ ì´í•˜ íŒë§¤íšŒì›',
            'business_verified': 'ì‚¬ì—…ì ì¸ì¦ íŒë§¤íšŒì›'
        };
        
        if (!confirm(`${filterNames[filterType]}ì—ê²Œ ëŒ€ëŸ‰ìœ¼ë¡œ ${adjustmentType === 'grant_subscription' ? quantity + 'ì¼ êµ¬ë…ê¶Œì„' : quantity + 'ê°œ í‹°ì¼“ì„'} ${adjustmentType === 'add' ? 'ì¶”ê°€' : 'ë¶€ì—¬'}í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
            return;
        }
        
        this.disabled = true;
        this.textContent = 'ì²˜ë¦¬ì¤‘...';
        
        fetch('/admin/bid-token-management/bulk-adjust/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                filter_type: filterType,
                adjustment_type: adjustmentType,
                quantity: quantity,
                reason: reason
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                // í¼ ì´ˆê¸°í™”
                document.getElementById('bulk-quantity').value = '5';
                document.getElementById('bulk-reason').value = '';
                // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                location.reload();
            } else {
                alert('ì˜¤ë¥˜: ' + data.error);
            }
        })
        .catch(error => {
            console.error('ëŒ€ëŸ‰ ì¡°ì • ì¤‘ ì˜¤ë¥˜:', error);
            alert('ëŒ€ëŸ‰ ì¡°ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        })
        .finally(() => {
            this.disabled = false;
            this.textContent = 'ëŒ€ëŸ‰ ì¡°ì • ì‹¤í–‰';
        });
    });
    
    // CSRF í† í° ê°€ì ¸ì˜¤ê¸°
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}